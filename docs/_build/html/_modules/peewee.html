

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>peewee &mdash; D-Genies 1.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="D-Genies 1.1 documentation" href="../index.html"/>
        <link rel="up" title="Module code" href="index.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> D-Genies
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <!-- Local TOC -->
                <div class="local-toc"></div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">D-Genies</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Module code</a> &raquo;</li>
      
    <li>peewee</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for peewee</h1><div class="highlight"><pre>
<span></span><span class="c1"># May you do good and not evil</span>
<span class="c1"># May you find forgiveness for yourself and forgive others</span>
<span class="c1"># May you share freely, never taking more than you give.  -- SQLite source code</span>
<span class="c1">#</span>
<span class="c1"># As we enjoy great advantages from the inventions of others, we should be glad</span>
<span class="c1"># of an opportunity to serve others by an invention of ours, and this we should</span>
<span class="c1"># do freely and generously.  -- Ben Franklin</span>
<span class="c1">#</span>
<span class="c1">#     (\</span>
<span class="c1">#     (  \  /(o)\     caw!</span>
<span class="c1">#     (   \/  ()/ /)</span>
<span class="c1">#      (   `;.))&#39;&quot;.)</span>
<span class="c1">#       `(/////.-&#39;</span>
<span class="c1">#    =====))=))===()</span>
<span class="c1">#      ///&#39;</span>
<span class="c1">#     //</span>
<span class="c1">#    &#39;</span>

<span class="kn">import</span> <span class="nn">calendar</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">decimal</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">weakref</span>
<span class="kn">from</span> <span class="nn">bisect</span> <span class="k">import</span> <span class="n">bisect_left</span>
<span class="kn">from</span> <span class="nn">bisect</span> <span class="k">import</span> <span class="n">bisect_right</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">deque</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">namedtuple</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">OrderedDict</span> <span class="o">=</span> <span class="nb">dict</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="k">import</span> <span class="n">isclass</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="s1">&#39;2.10.2&#39;</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;BareField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;BigIntegerField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;BlobField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;BooleanField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CharField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Check&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Clause&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CompositeKey&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DatabaseError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DataError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DateField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DateTimeField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DecimalField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DeferredRelation&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DoesNotExist&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DoubleField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DQ&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Field&#39;</span><span class="p">,</span>
    <span class="s1">&#39;FixedCharField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;FloatField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;fn&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ForeignKeyField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ImproperlyConfigured&#39;</span><span class="p">,</span>
    <span class="s1">&#39;IntegerField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;IntegrityError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;InterfaceError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;InternalError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;JOIN&#39;</span><span class="p">,</span>
    <span class="s1">&#39;JOIN_FULL&#39;</span><span class="p">,</span>
    <span class="s1">&#39;JOIN_INNER&#39;</span><span class="p">,</span>
    <span class="s1">&#39;JOIN_LEFT_OUTER&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">,</span>
    <span class="s1">&#39;MySQLDatabase&#39;</span><span class="p">,</span>
    <span class="s1">&#39;NotSupportedError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;OperationalError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Param&#39;</span><span class="p">,</span>
    <span class="s1">&#39;PostgresqlDatabase&#39;</span><span class="p">,</span>
    <span class="s1">&#39;prefetch&#39;</span><span class="p">,</span>
    <span class="s1">&#39;PrimaryKeyField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ProgrammingError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Proxy&#39;</span><span class="p">,</span>
    <span class="s1">&#39;R&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SmallIntegerField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SqliteDatabase&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SQL&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TextField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TimeField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TimestampField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Tuple&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Using&#39;</span><span class="p">,</span>
    <span class="s1">&#39;UUIDField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Window&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Set default logging handler to avoid &quot;No handlers could be found for logger</span>
<span class="c1"># &quot;peewee&quot;&quot; warnings.</span>
<span class="k">try</span><span class="p">:</span>  <span class="c1"># Python 2.7+</span>
    <span class="kn">from</span> <span class="nn">logging</span> <span class="k">import</span> <span class="n">NullHandler</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">NullHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
            <span class="k">pass</span>

<span class="c1"># All peewee-generated logs are logged to this namespace.</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;peewee&#39;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">NullHandler</span><span class="p">())</span>

<span class="c1"># Python 2/3 compatibility helpers. These helpers are used internally and are</span>
<span class="c1"># not exported.</span>
<span class="n">_METACLASS_</span> <span class="o">=</span> <span class="s1">&#39;_metaclass_helper_&#39;</span>
<span class="k">def</span> <span class="nf">with_metaclass</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">meta</span><span class="p">(</span><span class="n">_METACLASS_</span><span class="p">,</span> <span class="p">(</span><span class="n">base</span><span class="p">,),</span> <span class="p">{})</span>

<span class="n">PY2</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
<span class="n">PY3</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>
<span class="n">PY26</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">builtins</span>
    <span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">Callable</span>
    <span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">reduce</span>
    <span class="n">callable</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">Callable</span><span class="p">)</span>
    <span class="n">unicode_type</span> <span class="o">=</span> <span class="nb">str</span>
    <span class="n">string_type</span> <span class="o">=</span> <span class="nb">bytes</span>
    <span class="n">basestring</span> <span class="o">=</span> <span class="nb">str</span>
    <span class="n">print_</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">builtins</span><span class="p">,</span> <span class="s1">&#39;print&#39;</span><span class="p">)</span>
    <span class="n">binary_construct</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;raw_unicode_escape&#39;</span><span class="p">))</span>
    <span class="n">long</span> <span class="o">=</span> <span class="nb">int</span>
    <span class="k">def</span> <span class="nf">reraise</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">__traceback__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">tb</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">value</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">value</span>
<span class="k">elif</span> <span class="n">PY2</span><span class="p">:</span>
    <span class="n">unicode_type</span> <span class="o">=</span> <span class="n">unicode</span>
    <span class="n">string_type</span> <span class="o">=</span> <span class="n">basestring</span>
    <span class="n">binary_construct</span> <span class="o">=</span> <span class="n">buffer</span>
    <span class="k">def</span> <span class="nf">print_</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;def reraise(tp, value, tb=None): raise tp, value, tb&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unsupported python version.&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">PY26</span><span class="p">:</span>
    <span class="n">_D</span><span class="p">,</span> <span class="n">_M</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">*</span> <span class="mf">3600.</span><span class="p">,</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
    <span class="n">total_seconds</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">microseconds</span><span class="o">+</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">seconds</span><span class="o">+</span><span class="n">t</span><span class="o">.</span><span class="n">days</span><span class="o">*</span><span class="n">_D</span><span class="p">)</span><span class="o">*</span><span class="n">_M</span><span class="p">)</span><span class="o">/</span><span class="n">_M</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">total_seconds</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>

<span class="c1"># By default, peewee supports Sqlite, MySQL and Postgresql.</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pysqlite2</span> <span class="k">import</span> <span class="n">dbapi2</span> <span class="k">as</span> <span class="n">pysq3</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">pysq3</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">sqlite3</span> <span class="o">=</span> <span class="n">pysq3</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">pysq3</span> <span class="ow">and</span> <span class="n">pysq3</span><span class="o">.</span><span class="n">sqlite_version_info</span> <span class="o">&gt;=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">sqlite_version_info</span><span class="p">:</span>
        <span class="n">sqlite3</span> <span class="o">=</span> <span class="n">pysq3</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">psycopg2cffi</span> <span class="k">import</span> <span class="n">compat</span>
    <span class="n">compat</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">psycopg2</span>
    <span class="kn">from</span> <span class="nn">psycopg2</span> <span class="k">import</span> <span class="n">extensions</span> <span class="k">as</span> <span class="n">pg_extensions</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">psycopg2</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">MySQLdb</span> <span class="k">as</span> <span class="nn">mysql</span>  <span class="c1"># prefer the C module.</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">pymysql</span> <span class="k">as</span> <span class="nn">mysql</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">mysql</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">playhouse._speedups</span> <span class="k">import</span> <span class="n">format_date_time</span>
    <span class="kn">from</span> <span class="nn">playhouse._speedups</span> <span class="k">import</span> <span class="n">sort_models_topologically</span>
    <span class="kn">from</span> <span class="nn">playhouse._speedups</span> <span class="k">import</span> <span class="n">strip_parens</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">format_date_time</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">formats</span><span class="p">,</span> <span class="n">post_process</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">post_process</span> <span class="o">=</span> <span class="n">post_process</span> <span class="ow">or</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fmt</span> <span class="ow">in</span> <span class="n">formats</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">post_process</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">fmt</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">sort_models_topologically</span><span class="p">(</span><span class="n">models</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sort models topologically so that parents will precede children.&quot;&quot;&quot;</span>
        <span class="n">models</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">def</span> <span class="nf">dfs</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
            <span class="c1"># Omit models which are already sorted</span>
            <span class="c1"># or should not be in the list at all</span>
            <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span> <span class="ow">and</span> <span class="n">model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

                <span class="c1"># First create models on which current model depends</span>
                <span class="c1"># (either through foreign keys or through depends_on),</span>
                <span class="c1"># then create current model itself</span>
                <span class="k">for</span> <span class="n">foreign_key</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">dfs</span><span class="p">(</span><span class="n">foreign_key</span><span class="o">.</span><span class="n">rel_model</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">depends_on</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">dependency</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">depends_on</span><span class="p">:</span>
                        <span class="n">dfs</span><span class="p">(</span><span class="n">dependency</span><span class="p">)</span>
                <span class="n">ordering</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="c1"># Order models by name and table initially to guarantee total ordering.</span>
        <span class="n">names</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">names</span><span class="p">):</span>
            <span class="n">dfs</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ordering</span>

    <span class="k">def</span> <span class="nf">strip_parens</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="c1"># Quick sanity check.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span> <span class="ow">or</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;(&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span>

        <span class="n">ct</span> <span class="o">=</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">l</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;(&#39;</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;)&#39;</span><span class="p">:</span>
                <span class="n">ct</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">l</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">ct</span><span class="p">:</span>
            <span class="c1"># If we ever end up with negatively-balanced parentheses, then we</span>
            <span class="c1"># know that one of the outer parentheses was required.</span>
            <span class="n">unbalanced_ct</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">required</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">l</span> <span class="o">-</span> <span class="n">ct</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;(&#39;</span><span class="p">:</span>
                    <span class="n">unbalanced_ct</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;)&#39;</span><span class="p">:</span>
                    <span class="n">unbalanced_ct</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">unbalanced_ct</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">required</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">unbalanced_ct</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">required</span> <span class="o">==</span> <span class="n">ct</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="n">ct</span> <span class="o">-=</span> <span class="n">required</span>
        <span class="k">if</span> <span class="n">ct</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="n">ct</span><span class="p">:</span><span class="o">-</span><span class="n">ct</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">s</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">playhouse._speedups</span> <span class="k">import</span> <span class="n">_DictQueryResultWrapper</span>
    <span class="kn">from</span> <span class="nn">playhouse._speedups</span> <span class="k">import</span> <span class="n">_ModelQueryResultWrapper</span>
    <span class="kn">from</span> <span class="nn">playhouse._speedups</span> <span class="k">import</span> <span class="n">_SortedFieldList</span>
    <span class="kn">from</span> <span class="nn">playhouse._speedups</span> <span class="k">import</span> <span class="n">_TuplesQueryResultWrapper</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">_DictQueryResultWrapper</span> <span class="o">=</span> <span class="n">_ModelQueryResultWrapper</span> <span class="o">=</span> <span class="n">_SortedFieldList</span> <span class="o">=</span>\
            <span class="n">_TuplesQueryResultWrapper</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">if</span> <span class="n">sqlite3</span><span class="p">:</span>
    <span class="n">sqlite3</span><span class="o">.</span><span class="n">register_adapter</span><span class="p">(</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="n">sqlite3</span><span class="o">.</span><span class="n">register_adapter</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="n">sqlite3</span><span class="o">.</span><span class="n">register_adapter</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

<span class="n">DATETIME_PARTS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">,</span> <span class="s1">&#39;minute&#39;</span><span class="p">,</span> <span class="s1">&#39;second&#39;</span><span class="p">]</span>
<span class="n">DATETIME_LOOKUPS</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">DATETIME_PARTS</span><span class="p">)</span>

<span class="c1"># Sqlite does not support the `date_part` SQL function, so we will define an</span>
<span class="c1"># implementation in python.</span>
<span class="n">SQLITE_DATETIME_FORMATS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span>
    <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">,</span>
    <span class="s1">&#39;%H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="s1">&#39;%H:%M&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_sqlite_date_part</span><span class="p">(</span><span class="n">lookup_type</span><span class="p">,</span> <span class="n">datetime_string</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">lookup_type</span> <span class="ow">in</span> <span class="n">DATETIME_LOOKUPS</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">datetime_string</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">format_date_time</span><span class="p">(</span><span class="n">datetime_string</span><span class="p">,</span> <span class="n">SQLITE_DATETIME_FORMATS</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">lookup_type</span><span class="p">)</span>

<span class="n">SQLITE_DATE_TRUNC_MAPPING</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="s1">&#39;%Y&#39;</span><span class="p">,</span>
    <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="s1">&#39;%Y-%m&#39;</span><span class="p">,</span>
    <span class="s1">&#39;day&#39;</span><span class="p">:</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="s1">&#39;hour&#39;</span><span class="p">:</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H&#39;</span><span class="p">,</span>
    <span class="s1">&#39;minute&#39;</span><span class="p">:</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">,</span>
    <span class="s1">&#39;second&#39;</span><span class="p">:</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">}</span>
<span class="n">MYSQL_DATE_TRUNC_MAPPING</span> <span class="o">=</span> <span class="n">SQLITE_DATE_TRUNC_MAPPING</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">MYSQL_DATE_TRUNC_MAPPING</span><span class="p">[</span><span class="s1">&#39;minute&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:</span><span class="si">%i</span><span class="s1">&#39;</span>
<span class="n">MYSQL_DATE_TRUNC_MAPPING</span><span class="p">[</span><span class="s1">&#39;second&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:</span><span class="si">%i</span><span class="s1">:%S&#39;</span>

<span class="k">def</span> <span class="nf">_sqlite_date_trunc</span><span class="p">(</span><span class="n">lookup_type</span><span class="p">,</span> <span class="n">datetime_string</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">lookup_type</span> <span class="ow">in</span> <span class="n">SQLITE_DATE_TRUNC_MAPPING</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">datetime_string</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">format_date_time</span><span class="p">(</span><span class="n">datetime_string</span><span class="p">,</span> <span class="n">SQLITE_DATETIME_FORMATS</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">SQLITE_DATE_TRUNC_MAPPING</span><span class="p">[</span><span class="n">lookup_type</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">_sqlite_regexp</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">case_sensitive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">case_sensitive</span> <span class="k">else</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<span class="k">class</span> <span class="nc">attrdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

<span class="n">SENTINEL</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>

<span class="c1"># Operators used in binary expressions.</span>
<span class="n">OP</span> <span class="o">=</span> <span class="n">attrdict</span><span class="p">(</span>
    <span class="n">AND</span><span class="o">=</span><span class="s1">&#39;and&#39;</span><span class="p">,</span>
    <span class="n">OR</span><span class="o">=</span><span class="s1">&#39;or&#39;</span><span class="p">,</span>
    <span class="n">ADD</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
    <span class="n">SUB</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span>
    <span class="n">MUL</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
    <span class="n">DIV</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">,</span>
    <span class="n">BIN_AND</span><span class="o">=</span><span class="s1">&#39;&amp;&#39;</span><span class="p">,</span>
    <span class="n">BIN_OR</span><span class="o">=</span><span class="s1">&#39;|&#39;</span><span class="p">,</span>
    <span class="n">XOR</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">,</span>
    <span class="n">MOD</span><span class="o">=</span><span class="s1">&#39;%&#39;</span><span class="p">,</span>
    <span class="n">EQ</span><span class="o">=</span><span class="s1">&#39;=&#39;</span><span class="p">,</span>
    <span class="n">LT</span><span class="o">=</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span>
    <span class="n">LTE</span><span class="o">=</span><span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span>
    <span class="n">GT</span><span class="o">=</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span>
    <span class="n">GTE</span><span class="o">=</span><span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span>
    <span class="n">NE</span><span class="o">=</span><span class="s1">&#39;!=&#39;</span><span class="p">,</span>
    <span class="n">IN</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span>
    <span class="n">NOT_IN</span><span class="o">=</span><span class="s1">&#39;not in&#39;</span><span class="p">,</span>
    <span class="n">IS</span><span class="o">=</span><span class="s1">&#39;is&#39;</span><span class="p">,</span>
    <span class="n">IS_NOT</span><span class="o">=</span><span class="s1">&#39;is not&#39;</span><span class="p">,</span>
    <span class="n">LIKE</span><span class="o">=</span><span class="s1">&#39;like&#39;</span><span class="p">,</span>
    <span class="n">ILIKE</span><span class="o">=</span><span class="s1">&#39;ilike&#39;</span><span class="p">,</span>
    <span class="n">BETWEEN</span><span class="o">=</span><span class="s1">&#39;between&#39;</span><span class="p">,</span>
    <span class="n">REGEXP</span><span class="o">=</span><span class="s1">&#39;regexp&#39;</span><span class="p">,</span>
    <span class="n">CONCAT</span><span class="o">=</span><span class="s1">&#39;||&#39;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">JOIN</span> <span class="o">=</span> <span class="n">attrdict</span><span class="p">(</span>
    <span class="n">INNER</span><span class="o">=</span><span class="s1">&#39;INNER&#39;</span><span class="p">,</span>
    <span class="n">LEFT_OUTER</span><span class="o">=</span><span class="s1">&#39;LEFT OUTER&#39;</span><span class="p">,</span>
    <span class="n">RIGHT_OUTER</span><span class="o">=</span><span class="s1">&#39;RIGHT OUTER&#39;</span><span class="p">,</span>
    <span class="n">FULL</span><span class="o">=</span><span class="s1">&#39;FULL&#39;</span><span class="p">,</span>
    <span class="n">CROSS</span><span class="o">=</span><span class="s1">&#39;CROSS&#39;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">JOIN_INNER</span> <span class="o">=</span> <span class="n">JOIN</span><span class="o">.</span><span class="n">INNER</span>
<span class="n">JOIN_LEFT_OUTER</span> <span class="o">=</span> <span class="n">JOIN</span><span class="o">.</span><span class="n">LEFT_OUTER</span>
<span class="n">JOIN_FULL</span> <span class="o">=</span> <span class="n">JOIN</span><span class="o">.</span><span class="n">FULL</span>

<span class="n">RESULTS_NAIVE</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">RESULTS_MODELS</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">RESULTS_TUPLES</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">RESULTS_DICTS</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">RESULTS_AGGREGATE_MODELS</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">RESULTS_NAMEDTUPLES</span> <span class="o">=</span> <span class="mi">6</span>

<span class="c1"># To support &quot;django-style&quot; double-underscore filters, create a mapping between</span>
<span class="c1"># operation name and operation code, e.g. &quot;__eq&quot; == OP.EQ.</span>
<span class="n">DJANGO_MAP</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;eq&#39;</span><span class="p">:</span> <span class="n">OP</span><span class="o">.</span><span class="n">EQ</span><span class="p">,</span>
    <span class="s1">&#39;lt&#39;</span><span class="p">:</span> <span class="n">OP</span><span class="o">.</span><span class="n">LT</span><span class="p">,</span>
    <span class="s1">&#39;lte&#39;</span><span class="p">:</span> <span class="n">OP</span><span class="o">.</span><span class="n">LTE</span><span class="p">,</span>
    <span class="s1">&#39;gt&#39;</span><span class="p">:</span> <span class="n">OP</span><span class="o">.</span><span class="n">GT</span><span class="p">,</span>
    <span class="s1">&#39;gte&#39;</span><span class="p">:</span> <span class="n">OP</span><span class="o">.</span><span class="n">GTE</span><span class="p">,</span>
    <span class="s1">&#39;ne&#39;</span><span class="p">:</span> <span class="n">OP</span><span class="o">.</span><span class="n">NE</span><span class="p">,</span>
    <span class="s1">&#39;in&#39;</span><span class="p">:</span> <span class="n">OP</span><span class="o">.</span><span class="n">IN</span><span class="p">,</span>
    <span class="s1">&#39;is&#39;</span><span class="p">:</span> <span class="n">OP</span><span class="o">.</span><span class="n">IS</span><span class="p">,</span>
    <span class="s1">&#39;like&#39;</span><span class="p">:</span> <span class="n">OP</span><span class="o">.</span><span class="n">LIKE</span><span class="p">,</span>
    <span class="s1">&#39;ilike&#39;</span><span class="p">:</span> <span class="n">OP</span><span class="o">.</span><span class="n">ILIKE</span><span class="p">,</span>
    <span class="s1">&#39;regexp&#39;</span><span class="p">:</span> <span class="n">OP</span><span class="o">.</span><span class="n">REGEXP</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Helper functions that are used in various parts of the codebase.</span>
<span class="k">def</span> <span class="nf">merge_dict</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">overrides</span><span class="p">):</span>
    <span class="n">merged</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">merged</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">overrides</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">merged</span>

<span class="k">def</span> <span class="nf">returns_clone</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method decorator that will &quot;clone&quot; the object before applying the given</span>
<span class="sd">    method.  This ensures that state is mutated in a more predictable fashion,</span>
<span class="sd">    and promotes the use of method-chaining.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">clone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>  <span class="c1"># Assumes object implements `clone`.</span>
        <span class="n">func</span><span class="p">(</span><span class="n">clone</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">clone</span>
    <span class="n">inner</span><span class="o">.</span><span class="n">call_local</span> <span class="o">=</span> <span class="n">func</span>  <span class="c1"># Provide a way to call without cloning.</span>
    <span class="k">return</span> <span class="n">inner</span>

<span class="k">def</span> <span class="nf">not_allowed</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method decorator to indicate a method is not allowed to be called.  Will</span>
<span class="sd">    raise a `NotImplementedError`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not allowed on </span><span class="si">%s</span><span class="s1"> instances&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">func</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">inner</span>

<span class="k">class</span> <span class="nc">Proxy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Proxy class useful for situations when you wish to defer the initialization</span>
<span class="sd">    of an object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;obj&#39;</span><span class="p">,</span> <span class="s1">&#39;_callbacks&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">:</span>
            <span class="n">callback</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">attach_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">callback</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Cannot use uninitialized Proxy.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__slots__</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Cannot set attribute on proxy.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Proxy</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">DeferredRelation</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">_unresolved</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel_model_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">rel_model_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rel_model_name</span> <span class="o">=</span> <span class="n">rel_model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unresolved</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">model_class</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">set_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel_model</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="n">field</span><span class="o">.</span><span class="n">rel_model</span> <span class="o">=</span> <span class="n">rel_model</span>
            <span class="n">field</span><span class="o">.</span><span class="n">add_to_class</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="n">model_cls</span><span class="p">):</span>
        <span class="n">unresolved</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">DeferredRelation</span><span class="o">.</span><span class="n">_unresolved</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dr</span> <span class="ow">in</span> <span class="n">unresolved</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dr</span><span class="o">.</span><span class="n">_rel_model_name</span> <span class="o">==</span> <span class="n">model_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">dr</span><span class="o">.</span><span class="n">set_model</span><span class="p">(</span><span class="n">model_cls</span><span class="p">)</span>
                <span class="n">DeferredRelation</span><span class="o">.</span><span class="n">_unresolved</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">dr</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_CDescriptor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">instance_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Entity</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">_alias</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

<span class="c1"># Classes representing the query tree.</span>

<span class="k">class</span> <span class="nc">Node</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base-class for any part of a query which shall be composable.&quot;&quot;&quot;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">_CDescriptor</span><span class="p">()</span>
    <span class="n">_node_type</span> <span class="o">=</span> <span class="s1">&#39;node&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_negated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bind_to</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ordering</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># ASC or DESC.</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">extend</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clone</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
            <span class="n">method_name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">method</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">if</span> <span class="n">clone</span><span class="p">:</span>
                <span class="n">method</span> <span class="o">=</span> <span class="n">returns_clone</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">method_name</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">method</span>
        <span class="k">return</span> <span class="n">decorator</span>

    <span class="k">def</span> <span class="nf">clone_base</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span>

    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">inst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone_base</span><span class="p">()</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">_negated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negated</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">_alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">_ordering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ordering</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">_bind_to</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bind_to</span>
        <span class="k">return</span> <span class="n">inst</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">__invert__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_negated</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negated</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span> <span class="o">=</span> <span class="n">a</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">bind_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Bind the results of an expression to a specific model type. Useful</span>
<span class="sd">        when adding expressions to a select, where the result of the expression</span>
<span class="sd">        should be placed on a joined instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bind_to</span> <span class="o">=</span> <span class="n">bt</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">asc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ordering</span> <span class="o">=</span> <span class="s1">&#39;ASC&#39;</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ordering</span> <span class="o">=</span> <span class="s1">&#39;DESC&#39;</span>

    <span class="k">def</span> <span class="nf">__pos__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">asc</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_e</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">inv</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Lightweight factory which returns a method that builds an Expression</span>
<span class="sd">        consisting of the left-hand and right-hand operands, using `op`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">inv</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inner</span>
    <span class="fm">__and__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">AND</span><span class="p">)</span>
    <span class="fm">__or__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">OR</span><span class="p">)</span>

    <span class="fm">__add__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">ADD</span><span class="p">)</span>
    <span class="fm">__sub__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">SUB</span><span class="p">)</span>
    <span class="fm">__mul__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">MUL</span><span class="p">)</span>
    <span class="n">__div__</span> <span class="o">=</span> <span class="fm">__truediv__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">DIV</span><span class="p">)</span>
    <span class="fm">__xor__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">XOR</span><span class="p">)</span>
    <span class="fm">__radd__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">ADD</span><span class="p">,</span> <span class="n">inv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="fm">__rsub__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">SUB</span><span class="p">,</span> <span class="n">inv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="fm">__rmul__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">MUL</span><span class="p">,</span> <span class="n">inv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">__rdiv__</span> <span class="o">=</span> <span class="fm">__rtruediv__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">DIV</span><span class="p">,</span> <span class="n">inv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="fm">__rand__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">AND</span><span class="p">,</span> <span class="n">inv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="fm">__ror__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">OR</span><span class="p">,</span> <span class="n">inv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="fm">__rxor__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">XOR</span><span class="p">,</span> <span class="n">inv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rhs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">IS</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">EQ</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rhs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">IS_NOT</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">NE</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>

    <span class="fm">__lt__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">LT</span><span class="p">)</span>
    <span class="fm">__le__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">LTE</span><span class="p">)</span>
    <span class="fm">__gt__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">GT</span><span class="p">)</span>
    <span class="fm">__ge__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">GTE</span><span class="p">)</span>
    <span class="fm">__lshift__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">IN</span><span class="p">)</span>
    <span class="fm">__rshift__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">IS</span><span class="p">)</span>
    <span class="fm">__mod__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">LIKE</span><span class="p">)</span>
    <span class="fm">__pow__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">ILIKE</span><span class="p">)</span>

    <span class="n">bin_and</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">BIN_AND</span><span class="p">)</span>
    <span class="n">bin_or</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">BIN_OR</span><span class="p">)</span>

    <span class="c1"># Special expressions.</span>
    <span class="k">def</span> <span class="nf">in_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">IN</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">not_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">NOT_IN</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">is_null</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_null</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">is_null</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">IS</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">IS_NOT</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">ILIKE</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%%%s%%</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">rhs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">startswith</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">ILIKE</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s%%</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">rhs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">endswith</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">ILIKE</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%%%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">rhs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">between</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">BETWEEN</span><span class="p">,</span> <span class="n">Clause</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">R</span><span class="p">(</span><span class="s1">&#39;AND&#39;</span><span class="p">),</span> <span class="n">high</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">regexp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">REGEXP</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">concat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">StringExpression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">CONCAT</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SQL</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An unescaped SQL string, with optional parameters.&quot;&quot;&quot;</span>
    <span class="n">_node_type</span> <span class="o">=</span> <span class="s1">&#39;sql&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SQL</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">clone_base</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">SQL</span>  <span class="c1"># backwards-compat.</span>

<span class="k">class</span> <span class="nc">Entity</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A quoted-name or entity, e.g. &quot;table&quot;.&quot;column&quot;.&quot;&quot;&quot;</span>
    <span class="n">_node_type</span> <span class="o">=</span> <span class="s1">&#39;entity&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">path</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Entity</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">clone_base</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Entity</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Entity</span><span class="p">(</span><span class="o">*</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="p">(</span><span class="n">attr</span><span class="p">,)))</span>

<span class="k">class</span> <span class="nc">Func</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An arbitrary SQL function call.&quot;&quot;&quot;</span>
    <span class="n">_node_type</span> <span class="o">=</span> <span class="s1">&#39;func&#39;</span>
    <span class="n">_no_coerce</span> <span class="o">=</span> <span class="nb">set</span><span class="p">((</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">arguments</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span> <span class="o">=</span> <span class="n">arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coerce</span> <span class="o">=</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_no_coerce</span><span class="p">)</span> <span class="k">if</span> <span class="n">name</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Func</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">coerce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coerce</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coerce</span> <span class="o">=</span> <span class="n">coerce</span>

    <span class="k">def</span> <span class="nf">clone_base</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">Func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">_coerce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coerce</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">over</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partition_by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">partition_by</span><span class="p">,</span> <span class="n">Window</span><span class="p">)</span> <span class="ow">and</span> <span class="n">window</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">window</span> <span class="o">=</span> <span class="n">partition_by</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">SQL</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="o">*</span><span class="n">start</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">SQL</span><span class="p">):</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="o">*</span><span class="n">end</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">window</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">partition_by</span><span class="o">=</span><span class="n">partition_by</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="n">order_by</span><span class="p">,</span>
                         <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span><span class="o">.</span><span class="n">__sql__</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="n">window</span><span class="o">.</span><span class="n">_alias</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;OVER&#39;</span><span class="p">),</span> <span class="n">sql</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">dec</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Func</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dec</span>

<span class="c1"># fn is a factory for creating `Func` objects and supports a more friendly</span>
<span class="c1"># API.  So instead of `Func(&quot;LOWER&quot;, param)`, `fn.LOWER(param)`.</span>
<span class="n">fn</span> <span class="o">=</span> <span class="n">Func</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Expression</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A binary expression, e.g `foo + 1` or `bar &lt; 7`.&quot;&quot;&quot;</span>
    <span class="n">_node_type</span> <span class="o">=</span> <span class="s1">&#39;expression&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Expression</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span> <span class="o">=</span> <span class="n">lhs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">op</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span> <span class="o">=</span> <span class="n">rhs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flat</span> <span class="o">=</span> <span class="n">flat</span>

    <span class="k">def</span> <span class="nf">clone_base</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flat</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">StringExpression</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">other</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Param</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Arbitrary parameter passed into a query. Instructs the query compiler to</span>
<span class="sd">    specifically treat this value as a parameter, useful for `list` which is</span>
<span class="sd">    special-cased for `IN` lookups.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_node_type</span> <span class="o">=</span> <span class="s1">&#39;param&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">adapt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span> <span class="o">=</span> <span class="n">adapt</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Param</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">clone_base</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Param</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Passthrough</span><span class="p">(</span><span class="n">Param</span><span class="p">):</span>
    <span class="n">_node_type</span> <span class="o">=</span> <span class="s1">&#39;passthrough&#39;</span>

<span class="k">class</span> <span class="nc">Clause</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A SQL clause, one or more Node objects joined by spaces.&quot;&quot;&quot;</span>
    <span class="n">_node_type</span> <span class="o">=</span> <span class="s1">&#39;clause&#39;</span>

    <span class="n">glue</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
    <span class="n">parens</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">nodes</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;glue&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">glue</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;glue&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;parens&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parens</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;parens&#39;</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Clause</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clone_base</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">clone</span> <span class="o">=</span> <span class="n">Clause</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
        <span class="n">clone</span><span class="o">.</span><span class="n">glue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">glue</span>
        <span class="n">clone</span><span class="o">.</span><span class="n">parens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parens</span>
        <span class="k">return</span> <span class="n">clone</span>

<span class="k">class</span> <span class="nc">CommaClause</span><span class="p">(</span><span class="n">Clause</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;One or more Node objects joined by commas, no parens.&quot;&quot;&quot;</span>
    <span class="n">glue</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span>

<span class="k">class</span> <span class="nc">EnclosedClause</span><span class="p">(</span><span class="n">CommaClause</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;One or more Node objects joined by commas and enclosed in parens.&quot;&quot;&quot;</span>
    <span class="n">parens</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">Tuple</span> <span class="o">=</span> <span class="n">EnclosedClause</span>

<span class="k">class</span> <span class="nc">Window</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="n">CURRENT_ROW</span> <span class="o">=</span> <span class="s1">&#39;CURRENT ROW&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partition_by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Window</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">partition_by</span> <span class="o">=</span> <span class="n">partition_by</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span> <span class="o">=</span> <span class="n">order_by</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">end</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot specify WINDOW end without start.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span> <span class="ow">or</span> <span class="s1">&#39;w&#39;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">following</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;UNBOUNDED FOLLOWING&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> FOLLOWING&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">preceding</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;UNBOUNDED PRECEDING&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> PRECEDING&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">over_clauses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">partition_by</span><span class="p">:</span>
            <span class="n">over_clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Clause</span><span class="p">(</span>
                <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;PARTITION BY&#39;</span><span class="p">),</span>
                <span class="n">CommaClause</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">partition_by</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span><span class="p">:</span>
            <span class="n">over_clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Clause</span><span class="p">(</span>
                <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;ORDER BY&#39;</span><span class="p">),</span>
                <span class="n">CommaClause</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">order_by</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">over_clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Clause</span><span class="p">(</span>
                <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;RANGE BETWEEN&#39;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;AND&#39;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">over_clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Clause</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;RANGE&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">EnclosedClause</span><span class="p">(</span><span class="n">Clause</span><span class="p">(</span><span class="o">*</span><span class="n">over_clauses</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">clone_base</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Window</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">partition_by</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">Check</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;CHECK (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">DQ</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A &quot;django-style&quot; filter expression, e.g. {&#39;foo__eq&#39;: &#39;x&#39;}.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">query</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DQ</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">query</span>

    <span class="k">def</span> <span class="nf">clone_base</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DQ</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">_StripParens</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="n">_node_type</span> <span class="o">=</span> <span class="s1">&#39;strip_parens&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_StripParens</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="n">node</span>

<span class="n">JoinMetadata</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;JoinMetadata&#39;</span><span class="p">,</span> <span class="p">(</span>
    <span class="s1">&#39;src_model&#39;</span><span class="p">,</span>  <span class="c1"># Source Model class.</span>
    <span class="s1">&#39;dest_model&#39;</span><span class="p">,</span>   <span class="c1"># Dest Model class.</span>
    <span class="s1">&#39;src&#39;</span><span class="p">,</span>   <span class="c1"># Source, may be Model, ModelAlias</span>
    <span class="s1">&#39;dest&#39;</span><span class="p">,</span>  <span class="c1"># Dest, may be Model, ModelAlias, or SelectQuery.</span>
    <span class="s1">&#39;attr&#39;</span><span class="p">,</span>  <span class="c1"># Attribute name joined instance(s) should be assigned to.</span>
    <span class="s1">&#39;primary_key&#39;</span><span class="p">,</span>  <span class="c1"># Primary key being joined on.</span>
    <span class="s1">&#39;foreign_key&#39;</span><span class="p">,</span>  <span class="c1"># Foreign key being joined from.</span>
    <span class="s1">&#39;is_backref&#39;</span><span class="p">,</span>  <span class="c1"># Is this a backref, i.e. 1 -&gt; N.</span>
    <span class="s1">&#39;alias&#39;</span><span class="p">,</span>  <span class="c1"># Explicit alias given to join expression.</span>
    <span class="s1">&#39;is_self_join&#39;</span><span class="p">,</span>  <span class="c1"># Is this a self-join?</span>
    <span class="s1">&#39;is_expression&#39;</span><span class="p">,</span>  <span class="c1"># Is the join ON clause an Expression?</span>
<span class="p">))</span>

<span class="k">class</span> <span class="nc">Join</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;_Join&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">,</span> <span class="s1">&#39;dest&#39;</span><span class="p">,</span> <span class="s1">&#39;join_type&#39;</span><span class="p">,</span> <span class="s1">&#39;on&#39;</span><span class="p">))):</span>
    <span class="k">def</span> <span class="nf">get_foreign_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">SelectQuery</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">SelectQuery</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">fk_field</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">rel_for_model</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fk_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fk_field</span><span class="p">,</span> <span class="kc">False</span>
        <span class="n">reverse_rel</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">reverse_rel_for_model</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reverse_rel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">reverse_rel</span><span class="p">,</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_join_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_type</span> <span class="ow">or</span> <span class="n">JOIN</span><span class="o">.</span><span class="n">INNER</span>

    <span class="k">def</span> <span class="nf">model_from_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_or_alias</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_or_alias</span><span class="p">,</span> <span class="n">ModelAlias</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">model_or_alias</span><span class="o">.</span><span class="n">model_class</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_or_alias</span><span class="p">,</span> <span class="n">SelectQuery</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">model_or_alias</span><span class="o">.</span><span class="n">model_class</span>
        <span class="k">return</span> <span class="n">model_or_alias</span>

    <span class="k">def</span> <span class="nf">_join_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Get the actual tables being joined.</span>
        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_from_alias</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">)</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_from_alias</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span>

        <span class="n">join_alias</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">,</span> <span class="n">Node</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="o">.</span><span class="n">_alias</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="n">is_expression</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">,</span> <span class="p">(</span><span class="n">Expression</span><span class="p">,</span> <span class="n">Func</span><span class="p">,</span> <span class="n">SQL</span><span class="p">))</span>

        <span class="n">on_field</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">,</span> <span class="p">(</span><span class="n">Field</span><span class="p">,</span> <span class="n">FieldProxy</span><span class="p">))</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">on</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">on_field</span><span class="p">:</span>
            <span class="n">fk_field</span> <span class="o">=</span> <span class="n">on_field</span>
            <span class="n">is_backref</span> <span class="o">=</span> <span class="n">on_field</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fk_field</span><span class="p">,</span> <span class="n">is_backref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_foreign_key</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fk_field</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fk_field</span><span class="p">,</span> <span class="n">is_backref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_foreign_key</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fk_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">primary_key</span> <span class="o">=</span> <span class="n">fk_field</span><span class="o">.</span><span class="n">to_field</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">primary_key</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">join_alias</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fk_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_backref</span><span class="p">:</span>
                    <span class="n">target_attr</span> <span class="o">=</span> <span class="n">dest</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">target_attr</span> <span class="o">=</span> <span class="n">fk_field</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">target_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">name</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="n">target_attr</span> <span class="o">=</span> <span class="n">dest</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target_attr</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">JoinMetadata</span><span class="p">(</span>
            <span class="n">src_model</span><span class="o">=</span><span class="n">src</span><span class="p">,</span>
            <span class="n">dest_model</span><span class="o">=</span><span class="n">dest</span><span class="p">,</span>
            <span class="n">src</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span>
            <span class="n">dest</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">,</span>
            <span class="n">attr</span><span class="o">=</span><span class="n">join_alias</span> <span class="ow">or</span> <span class="n">target_attr</span><span class="p">,</span>
            <span class="n">primary_key</span><span class="o">=</span><span class="n">primary_key</span><span class="p">,</span>
            <span class="n">foreign_key</span><span class="o">=</span><span class="n">fk_field</span><span class="p">,</span>
            <span class="n">is_backref</span><span class="o">=</span><span class="n">is_backref</span><span class="p">,</span>
            <span class="n">alias</span><span class="o">=</span><span class="n">join_alias</span><span class="p">,</span>
            <span class="n">is_self_join</span><span class="o">=</span><span class="n">src</span> <span class="ow">is</span> <span class="n">dest</span><span class="p">,</span>
            <span class="n">is_expression</span><span class="o">=</span><span class="n">is_expression</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_cached_metadata&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cached_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_metadata</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_metadata</span>

<span class="k">class</span> <span class="nc">FieldDescriptor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># Fields are exposed as descriptors in order to control access to the</span>
    <span class="c1"># underlying &quot;raw&quot; data.</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">att_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">instance_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">instance</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">att_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span>

    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">att_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">_dirty</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">att_name</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Field</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A column on a table.&quot;&quot;&quot;</span>
    <span class="n">_field_counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">_order</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">_node_type</span> <span class="o">=</span> <span class="s1">&#39;field&#39;</span>
    <span class="n">db_field</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">verbose_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">db_column</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sequence</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">undeclared</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">null</span> <span class="o">=</span> <span class="n">null</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unique</span> <span class="o">=</span> <span class="n">unique</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose_name</span> <span class="o">=</span> <span class="n">verbose_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">help_text</span> <span class="o">=</span> <span class="n">help_text</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_column</span> <span class="o">=</span> <span class="n">db_column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">choices</span> <span class="o">=</span> <span class="n">choices</span>  <span class="c1"># Used for metadata purposes, not enforced.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="o">=</span> <span class="n">primary_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">sequence</span>  <span class="c1"># Name of sequence, e.g. foo_id_seq.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="n">constraints</span>  <span class="c1"># List of column constraints.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span>  <span class="c1"># Name of schema, e.g. &#39;public&#39;.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">undeclared</span> <span class="o">=</span> <span class="n">undeclared</span>  <span class="c1"># Whether this field is part of schema.</span>

        <span class="c1"># Used internally for recovering the order in which Fields were defined</span>
        <span class="c1"># on the Model class.</span>
        <span class="n">Field</span><span class="o">.</span><span class="n">_field_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_order</span> <span class="o">=</span> <span class="n">Field</span><span class="o">.</span><span class="n">_field_counter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sort_key</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">and</span> <span class="mi">1</span> <span class="ow">or</span> <span class="mi">2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_is_bound</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Whether the Field is &quot;bound&quot; to a Model.</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Field</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">clone_base</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">inst</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span>
            <span class="n">null</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">null</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">unique</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">,</span>
            <span class="n">verbose_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose_name</span><span class="p">,</span>
            <span class="n">help_text</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">help_text</span><span class="p">,</span>
            <span class="n">db_column</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_column</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">,</span>
            <span class="n">choices</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">choices</span><span class="p">,</span>
            <span class="n">primary_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">,</span>
            <span class="n">sequence</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">,</span>
            <span class="n">constraints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">,</span>
            <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span>
            <span class="n">undeclared</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">undeclared</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_bound</span><span class="p">:</span>
            <span class="n">inst</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="n">inst</span><span class="o">.</span><span class="n">model_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">_is_bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_bound</span>
        <span class="k">return</span> <span class="n">inst</span>

    <span class="k">def</span> <span class="nf">add_to_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Hook that replaces the `Field` attribute on a class with a named</span>
<span class="sd">        `FieldDescriptor`. Called by the metaclass during construction of the</span>
<span class="sd">        `Model`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span> <span class="o">=</span> <span class="n">model_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_column</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;_+&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>

        <span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">FieldDescriptor</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_bound</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">get_database</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span>

    <span class="k">def</span> <span class="nf">get_column_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">field_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db_field</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span><span class="o">.</span><span class="n">compiler</span><span class="p">()</span><span class="o">.</span><span class="n">get_column_type</span><span class="p">(</span><span class="n">field_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_db_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_field</span>

    <span class="k">def</span> <span class="nf">get_modifiers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">coerce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">db_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert the python value for storage in the database.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">value</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">coerce</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">python_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert the database value to a pythonic value.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">value</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">coerce</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">as_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_table</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">with_table</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Entity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_column</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Entity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_column</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__ddl_column__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the column type, e.g. VARCHAR(255) or REAL.&quot;&quot;&quot;</span>
        <span class="n">modifiers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_modifiers</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">modifiers</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">column_type</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">modifiers</span><span class="p">))))</span>
        <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span><span class="n">column_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__ddl__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of Node instances that defines the column.&quot;&quot;&quot;</span>
        <span class="n">ddl</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">as_entity</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ddl_column__</span><span class="p">(</span><span class="n">column_type</span><span class="p">)]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">null</span><span class="p">:</span>
            <span class="n">ddl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;NOT NULL&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">:</span>
            <span class="n">ddl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;PRIMARY KEY&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">:</span>
            <span class="n">ddl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;DEFAULT NEXTVAL(&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
            <span class="n">ddl</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ddl</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">BareField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="n">db_field</span> <span class="o">=</span> <span class="s1">&#39;bare&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coerce</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BareField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">coerce</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coerce</span> <span class="o">=</span> <span class="n">coerce</span>

    <span class="k">def</span> <span class="nf">clone_base</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">BareField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">clone_base</span><span class="p">(</span><span class="n">coerce</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coerce</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">IntegerField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="n">db_field</span> <span class="o">=</span> <span class="s1">&#39;int&#39;</span>
    <span class="n">coerce</span> <span class="o">=</span> <span class="nb">int</span>

<span class="k">class</span> <span class="nc">BigIntegerField</span><span class="p">(</span><span class="n">IntegerField</span><span class="p">):</span>
    <span class="n">db_field</span> <span class="o">=</span> <span class="s1">&#39;bigint&#39;</span>

<span class="k">class</span> <span class="nc">SmallIntegerField</span><span class="p">(</span><span class="n">IntegerField</span><span class="p">):</span>
    <span class="n">db_field</span> <span class="o">=</span> <span class="s1">&#39;smallint&#39;</span>

<span class="k">class</span> <span class="nc">PrimaryKeyField</span><span class="p">(</span><span class="n">IntegerField</span><span class="p">):</span>
    <span class="n">db_field</span> <span class="o">=</span> <span class="s1">&#39;primary_key&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;primary_key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PrimaryKeyField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">_AutoPrimaryKeyField</span><span class="p">(</span><span class="n">PrimaryKeyField</span><span class="p">):</span>
    <span class="n">_column_name</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;undeclared&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;undeclared&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%r</span><span class="s1"> must be created with undeclared=True.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;undeclared&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_AutoPrimaryKeyField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_to_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> must be named `</span><span class="si">%s</span><span class="s1">`.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">name</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_AutoPrimaryKeyField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">add_to_class</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">FloatField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="n">db_field</span> <span class="o">=</span> <span class="s1">&#39;float&#39;</span>
    <span class="n">coerce</span> <span class="o">=</span> <span class="nb">float</span>

<span class="k">class</span> <span class="nc">DoubleField</span><span class="p">(</span><span class="n">FloatField</span><span class="p">):</span>
    <span class="n">db_field</span> <span class="o">=</span> <span class="s1">&#39;double&#39;</span>

<span class="k">class</span> <span class="nc">DecimalField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="n">db_field</span> <span class="o">=</span> <span class="s1">&#39;decimal&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_digits</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">decimal_places</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">auto_round</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">rounding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_digits</span> <span class="o">=</span> <span class="n">max_digits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decimal_places</span> <span class="o">=</span> <span class="n">decimal_places</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_round</span> <span class="o">=</span> <span class="n">auto_round</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rounding</span> <span class="o">=</span> <span class="n">rounding</span> <span class="ow">or</span> <span class="n">decimal</span><span class="o">.</span><span class="n">DefaultContext</span><span class="o">.</span><span class="n">rounding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exp</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">decimal_places</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DecimalField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clone_base</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">DecimalField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">clone_base</span><span class="p">(</span>
            <span class="n">max_digits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_digits</span><span class="p">,</span>
            <span class="n">decimal_places</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">decimal_places</span><span class="p">,</span>
            <span class="n">auto_round</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">auto_round</span><span class="p">,</span>
            <span class="n">rounding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rounding</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_modifiers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">max_digits</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">decimal_places</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">db_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">D</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_round</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">D</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">D</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">is_normal</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_round</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">quantize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exp</span><span class="p">,</span> <span class="n">rounding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rounding</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">python_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">value</span>
            <span class="k">return</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">coerce_to_unicode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">unicode_type</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">s</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">string_type</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span>
    <span class="k">return</span> <span class="n">unicode_type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">_StringField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">coerce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">coerce_to_unicode</span><span class="p">(</span><span class="n">value</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">other</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">CharField</span><span class="p">(</span><span class="n">_StringField</span><span class="p">):</span>
    <span class="n">db_field</span> <span class="o">=</span> <span class="s1">&#39;string&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="n">max_length</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CharField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clone_base</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">CharField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">clone_base</span><span class="p">(</span>
            <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_modifiers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="ow">and</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>

<span class="k">class</span> <span class="nc">FixedCharField</span><span class="p">(</span><span class="n">CharField</span><span class="p">):</span>
    <span class="n">db_field</span> <span class="o">=</span> <span class="s1">&#39;fixed_char&#39;</span>

    <span class="k">def</span> <span class="nf">python_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">FixedCharField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">python_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">value</span>

<span class="k">class</span> <span class="nc">TextField</span><span class="p">(</span><span class="n">_StringField</span><span class="p">):</span>
    <span class="n">db_field</span> <span class="o">=</span> <span class="s1">&#39;text&#39;</span>

<span class="k">class</span> <span class="nc">BlobField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="n">db_field</span> <span class="o">=</span> <span class="s1">&#39;blob&#39;</span>
    <span class="n">_constructor</span> <span class="o">=</span> <span class="n">binary_construct</span>

    <span class="k">def</span> <span class="nf">add_to_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="n">Proxy</span><span class="p">):</span>
            <span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">attach_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_set_constructor</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">BlobField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">add_to_class</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_constructor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get_binary_type</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">db_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">unicode_type</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;raw_unicode_escape&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constructor</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

<span class="k">class</span> <span class="nc">UUIDField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="n">db_field</span> <span class="o">=</span> <span class="s1">&#39;uuid&#39;</span>

    <span class="k">def</span> <span class="nf">db_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">hex</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">python_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">return</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_date_part</span><span class="p">(</span><span class="n">date_part</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">dec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">extract_date</span><span class="p">(</span><span class="n">date_part</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dec</span>

<span class="k">class</span> <span class="nc">_BaseFormattedField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="n">formats</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formats</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">formats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">formats</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_BaseFormattedField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clone_base</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">_BaseFormattedField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">clone_base</span><span class="p">(</span>
            <span class="n">formats</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">formats</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">DateTimeField</span><span class="p">(</span><span class="n">_BaseFormattedField</span><span class="p">):</span>
    <span class="n">db_field</span> <span class="o">=</span> <span class="s1">&#39;datetime&#39;</span>
    <span class="n">formats</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span>
        <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">python_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">format_date_time</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">formats</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="n">year</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_date_part</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">))</span>
    <span class="n">month</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_date_part</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">))</span>
    <span class="n">day</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_date_part</span><span class="p">(</span><span class="s1">&#39;day&#39;</span><span class="p">))</span>
    <span class="n">hour</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_date_part</span><span class="p">(</span><span class="s1">&#39;hour&#39;</span><span class="p">))</span>
    <span class="n">minute</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_date_part</span><span class="p">(</span><span class="s1">&#39;minute&#39;</span><span class="p">))</span>
    <span class="n">second</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_date_part</span><span class="p">(</span><span class="s1">&#39;second&#39;</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">DateField</span><span class="p">(</span><span class="n">_BaseFormattedField</span><span class="p">):</span>
    <span class="n">db_field</span> <span class="o">=</span> <span class="s1">&#39;date&#39;</span>
    <span class="n">formats</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span>
        <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">python_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="n">pp</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">format_date_time</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">formats</span><span class="p">,</span> <span class="n">pp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="n">year</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_date_part</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">))</span>
    <span class="n">month</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_date_part</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">))</span>
    <span class="n">day</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_date_part</span><span class="p">(</span><span class="s1">&#39;day&#39;</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">TimeField</span><span class="p">(</span><span class="n">_BaseFormattedField</span><span class="p">):</span>
    <span class="n">db_field</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span>
    <span class="n">formats</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;%H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">,</span>
        <span class="s1">&#39;%H:%M&#39;</span><span class="p">,</span>
        <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">python_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                <span class="n">pp</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">format_date_time</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">formats</span><span class="p">,</span> <span class="n">pp</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">min</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="n">hour</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_date_part</span><span class="p">(</span><span class="s1">&#39;hour&#39;</span><span class="p">))</span>
    <span class="n">minute</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_date_part</span><span class="p">(</span><span class="s1">&#39;minute&#39;</span><span class="p">))</span>
    <span class="n">second</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_date_part</span><span class="p">(</span><span class="s1">&#39;second&#39;</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">TimestampField</span><span class="p">(</span><span class="n">IntegerField</span><span class="p">):</span>
    <span class="c1"># Support second -&gt; microsecond resolution.</span>
    <span class="n">valid_resolutions</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">)]</span>
    <span class="n">zero_value</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;resolution&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_resolutions</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;TimestampField resolution must be one of: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                             <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_resolutions</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">utc</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;utc&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">False</span>
        <span class="n">_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conv</span> <span class="o">=</span> <span class="n">_dt</span><span class="o">.</span><span class="n">utcfromtimestamp</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">utc</span> <span class="k">else</span> <span class="n">_dt</span><span class="o">.</span><span class="n">fromtimestamp</span>
        <span class="n">_default</span> <span class="o">=</span> <span class="n">_dt</span><span class="o">.</span><span class="n">utcnow</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">utc</span> <span class="k">else</span> <span class="n">_dt</span><span class="o">.</span><span class="n">now</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">_default</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zero_value</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;zero_value&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TimestampField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_db_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># For second resolution we can get away (for a while) with using</span>
        <span class="c1"># 4 bytes to store the timestamp (as long as they&#39;re not &gt; ~2038).</span>
        <span class="c1"># Otherwise we&#39;ll need to use a BigInteger type.</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_field</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="k">else</span> <span class="n">BigIntegerField</span><span class="o">.</span><span class="n">db_field</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">db_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">utc</span><span class="p">:</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">utctimetuple</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>
        <span class="n">timestamp</span> <span class="o">+=</span> <span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">microsecond</span> <span class="o">*</span> <span class="o">.</span><span class="mi">000001</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">timestamp</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">timestamp</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">python_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">long</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_value</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ticks_to_microsecond</span> <span class="o">=</span> <span class="mi">1000000</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span>
                <span class="n">value</span><span class="p">,</span> <span class="n">ticks</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">)</span>
                <span class="n">microseconds</span> <span class="o">=</span> <span class="n">ticks</span> <span class="o">*</span> <span class="n">ticks_to_microsecond</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conv</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">microsecond</span><span class="o">=</span><span class="n">microseconds</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conv</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

<span class="k">class</span> <span class="nc">BooleanField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="n">db_field</span> <span class="o">=</span> <span class="s1">&#39;bool&#39;</span>
    <span class="n">coerce</span> <span class="o">=</span> <span class="nb">bool</span>

<span class="k">class</span> <span class="nc">RelationDescriptor</span><span class="p">(</span><span class="n">FieldDescriptor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Foreign-key abstraction to replace a related PK with a related model.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">rel_model</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span> <span class="o">=</span> <span class="n">rel_model</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RelationDescriptor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_object_or_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="n">rel_id</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">att_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rel_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">att_name</span> <span class="ow">in</span> <span class="n">instance</span><span class="o">.</span><span class="n">_obj_cache</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">att_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">instance</span><span class="o">.</span><span class="n">_obj_cache</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">to_field</span> <span class="o">==</span> <span class="n">rel_id</span><span class="p">)</span>
                <span class="n">instance</span><span class="o">.</span><span class="n">_obj_cache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">att_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
            <span class="k">return</span> <span class="n">instance</span><span class="o">.</span><span class="n">_obj_cache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">att_name</span><span class="p">]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">null</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="o">.</span><span class="n">DoesNotExist</span>
        <span class="k">return</span> <span class="n">rel_id</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">instance_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object_or_id</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span>

    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="p">):</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">att_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                <span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">to_field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">_obj_cache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">att_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">orig_value</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">att_name</span><span class="p">)</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">att_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">if</span> <span class="n">orig_value</span> <span class="o">!=</span> <span class="n">value</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">att_name</span> <span class="ow">in</span> <span class="n">instance</span><span class="o">.</span><span class="n">_obj_cache</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">instance</span><span class="o">.</span><span class="n">_obj_cache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">att_name</span><span class="p">]</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">_dirty</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">att_name</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ReverseRelationDescriptor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Back-reference to expose related objects as a `SelectQuery`.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">model_class</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">instance_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">field</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">to_field</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span>

<span class="k">class</span> <span class="nc">ObjectIdDescriptor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gives direct access to the underlying id&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attr_name</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">instance_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">instance</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attr_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ForeignKeyField</span><span class="p">(</span><span class="n">IntegerField</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel_model</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">on_update</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">to_field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">object_id_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rel_model</span> <span class="o">!=</span> <span class="s1">&#39;self&#39;</span> <span class="ow">and</span> <span class="ow">not</span> \
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">rel_model</span><span class="p">,</span> <span class="p">(</span><span class="n">Proxy</span><span class="p">,</span> <span class="n">DeferredRelation</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> \
                <span class="nb">issubclass</span><span class="p">(</span><span class="n">rel_model</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Unexpected value for `rel_model`.  Expected &#39;</span>
                            <span class="s1">&#39;`Model`, `Proxy`, `DeferredRelation`, or &quot;self&quot;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span> <span class="o">=</span> <span class="n">rel_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_related_name</span> <span class="o">=</span> <span class="n">related_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deferred</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rel_model</span><span class="p">,</span> <span class="p">(</span><span class="n">Proxy</span><span class="p">,</span> <span class="n">DeferredRelation</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_delete</span> <span class="o">=</span> <span class="n">on_delete</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_update</span> <span class="o">=</span> <span class="n">on_update</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra</span> <span class="o">=</span> <span class="n">extra</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to_field</span> <span class="o">=</span> <span class="n">to_field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">object_id_name</span> <span class="o">=</span> <span class="n">object_id_name</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ForeignKeyField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clone_base</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ForeignKeyField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">clone_base</span><span class="p">(</span>
            <span class="n">rel_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="p">,</span>
            <span class="n">related_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_related_name</span><span class="p">(),</span>
            <span class="n">on_delete</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_delete</span><span class="p">,</span>
            <span class="n">on_update</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_update</span><span class="p">,</span>
            <span class="n">extra</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extra</span><span class="p">,</span>
            <span class="n">to_field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">to_field</span><span class="p">,</span>
            <span class="n">object_id_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">object_id_name</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_descriptor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">RelationDescriptor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_id_descriptor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ObjectIdDescriptor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_backref_descriptor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ReverseRelationDescriptor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_related_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_related_name</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_related_name</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_related_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_related_name</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_set&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_to_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="p">,</span> <span class="n">Proxy</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">rel_model</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span> <span class="o">=</span> <span class="n">rel_model</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_to_class</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="o">.</span><span class="n">attach_callback</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="p">,</span> <span class="n">DeferredRelation</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="o">.</span><span class="n">set_field</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span> <span class="o">=</span> <span class="n">model_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_column</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_id&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">obj_id_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_id_name</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj_id_name</span><span class="p">:</span>
            <span class="n">obj_id_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_column</span>
            <span class="k">if</span> <span class="n">obj_id_name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="n">obj_id_name</span> <span class="o">+=</span> <span class="s1">&#39;_id&#39;</span>
        <span class="k">elif</span> <span class="n">obj_id_name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot set a foreign key object_id_name to &#39;</span>
                             <span class="s1">&#39;the same name as the field itself.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;_+&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>

        <span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">related_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_related_name</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span> <span class="o">==</span> <span class="s1">&#39;self&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_field</span><span class="p">,</span> <span class="n">Field</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">to_field</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_field</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">to_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span>

        <span class="c1"># TODO: factor into separate method.</span>
        <span class="k">if</span> <span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">validate_backrefs</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">invalid</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">**</span><span class="n">context</span><span class="p">):</span>
                <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="n">field</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span>
                    <span class="n">backref</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">related_name</span><span class="p">,</span>
                    <span class="n">obj_id_name</span><span class="o">=</span><span class="n">obj_id_name</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="n">context</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">related_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                <span class="n">invalid</span><span class="p">(</span><span class="s1">&#39;The related_name of </span><span class="si">%(field)s</span><span class="s1"> (&quot;</span><span class="si">%(backref)s</span><span class="s1">&quot;) &#39;</span>
                        <span class="s1">&#39;conflicts with a field of the same name.&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">related_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">reverse_rel</span><span class="p">:</span>
                <span class="n">invalid</span><span class="p">(</span><span class="s1">&#39;The related_name of </span><span class="si">%(field)s</span><span class="s1"> (&quot;</span><span class="si">%(backref)s</span><span class="s1">&quot;) &#39;</span>
                        <span class="s1">&#39;is already in use by another foreign key.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">obj_id_name</span> <span class="ow">in</span> <span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                <span class="n">invalid</span><span class="p">(</span><span class="s1">&#39;The object id descriptor of </span><span class="si">%(field)s</span><span class="s1"> conflicts &#39;</span>
                        <span class="s1">&#39;with a field named </span><span class="si">%(obj_id_name)s</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">obj_id_name</span> <span class="ow">in</span> <span class="n">model_class</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                <span class="n">invalid</span><span class="p">(</span><span class="s1">&#39;Model attribute &quot;</span><span class="si">%(obj_id_name)s</span><span class="s1">&quot; would be shadowed &#39;</span>
                        <span class="s1">&#39;by the object id descriptor of </span><span class="si">%(field)s</span><span class="s1">.&#39;</span><span class="p">)</span>

        <span class="nb">setattr</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_descriptor</span><span class="p">())</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">obj_id_name</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_get_id_descriptor</span><span class="p">())</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">related_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_backref_descriptor</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_bound</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">rel</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">reverse_rel</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">related_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">get_db_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overridden to ensure Foreign Keys use same column type as the primary</span>
<span class="sd">        key they point to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_field</span><span class="p">,</span> <span class="n">PrimaryKeyField</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_field</span><span class="o">.</span><span class="n">get_db_field</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ForeignKeyField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_db_field</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_modifiers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_field</span><span class="p">,</span> <span class="n">PrimaryKeyField</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_field</span><span class="o">.</span><span class="n">get_modifiers</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ForeignKeyField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_modifiers</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">coerce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_field</span><span class="o">.</span><span class="n">coerce</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">db_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">_get_pk_value</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_field</span><span class="o">.</span><span class="n">db_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">python_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_field</span><span class="o">.</span><span class="n">python_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CompositeKey</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A primary key composed of multiple columns.&quot;&quot;&quot;</span>
    <span class="n">_node_type</span> <span class="o">=</span> <span class="s1">&#39;composite_key&#39;</span>
    <span class="n">sequence</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">field_names</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_names</span> <span class="o">=</span> <span class="n">field_names</span>

    <span class="k">def</span> <span class="nf">add_to_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span> <span class="o">=</span> <span class="n">model_class</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">instance_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_names</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">expressions</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_names</span><span class="p">,</span> <span class="n">other</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">and_</span><span class="p">,</span> <span class="n">expressions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">~</span><span class="p">(</span><span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_names</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">AliasMap</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;t&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alias_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_counter</span> <span class="o">=</span> <span class="n">start</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;AliasMap: </span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias_map</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias_map</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alias_map</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="n">alias</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_counter</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias_map</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias_map</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias_map</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">alias_map</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">obj</span><span class="p">,</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">alias_map</span><span class="o">.</span><span class="n">_alias_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_alias_map</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="n">alias</span>
        <span class="k">return</span> <span class="bp">self</span>


<span class="k">class</span> <span class="nc">QueryCompiler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># Mapping of `db_type` to actual column type used by database driver.</span>
    <span class="c1"># Database classes may provide additional column types or overrides.</span>
    <span class="n">field_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;bare&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;bigint&#39;</span><span class="p">:</span> <span class="s1">&#39;BIGINT&#39;</span><span class="p">,</span>
        <span class="s1">&#39;blob&#39;</span><span class="p">:</span> <span class="s1">&#39;BLOB&#39;</span><span class="p">,</span>
        <span class="s1">&#39;bool&#39;</span><span class="p">:</span> <span class="s1">&#39;SMALLINT&#39;</span><span class="p">,</span>
        <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="s1">&#39;DATE&#39;</span><span class="p">,</span>
        <span class="s1">&#39;datetime&#39;</span><span class="p">:</span> <span class="s1">&#39;DATETIME&#39;</span><span class="p">,</span>
        <span class="s1">&#39;decimal&#39;</span><span class="p">:</span> <span class="s1">&#39;DECIMAL&#39;</span><span class="p">,</span>
        <span class="s1">&#39;double&#39;</span><span class="p">:</span> <span class="s1">&#39;REAL&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fixed_char&#39;</span><span class="p">:</span> <span class="s1">&#39;CHAR&#39;</span><span class="p">,</span>
        <span class="s1">&#39;float&#39;</span><span class="p">:</span> <span class="s1">&#39;REAL&#39;</span><span class="p">,</span>
        <span class="s1">&#39;int&#39;</span><span class="p">:</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span>
        <span class="s1">&#39;primary_key&#39;</span><span class="p">:</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span>
        <span class="s1">&#39;smallint&#39;</span><span class="p">:</span> <span class="s1">&#39;SMALLINT&#39;</span><span class="p">,</span>
        <span class="s1">&#39;string&#39;</span><span class="p">:</span> <span class="s1">&#39;VARCHAR&#39;</span><span class="p">,</span>
        <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span>
        <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="s1">&#39;TIME&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Mapping of OP. to actual SQL operation.  For most databases this will be</span>
    <span class="c1"># the same, but some column types or databases may support additional ops.</span>
    <span class="c1"># Like `field_map`, Database classes may extend or override these.</span>
    <span class="n">op_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">OP</span><span class="o">.</span><span class="n">EQ</span><span class="p">:</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span>
        <span class="n">OP</span><span class="o">.</span><span class="n">LT</span><span class="p">:</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span>
        <span class="n">OP</span><span class="o">.</span><span class="n">LTE</span><span class="p">:</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span>
        <span class="n">OP</span><span class="o">.</span><span class="n">GT</span><span class="p">:</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span>
        <span class="n">OP</span><span class="o">.</span><span class="n">GTE</span><span class="p">:</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span>
        <span class="n">OP</span><span class="o">.</span><span class="n">NE</span><span class="p">:</span> <span class="s1">&#39;!=&#39;</span><span class="p">,</span>
        <span class="n">OP</span><span class="o">.</span><span class="n">IN</span><span class="p">:</span> <span class="s1">&#39;IN&#39;</span><span class="p">,</span>
        <span class="n">OP</span><span class="o">.</span><span class="n">NOT_IN</span><span class="p">:</span> <span class="s1">&#39;NOT IN&#39;</span><span class="p">,</span>
        <span class="n">OP</span><span class="o">.</span><span class="n">IS</span><span class="p">:</span> <span class="s1">&#39;IS&#39;</span><span class="p">,</span>
        <span class="n">OP</span><span class="o">.</span><span class="n">IS_NOT</span><span class="p">:</span> <span class="s1">&#39;IS NOT&#39;</span><span class="p">,</span>
        <span class="n">OP</span><span class="o">.</span><span class="n">BIN_AND</span><span class="p">:</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">,</span>
        <span class="n">OP</span><span class="o">.</span><span class="n">BIN_OR</span><span class="p">:</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span>
        <span class="n">OP</span><span class="o">.</span><span class="n">LIKE</span><span class="p">:</span> <span class="s1">&#39;LIKE&#39;</span><span class="p">,</span>
        <span class="n">OP</span><span class="o">.</span><span class="n">ILIKE</span><span class="p">:</span> <span class="s1">&#39;ILIKE&#39;</span><span class="p">,</span>
        <span class="n">OP</span><span class="o">.</span><span class="n">BETWEEN</span><span class="p">:</span> <span class="s1">&#39;BETWEEN&#39;</span><span class="p">,</span>
        <span class="n">OP</span><span class="o">.</span><span class="n">ADD</span><span class="p">:</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span>
        <span class="n">OP</span><span class="o">.</span><span class="n">SUB</span><span class="p">:</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span>
        <span class="n">OP</span><span class="o">.</span><span class="n">MUL</span><span class="p">:</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span>
        <span class="n">OP</span><span class="o">.</span><span class="n">DIV</span><span class="p">:</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
        <span class="n">OP</span><span class="o">.</span><span class="n">XOR</span><span class="p">:</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span>
        <span class="n">OP</span><span class="o">.</span><span class="n">AND</span><span class="p">:</span> <span class="s1">&#39;AND&#39;</span><span class="p">,</span>
        <span class="n">OP</span><span class="o">.</span><span class="n">OR</span><span class="p">:</span> <span class="s1">&#39;OR&#39;</span><span class="p">,</span>
        <span class="n">OP</span><span class="o">.</span><span class="n">MOD</span><span class="p">:</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span>
        <span class="n">OP</span><span class="o">.</span><span class="n">REGEXP</span><span class="p">:</span> <span class="s1">&#39;REGEXP&#39;</span><span class="p">,</span>
        <span class="n">OP</span><span class="o">.</span><span class="n">CONCAT</span><span class="p">:</span> <span class="s1">&#39;||&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">join_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">JOIN</span><span class="o">.</span><span class="n">INNER</span><span class="p">:</span> <span class="s1">&#39;INNER JOIN&#39;</span><span class="p">,</span>
        <span class="n">JOIN</span><span class="o">.</span><span class="n">LEFT_OUTER</span><span class="p">:</span> <span class="s1">&#39;LEFT OUTER JOIN&#39;</span><span class="p">,</span>
        <span class="n">JOIN</span><span class="o">.</span><span class="n">RIGHT_OUTER</span><span class="p">:</span> <span class="s1">&#39;RIGHT OUTER JOIN&#39;</span><span class="p">,</span>
        <span class="n">JOIN</span><span class="o">.</span><span class="n">FULL</span><span class="p">:</span> <span class="s1">&#39;FULL JOIN&#39;</span><span class="p">,</span>
        <span class="n">JOIN</span><span class="o">.</span><span class="n">CROSS</span><span class="p">:</span> <span class="s1">&#39;CROSS JOIN&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">alias_map_class</span> <span class="o">=</span> <span class="n">AliasMap</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quote_char</span><span class="o">=</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">field_overrides</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">op_overrides</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quote_char</span> <span class="o">=</span> <span class="n">quote_char</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_field_map</span> <span class="o">=</span> <span class="n">merge_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_map</span><span class="p">,</span> <span class="n">field_overrides</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_op_map</span> <span class="o">=</span> <span class="n">merge_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">op_map</span><span class="p">,</span> <span class="n">op_overrides</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parse_map</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unknown_types</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;param&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">get_parse_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># To avoid O(n) lookups when parsing nodes, use a lookup table for</span>
        <span class="c1"># common node types O(1).</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;expression&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_expression</span><span class="p">,</span>
            <span class="s1">&#39;param&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_param</span><span class="p">,</span>
            <span class="s1">&#39;passthrough&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_passthrough</span><span class="p">,</span>
            <span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_func</span><span class="p">,</span>
            <span class="s1">&#39;clause&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_clause</span><span class="p">,</span>
            <span class="s1">&#39;entity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_entity</span><span class="p">,</span>
            <span class="s1">&#39;field&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_field</span><span class="p">,</span>
            <span class="s1">&#39;sql&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_sql</span><span class="p">,</span>
            <span class="s1">&#39;select_query&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_select_query</span><span class="p">,</span>
            <span class="s1">&#39;compound_select_query&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_compound_select_query</span><span class="p">,</span>
            <span class="s1">&#39;strip_parens&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_strip_parens</span><span class="p">,</span>
            <span class="s1">&#39;composite_key&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_composite_key</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">quote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quote_char</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote_char</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_column_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_map</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_map</span> <span class="k">else</span> <span class="n">f</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_op</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op_map</span><span class="p">[</span><span class="n">q</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_sorted_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">field_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_sort_key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">,</span> <span class="n">conv</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolation</span><span class="p">,</span> <span class="p">[</span><span class="n">node</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_parse_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">,</span> <span class="n">conv</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="n">Field</span><span class="p">):</span>
            <span class="n">conv</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">lhs</span>
        <span class="n">lhs</span><span class="p">,</span> <span class="n">lparams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_node</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">,</span> <span class="n">conv</span><span class="p">)</span>
        <span class="n">rhs</span><span class="p">,</span> <span class="n">rparams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_node</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">rhs</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">,</span> <span class="n">conv</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="n">OP</span><span class="o">.</span><span class="n">IN</span> <span class="ow">and</span> <span class="n">rhs</span> <span class="o">==</span> <span class="s1">&#39;()&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rparams</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;0 = 1&#39;</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">flat</span> <span class="k">else</span> <span class="s1">&#39;(0 = 1)&#39;</span><span class="p">),</span> <span class="p">[]</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">flat</span> <span class="k">else</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">)&#39;</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="n">template</span> <span class="o">%</span> <span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_op</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="p">),</span> <span class="n">rhs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sql</span><span class="p">,</span> <span class="n">lparams</span> <span class="o">+</span> <span class="n">rparams</span>

    <span class="k">def</span> <span class="nf">_parse_passthrough</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">,</span> <span class="n">conv</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">adapt</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_node</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">adapt</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> <span class="n">alias_map</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolation</span><span class="p">,</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_parse_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">,</span> <span class="n">conv</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">adapt</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">conv</span> <span class="ow">and</span> <span class="n">conv</span><span class="o">.</span><span class="n">db_value</span> <span class="ow">is</span> <span class="n">node</span><span class="o">.</span><span class="n">adapt</span><span class="p">:</span>
                <span class="n">conv</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_node</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">adapt</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> <span class="n">alias_map</span><span class="p">,</span> <span class="n">conv</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">conv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_node</span><span class="p">(</span><span class="n">conv</span><span class="o">.</span><span class="n">db_value</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> <span class="n">alias_map</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolation</span><span class="p">,</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_parse_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">,</span> <span class="n">conv</span><span class="p">):</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">_coerce</span> <span class="ow">and</span> <span class="n">conv</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_node_list</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">arguments</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">,</span> <span class="n">conv</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">strip_parens</span><span class="p">(</span><span class="n">sql</span><span class="p">)),</span> <span class="n">params</span>

    <span class="k">def</span> <span class="nf">_parse_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">,</span> <span class="n">conv</span><span class="p">):</span>
        <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_node_list</span><span class="p">(</span>
            <span class="n">node</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">,</span> <span class="n">conv</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">glue</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">parens</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">strip_parens</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sql</span><span class="p">,</span> <span class="n">params</span>

    <span class="k">def</span> <span class="nf">_parse_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">,</span> <span class="n">conv</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quote</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">path</span><span class="p">)),</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_parse_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">,</span> <span class="n">conv</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">,</span> <span class="n">conv</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">alias_map</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">alias_map</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">model_class</span><span class="p">]),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">db_column</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">db_column</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sql</span><span class="p">,</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_parse_composite_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">,</span> <span class="n">conv</span><span class="p">):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">field_names</span><span class="p">:</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_clause</span><span class="p">(</span><span class="n">CommaClause</span><span class="p">(</span><span class="o">*</span><span class="n">fields</span><span class="p">),</span> <span class="n">alias_map</span><span class="p">,</span> <span class="n">conv</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_compound_select_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">,</span> <span class="n">conv</span><span class="p">):</span>
        <span class="n">csq</span> <span class="o">=</span> <span class="s1">&#39;compound_select_query&#39;</span>
        <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">rhs</span>
        <span class="n">inv</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">_node_type</span> <span class="o">==</span> <span class="n">csq</span> <span class="ow">and</span> <span class="n">lhs</span><span class="o">.</span><span class="n">_node_type</span> <span class="o">!=</span> <span class="n">csq</span>
        <span class="k">if</span> <span class="n">inv</span><span class="p">:</span>
            <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span> <span class="o">=</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">lhs</span>

        <span class="n">new_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map_class</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lhs</span><span class="o">.</span><span class="n">_node_type</span> <span class="o">==</span> <span class="n">csq</span><span class="p">:</span>
            <span class="n">new_map</span><span class="o">.</span><span class="n">_counter</span> <span class="o">=</span> <span class="n">alias_map</span><span class="o">.</span><span class="n">_counter</span>

        <span class="n">sql1</span><span class="p">,</span> <span class="n">p1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_select</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">new_map</span><span class="p">)</span>
        <span class="n">sql2</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_select</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_alias_map</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span>
                                                                      <span class="n">new_map</span><span class="p">))</span>

        <span class="c1"># We add outer parentheses in the event the compound query is used in</span>
        <span class="c1"># the `from_()` clause, in which case we&#39;ll need them.</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">compound_select_parentheses</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lhs</span><span class="o">.</span><span class="n">_node_type</span> <span class="o">!=</span> <span class="n">csq</span><span class="p">:</span>
                <span class="n">sql1</span> <span class="o">=</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">sql1</span>
            <span class="k">if</span> <span class="n">rhs</span><span class="o">.</span><span class="n">_node_type</span> <span class="o">!=</span> <span class="n">csq</span><span class="p">:</span>
                <span class="n">sql2</span> <span class="o">=</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">sql2</span>

        <span class="k">if</span> <span class="n">inv</span><span class="p">:</span>
            <span class="n">sql1</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">sql2</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">sql2</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">sql1</span><span class="p">,</span> <span class="n">p1</span>

        <span class="k">return</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sql1</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">operator</span><span class="p">,</span> <span class="n">sql2</span><span class="p">),</span> <span class="p">(</span><span class="n">p1</span> <span class="o">+</span> <span class="n">p2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_select_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">,</span> <span class="n">conv</span><span class="p">):</span>
        <span class="n">clone</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">_explicit_selection</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">conv</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conv</span><span class="p">,</span> <span class="n">ForeignKeyField</span><span class="p">):</span>
                <span class="n">clone</span><span class="o">.</span><span class="n">_select</span> <span class="o">=</span> <span class="p">(</span><span class="n">conv</span><span class="o">.</span><span class="n">to_field</span><span class="p">,)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">clone</span><span class="o">.</span><span class="n">_select</span> <span class="o">=</span> <span class="n">clone</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_primary_key_fields</span><span class="p">()</span>
        <span class="n">sub</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_select</span><span class="p">(</span><span class="n">clone</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">strip_parens</span><span class="p">(</span><span class="n">sub</span><span class="p">),</span> <span class="n">params</span>

    <span class="k">def</span> <span class="nf">_parse_strip_parens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">,</span> <span class="n">conv</span><span class="p">):</span>
        <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_node</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">,</span> <span class="n">conv</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">strip_parens</span><span class="p">(</span><span class="n">sql</span><span class="p">),</span> <span class="n">params</span>

    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">,</span> <span class="n">conv</span><span class="p">):</span>
        <span class="c1"># By default treat the incoming node as a raw value that should be</span>
        <span class="c1"># parameterized.</span>
        <span class="n">node_type</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;_node_type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">unknown</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_map</span><span class="p">:</span>
            <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_map</span><span class="p">[</span><span class="n">node_type</span><span class="p">](</span><span class="n">node</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">,</span> <span class="n">conv</span><span class="p">)</span>
            <span class="n">unknown</span> <span class="o">=</span> <span class="p">(</span><span class="n">node_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unknown_types</span> <span class="ow">and</span>
                       <span class="n">node</span><span class="o">.</span><span class="n">adapt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span>
                       <span class="n">conv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">)):</span>
            <span class="c1"># If you&#39;re wondering how to pass a list into your query, simply</span>
            <span class="c1"># wrap it in Param().</span>
            <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_node_list</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">,</span> <span class="n">conv</span><span class="p">)</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">sql</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolation</span>
            <span class="k">if</span> <span class="n">conv</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conv</span><span class="p">,</span> <span class="n">ForeignKeyField</span><span class="p">):</span>
                <span class="n">to_field</span> <span class="o">=</span> <span class="n">conv</span><span class="o">.</span><span class="n">to_field</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_field</span><span class="p">,</span> <span class="n">ForeignKeyField</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">conv</span><span class="o">.</span><span class="n">db_value</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">to_field</span><span class="o">.</span><span class="n">db_value</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">to_field</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">_get_pk_value</span><span class="p">()</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">isclass</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Model</span><span class="p">))</span> <span class="ow">or</span> \
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ModelAlias</span><span class="p">):</span>
            <span class="n">entity</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">as_entity</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">alias_map</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
            <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_node</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">,</span> <span class="n">conv</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">conv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">conv</span><span class="o">.</span><span class="n">db_value</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_default</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">unknown</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">unknown</span>

    <span class="k">def</span> <span class="nf">parse_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">alias_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">unknown</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">,</span> <span class="n">conv</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unknown</span> <span class="ow">and</span> <span class="p">(</span><span class="n">conv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">conv</span><span class="o">.</span><span class="n">db_value</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">params</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">_negated</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;NOT </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sql</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">_alias</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">sql</span><span class="p">,</span> <span class="s1">&#39;AS&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">_alias</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">_ordering</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">sql</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">_ordering</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">params</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">Node</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">clean_params</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">clean_sql</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
                    <span class="n">csql</span><span class="p">,</span> <span class="n">cparams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_node</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sql</span><span class="p">,</span> <span class="n">params</span>

    <span class="k">def</span> <span class="nf">parse_node_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">glue</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="p">):</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="n">node_sql</span><span class="p">,</span> <span class="n">node_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">,</span> <span class="n">conv</span><span class="p">)</span>
            <span class="n">sql</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_sql</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">node_params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">glue</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sql</span><span class="p">),</span> <span class="n">params</span>

    <span class="k">def</span> <span class="nf">calculate_alias_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">alias_map</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">new_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map_class</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">alias_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_map</span><span class="o">.</span><span class="n">_counter</span> <span class="o">=</span> <span class="n">alias_map</span><span class="o">.</span><span class="n">_counter</span>

        <span class="n">new_map</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">model_class</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">table_alias</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">src_model</span><span class="p">,</span> <span class="n">joined_models</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">_joins</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">new_map</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">src_model</span><span class="p">,</span> <span class="n">src_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">table_alias</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">join_obj</span> <span class="ow">in</span> <span class="n">joined_models</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">join_obj</span><span class="o">.</span><span class="n">dest</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
                    <span class="n">new_map</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">join_obj</span><span class="o">.</span><span class="n">dest</span><span class="p">,</span> <span class="n">join_obj</span><span class="o">.</span><span class="n">dest</span><span class="o">.</span><span class="n">alias</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_map</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">join_obj</span><span class="o">.</span><span class="n">dest</span><span class="p">,</span> <span class="n">join_obj</span><span class="o">.</span><span class="n">dest</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">table_alias</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">new_map</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">alias_map</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">build_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clauses</span><span class="p">,</span> <span class="n">alias_map</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_node</span><span class="p">(</span><span class="n">Clause</span><span class="p">(</span><span class="o">*</span><span class="n">clauses</span><span class="p">),</span> <span class="n">alias_map</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">generate_joins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">joins</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">):</span>
        <span class="c1"># Joins are implemented as an adjancency-list graph. Perform a</span>
        <span class="c1"># depth-first search of the graph to generate all the necessary JOINs.</span>
        <span class="n">clauses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">q</span> <span class="o">=</span> <span class="p">[</span><span class="n">model_class</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">q</span><span class="p">:</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">curr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">joins</span> <span class="ow">or</span> <span class="n">curr</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">join</span> <span class="ow">in</span> <span class="n">joins</span><span class="p">[</span><span class="n">curr</span><span class="p">]:</span>
                <span class="n">src</span> <span class="o">=</span> <span class="n">curr</span>
                <span class="n">dest</span> <span class="o">=</span> <span class="n">join</span><span class="o">.</span><span class="n">dest</span>
                <span class="n">join_type</span> <span class="o">=</span> <span class="n">join</span><span class="o">.</span><span class="n">get_join_type</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">join</span><span class="o">.</span><span class="n">on</span><span class="p">,</span> <span class="p">(</span><span class="n">Expression</span><span class="p">,</span> <span class="n">Func</span><span class="p">,</span> <span class="n">Clause</span><span class="p">,</span> <span class="n">Entity</span><span class="p">)):</span>
                    <span class="c1"># Clear any alias on the join expression.</span>
                    <span class="n">constraint</span> <span class="o">=</span> <span class="n">join</span><span class="o">.</span><span class="n">on</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">join_type</span> <span class="o">!=</span> <span class="n">JOIN</span><span class="o">.</span><span class="n">CROSS</span><span class="p">:</span>
                    <span class="n">metadata</span> <span class="o">=</span> <span class="n">join</span><span class="o">.</span><span class="n">metadata</span>
                    <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">is_backref</span><span class="p">:</span>
                        <span class="n">fk_model</span> <span class="o">=</span> <span class="n">join</span><span class="o">.</span><span class="n">dest</span>
                        <span class="n">pk_model</span> <span class="o">=</span> <span class="n">join</span><span class="o">.</span><span class="n">src</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fk_model</span> <span class="o">=</span> <span class="n">join</span><span class="o">.</span><span class="n">src</span>
                        <span class="n">pk_model</span> <span class="o">=</span> <span class="n">join</span><span class="o">.</span><span class="n">dest</span>

                    <span class="n">fk</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">foreign_key</span>
                    <span class="k">if</span> <span class="n">fk</span><span class="p">:</span>
                        <span class="n">lhs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fk_model</span><span class="p">,</span> <span class="n">fk</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">rhs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pk_model</span><span class="p">,</span> <span class="n">fk</span><span class="o">.</span><span class="n">to_field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">is_backref</span><span class="p">:</span>
                            <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span> <span class="o">=</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">lhs</span>
                        <span class="n">constraint</span> <span class="o">=</span> <span class="p">(</span><span class="n">lhs</span> <span class="o">==</span> <span class="n">rhs</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Missing required join predicate.&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
                    <span class="c1"># TODO: ensure alias?</span>
                    <span class="n">dest_n</span> <span class="o">=</span> <span class="n">dest</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
                    <span class="n">dest_n</span> <span class="o">=</span> <span class="n">dest</span><span class="o">.</span><span class="n">as_entity</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">alias_map</span><span class="p">[</span><span class="n">dest</span><span class="p">])</span>

                <span class="n">join_sql</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">join_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">join_type</span><span class="p">)</span> <span class="ow">or</span> <span class="n">join_type</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">join_type</span> <span class="o">==</span> <span class="n">JOIN</span><span class="o">.</span><span class="n">CROSS</span><span class="p">:</span>
                    <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Clause</span><span class="p">(</span><span class="n">join_sql</span><span class="p">,</span> <span class="n">dest_n</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Clause</span><span class="p">(</span><span class="n">join_sql</span><span class="p">,</span> <span class="n">dest_n</span><span class="p">,</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;ON&#39;</span><span class="p">),</span>
                                          <span class="n">constraint</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">clauses</span>

    <span class="k">def</span> <span class="nf">generate_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">alias_map</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">model_class</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span>

        <span class="n">alias_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_alias_map</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">CompoundSelect</span><span class="p">):</span>
            <span class="n">clauses</span> <span class="o">=</span> <span class="p">[</span><span class="n">_StripParens</span><span class="p">(</span><span class="n">query</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span><span class="o">.</span><span class="n">_distinct</span><span class="p">:</span>
                <span class="n">clauses</span> <span class="o">=</span> <span class="p">[</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;SELECT&#39;</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">clauses</span> <span class="o">=</span> <span class="p">[</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;SELECT DISTINCT&#39;</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">_distinct</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="n">clauses</span> <span class="o">+=</span> <span class="p">[</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;ON&#39;</span><span class="p">),</span> <span class="n">EnclosedClause</span><span class="p">(</span><span class="o">*</span><span class="n">query</span><span class="o">.</span><span class="n">_distinct</span><span class="p">)]</span>

            <span class="n">select_clause</span> <span class="o">=</span> <span class="n">Clause</span><span class="p">(</span><span class="o">*</span><span class="n">query</span><span class="o">.</span><span class="n">_select</span><span class="p">)</span>
            <span class="n">select_clause</span><span class="o">.</span><span class="n">glue</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span>

            <span class="n">clauses</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">select_clause</span><span class="p">,</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;FROM&#39;</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">_from</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">as_entity</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">alias_map</span><span class="p">[</span><span class="n">model</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CommaClause</span><span class="p">(</span><span class="o">*</span><span class="n">query</span><span class="o">.</span><span class="n">_from</span><span class="p">))</span>

        <span class="n">join_clauses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_joins</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">_joins</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">join_clauses</span><span class="p">:</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">join_clauses</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">_where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;WHERE&#39;</span><span class="p">),</span> <span class="n">query</span><span class="o">.</span><span class="n">_where</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">_group_by</span><span class="p">:</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;GROUP BY&#39;</span><span class="p">),</span> <span class="n">CommaClause</span><span class="p">(</span><span class="o">*</span><span class="n">query</span><span class="o">.</span><span class="n">_group_by</span><span class="p">)])</span>

        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">_having</span><span class="p">:</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;HAVING&#39;</span><span class="p">),</span> <span class="n">query</span><span class="o">.</span><span class="n">_having</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">_windows</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;WINDOW&#39;</span><span class="p">))</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CommaClause</span><span class="p">(</span><span class="o">*</span><span class="p">[</span>
                <span class="n">Clause</span><span class="p">(</span>
                    <span class="n">SQL</span><span class="p">(</span><span class="n">window</span><span class="o">.</span><span class="n">_alias</span><span class="p">),</span>
                    <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;AS&#39;</span><span class="p">),</span>
                    <span class="n">window</span><span class="o">.</span><span class="n">__sql__</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">_windows</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">_order_by</span><span class="p">:</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;ORDER BY&#39;</span><span class="p">),</span> <span class="n">CommaClause</span><span class="p">(</span><span class="o">*</span><span class="n">query</span><span class="o">.</span><span class="n">_order_by</span><span class="p">)])</span>

        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">_limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">_offset</span> <span class="ow">and</span> <span class="n">db</span><span class="o">.</span><span class="n">limit_max</span><span class="p">):</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_limit</span> <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">_limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">db</span><span class="o">.</span><span class="n">limit_max</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;LIMIT </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">limit</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;OFFSET </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">query</span><span class="o">.</span><span class="n">_offset</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">_for_update</span><span class="p">:</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">_for_update</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_query</span><span class="p">(</span><span class="n">clauses</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">generate_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">model_class</span>
        <span class="n">alias_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map_class</span><span class="p">()</span>
        <span class="n">alias_map</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">_on_conflict</span><span class="p">:</span>
            <span class="n">statement</span> <span class="o">=</span> <span class="s1">&#39;UPDATE OR </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">query</span><span class="o">.</span><span class="n">_on_conflict</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">statement</span> <span class="o">=</span> <span class="s1">&#39;UPDATE&#39;</span>
        <span class="n">clauses</span> <span class="o">=</span> <span class="p">[</span><span class="n">SQL</span><span class="p">(</span><span class="n">statement</span><span class="p">),</span> <span class="n">model</span><span class="o">.</span><span class="n">as_entity</span><span class="p">(),</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;SET&#39;</span><span class="p">)]</span>

        <span class="n">update</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sorted_fields</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">_update</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">Model</span><span class="p">)):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">adapt</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">db_value</span><span class="p">)</span>
            <span class="n">update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Expression</span><span class="p">(</span>
                <span class="n">field</span><span class="o">.</span><span class="n">as_entity</span><span class="p">(</span><span class="n">with_table</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                <span class="n">OP</span><span class="o">.</span><span class="n">EQ</span><span class="p">,</span>
                <span class="n">value</span><span class="p">,</span>
                <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>  <span class="c1"># No outer parens, no table alias.</span>
        <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CommaClause</span><span class="p">(</span><span class="o">*</span><span class="n">update</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">_where</span><span class="p">:</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;WHERE&#39;</span><span class="p">),</span> <span class="n">query</span><span class="o">.</span><span class="n">_where</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">_returning</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">returning_clause</span> <span class="o">=</span> <span class="n">Clause</span><span class="p">(</span><span class="o">*</span><span class="n">query</span><span class="o">.</span><span class="n">_returning</span><span class="p">)</span>
            <span class="n">returning_clause</span><span class="o">.</span><span class="n">glue</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;RETURNING&#39;</span><span class="p">),</span> <span class="n">returning_clause</span><span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_query</span><span class="p">(</span><span class="n">clauses</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_field_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">clause_type</span><span class="o">=</span><span class="n">EnclosedClause</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">clause_type</span><span class="p">(</span><span class="o">*</span><span class="p">[</span>
            <span class="n">field</span><span class="o">.</span><span class="n">as_entity</span><span class="p">(</span><span class="n">with_table</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">generate_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">model_class</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span>
        <span class="n">alias_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map_class</span><span class="p">()</span>
        <span class="n">alias_map</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">_upsert</span><span class="p">:</span>
            <span class="n">statement</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">upsert_sql</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">_on_conflict</span><span class="p">:</span>
            <span class="n">statement</span> <span class="o">=</span> <span class="s1">&#39;INSERT OR </span><span class="si">%s</span><span class="s1"> INTO&#39;</span> <span class="o">%</span> <span class="n">query</span><span class="o">.</span><span class="n">_on_conflict</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">statement</span> <span class="o">=</span> <span class="s1">&#39;INSERT INTO&#39;</span>
        <span class="n">clauses</span> <span class="o">=</span> <span class="p">[</span><span class="n">SQL</span><span class="p">(</span><span class="n">statement</span><span class="p">),</span> <span class="n">model</span><span class="o">.</span><span class="n">as_entity</span><span class="p">()]</span>

        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">_query</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># This INSERT query is of the form INSERT INTO ... SELECT FROM.</span>
            <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
                <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_field_clause</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">_fields</span><span class="p">))</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_StripParens</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">_query</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">_rows</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fields</span><span class="p">,</span> <span class="n">value_clauses</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="n">have_fields</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">for</span> <span class="n">row_dict</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">_iter_rows</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">have_fields</span><span class="p">:</span>
                    <span class="n">fields</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                        <span class="n">row_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;_sort_key&#39;</span><span class="p">))</span>
                    <span class="n">have_fields</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">row_dict</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">Model</span><span class="p">)):</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">adapt</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">db_value</span><span class="p">)</span>
                    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="n">value_clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EnclosedClause</span><span class="p">(</span><span class="o">*</span><span class="n">values</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">fields</span><span class="p">:</span>
                <span class="n">clauses</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_get_field_clause</span><span class="p">(</span><span class="n">fields</span><span class="p">),</span>
                    <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;VALUES&#39;</span><span class="p">),</span>
                    <span class="n">CommaClause</span><span class="p">(</span><span class="o">*</span><span class="n">value_clauses</span><span class="p">)])</span>
            <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">auto_increment</span><span class="p">:</span>
                <span class="c1"># Bare insert, use default value for primary key.</span>
                <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">default_insert_clause</span><span class="p">(</span>
                    <span class="n">query</span><span class="o">.</span><span class="n">model_class</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">is_insert_returning</span><span class="p">:</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;RETURNING&#39;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_field_clause</span><span class="p">(</span>
                    <span class="n">meta</span><span class="o">.</span><span class="n">get_primary_key_fields</span><span class="p">(),</span>
                    <span class="n">clause_type</span><span class="o">=</span><span class="n">CommaClause</span><span class="p">)])</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">_returning</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">returning_clause</span> <span class="o">=</span> <span class="n">Clause</span><span class="p">(</span><span class="o">*</span><span class="n">query</span><span class="o">.</span><span class="n">_returning</span><span class="p">)</span>
            <span class="n">returning_clause</span><span class="o">.</span><span class="n">glue</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;RETURNING&#39;</span><span class="p">),</span> <span class="n">returning_clause</span><span class="p">])</span>


        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_query</span><span class="p">(</span><span class="n">clauses</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">generate_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">model_class</span>
        <span class="n">clauses</span> <span class="o">=</span> <span class="p">[</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;DELETE FROM&#39;</span><span class="p">),</span> <span class="n">model</span><span class="o">.</span><span class="n">as_entity</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">_where</span><span class="p">:</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;WHERE&#39;</span><span class="p">),</span> <span class="n">query</span><span class="o">.</span><span class="n">_where</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">_returning</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">returning_clause</span> <span class="o">=</span> <span class="n">Clause</span><span class="p">(</span><span class="o">*</span><span class="n">query</span><span class="o">.</span><span class="n">_returning</span><span class="p">)</span>
            <span class="n">returning_clause</span><span class="o">.</span><span class="n">glue</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;RETURNING&#39;</span><span class="p">),</span> <span class="n">returning_clause</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_query</span><span class="p">(</span><span class="n">clauses</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">field_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="n">column_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_column_type</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">get_db_field</span><span class="p">())</span>
        <span class="n">ddl</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">__ddl__</span><span class="p">(</span><span class="n">column_type</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Clause</span><span class="p">(</span><span class="o">*</span><span class="n">ddl</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">foreign_key_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="n">ddl</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;FOREIGN KEY&#39;</span><span class="p">),</span>
            <span class="n">EnclosedClause</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">as_entity</span><span class="p">()),</span>
            <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;REFERENCES&#39;</span><span class="p">),</span>
            <span class="n">field</span><span class="o">.</span><span class="n">rel_model</span><span class="o">.</span><span class="n">as_entity</span><span class="p">(),</span>
            <span class="n">EnclosedClause</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">to_field</span><span class="o">.</span><span class="n">as_entity</span><span class="p">())]</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">on_delete</span><span class="p">:</span>
            <span class="n">ddl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;ON DELETE </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">field</span><span class="o">.</span><span class="n">on_delete</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">on_update</span><span class="p">:</span>
            <span class="n">ddl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;ON UPDATE </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">field</span><span class="o">.</span><span class="n">on_update</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">Clause</span><span class="p">(</span><span class="o">*</span><span class="n">ddl</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">return_parsed_node</span><span class="p">(</span><span class="n">function_name</span><span class="p">):</span>
        <span class="c1"># TODO: treat all `generate_` functions as returning clauses, instead</span>
        <span class="c1"># of SQL/params.</span>
        <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_node</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">inner</span>

    <span class="k">def</span> <span class="nf">_create_foreign_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">constraint</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">constraint</span> <span class="o">=</span> <span class="n">constraint</span> <span class="ow">or</span> <span class="s1">&#39;fk_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_refs_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span><span class="p">,</span>
            <span class="n">field</span><span class="o">.</span><span class="n">db_column</span><span class="p">,</span>
            <span class="n">field</span><span class="o">.</span><span class="n">rel_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span><span class="p">)</span>
        <span class="n">fk_clause</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">foreign_key_constraint</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Clause</span><span class="p">(</span>
            <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;ALTER TABLE&#39;</span><span class="p">),</span>
            <span class="n">model_class</span><span class="o">.</span><span class="n">as_entity</span><span class="p">(),</span>
            <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;ADD CONSTRAINT&#39;</span><span class="p">),</span>
            <span class="n">Entity</span><span class="p">(</span><span class="n">constraint</span><span class="p">),</span>
            <span class="o">*</span><span class="n">fk_clause</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
    <span class="n">create_foreign_key</span> <span class="o">=</span> <span class="n">return_parsed_node</span><span class="p">(</span><span class="s1">&#39;_create_foreign_key&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">statement</span> <span class="o">=</span> <span class="s1">&#39;CREATE TABLE IF NOT EXISTS&#39;</span> <span class="k">if</span> <span class="n">safe</span> <span class="k">else</span> <span class="s1">&#39;CREATE TABLE&#39;</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span>

        <span class="n">columns</span><span class="p">,</span> <span class="n">constraints</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">meta</span><span class="o">.</span><span class="n">composite_key</span><span class="p">:</span>
            <span class="n">pk_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">meta</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">as_entity</span><span class="p">()</span>
                       <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">field_names</span><span class="p">]</span>
            <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Clause</span><span class="p">(</span>
                <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;PRIMARY KEY&#39;</span><span class="p">),</span> <span class="n">EnclosedClause</span><span class="p">(</span><span class="o">*</span><span class="n">pk_cols</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">declared_fields</span><span class="p">:</span>
            <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_definition</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">ForeignKeyField</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">deferred</span><span class="p">:</span>
                <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">foreign_key_constraint</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">constraint</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
                    <span class="n">constraint</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="n">constraint</span><span class="p">)</span>
                <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constraint</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Clause</span><span class="p">(</span>
            <span class="n">SQL</span><span class="p">(</span><span class="n">statement</span><span class="p">),</span>
            <span class="n">model_class</span><span class="o">.</span><span class="n">as_entity</span><span class="p">(),</span>
            <span class="n">EnclosedClause</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">columns</span> <span class="o">+</span> <span class="n">constraints</span><span class="p">)))</span>
    <span class="n">create_table</span> <span class="o">=</span> <span class="n">return_parsed_node</span><span class="p">(</span><span class="s1">&#39;_create_table&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_drop_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">fail_silently</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">statement</span> <span class="o">=</span> <span class="s1">&#39;DROP TABLE IF EXISTS&#39;</span> <span class="k">if</span> <span class="n">fail_silently</span> <span class="k">else</span> <span class="s1">&#39;DROP TABLE&#39;</span>
        <span class="n">ddl</span> <span class="o">=</span> <span class="p">[</span><span class="n">SQL</span><span class="p">(</span><span class="n">statement</span><span class="p">),</span> <span class="n">model_class</span><span class="o">.</span><span class="n">as_entity</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">cascade</span><span class="p">:</span>
            <span class="n">ddl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">Clause</span><span class="p">(</span><span class="o">*</span><span class="n">ddl</span><span class="p">)</span>
    <span class="n">drop_table</span> <span class="o">=</span> <span class="n">return_parsed_node</span><span class="p">(</span><span class="s1">&#39;_drop_table&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_truncate_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">restart_identity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">cascade</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">ddl</span> <span class="o">=</span> <span class="p">[</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;TRUNCATE TABLE&#39;</span><span class="p">),</span> <span class="n">model_class</span><span class="o">.</span><span class="n">as_entity</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">restart_identity</span><span class="p">:</span>
            <span class="n">ddl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;RESTART IDENTITY&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">cascade</span><span class="p">:</span>
            <span class="n">ddl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">Clause</span><span class="p">(</span><span class="o">*</span><span class="n">ddl</span><span class="p">)</span>
    <span class="n">truncate_table</span> <span class="o">=</span> <span class="n">return_parsed_node</span><span class="p">(</span><span class="s1">&#39;_truncate_table&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">index_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columns</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">:</span>
            <span class="n">index_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
            <span class="n">index</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="p">[:</span><span class="mi">55</span><span class="p">],</span> <span class="n">index_hash</span><span class="p">[:</span><span class="mi">8</span><span class="p">])</span>  <span class="c1"># 55 + 1 + 8 = 64</span>
        <span class="k">return</span> <span class="n">index</span>

    <span class="k">def</span> <span class="nf">_create_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">unique</span><span class="p">,</span> <span class="o">*</span><span class="n">extra</span><span class="p">):</span>
        <span class="n">tbl_name</span> <span class="o">=</span> <span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span>
        <span class="n">statement</span> <span class="o">=</span> <span class="s1">&#39;CREATE UNIQUE INDEX&#39;</span> <span class="k">if</span> <span class="n">unique</span> <span class="k">else</span> <span class="s1">&#39;CREATE INDEX&#39;</span>
        <span class="n">index_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_name</span><span class="p">(</span><span class="n">tbl_name</span><span class="p">,</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">db_column</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">Clause</span><span class="p">(</span>
            <span class="n">SQL</span><span class="p">(</span><span class="n">statement</span><span class="p">),</span>
            <span class="n">Entity</span><span class="p">(</span><span class="n">index_name</span><span class="p">),</span>
            <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;ON&#39;</span><span class="p">),</span>
            <span class="n">model_class</span><span class="o">.</span><span class="n">as_entity</span><span class="p">(),</span>
            <span class="n">EnclosedClause</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">as_entity</span><span class="p">()</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">]),</span>
            <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
    <span class="n">create_index</span> <span class="o">=</span> <span class="n">return_parsed_node</span><span class="p">(</span><span class="s1">&#39;_create_index&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_drop_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">fail_silently</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">tbl_name</span> <span class="o">=</span> <span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span>
        <span class="n">statement</span> <span class="o">=</span> <span class="s1">&#39;DROP INDEX IF EXISTS&#39;</span> <span class="k">if</span> <span class="n">fail_silently</span> <span class="k">else</span> <span class="s1">&#39;DROP INDEX&#39;</span>
        <span class="n">index_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_name</span><span class="p">(</span><span class="n">tbl_name</span><span class="p">,</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">db_column</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">Clause</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="n">statement</span><span class="p">),</span> <span class="n">Entity</span><span class="p">(</span><span class="n">index_name</span><span class="p">))</span>
    <span class="n">drop_index</span> <span class="o">=</span> <span class="n">return_parsed_node</span><span class="p">(</span><span class="s1">&#39;_drop_index&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Clause</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;CREATE SEQUENCE&#39;</span><span class="p">),</span> <span class="n">Entity</span><span class="p">(</span><span class="n">sequence_name</span><span class="p">))</span>
    <span class="n">create_sequence</span> <span class="o">=</span> <span class="n">return_parsed_node</span><span class="p">(</span><span class="s1">&#39;_create_sequence&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_drop_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Clause</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;DROP SEQUENCE&#39;</span><span class="p">),</span> <span class="n">Entity</span><span class="p">(</span><span class="n">sequence_name</span><span class="p">))</span>
    <span class="n">drop_sequence</span> <span class="o">=</span> <span class="n">return_parsed_node</span><span class="p">(</span><span class="s1">&#39;_drop_sequence&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SqliteQueryCompiler</span><span class="p">(</span><span class="n">QueryCompiler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">truncate_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">restart_identity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">cascade</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">model_class</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span><span class="o">.</span><span class="n">sql</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">ResultIterator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qrw</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qrw</span> <span class="o">=</span> <span class="n">qrw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">qrw</span><span class="o">.</span><span class="n">_ct</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qrw</span><span class="o">.</span><span class="n">_result_cache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_idx</span><span class="p">]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">qrw</span><span class="o">.</span><span class="n">_populated</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qrw</span><span class="o">.</span><span class="n">iterate</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qrw</span><span class="o">.</span><span class="n">_result_cache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qrw</span><span class="o">.</span><span class="n">_ct</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">obj</span>
    <span class="fm">__next__</span> <span class="o">=</span> <span class="nb">next</span>


<span class="k">class</span> <span class="nc">QueryResultWrapper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provides an iterator over the results of a raw Query, additionally doing</span>
<span class="sd">    two things:</span>
<span class="sd">    - converts rows from the database into python representations</span>
<span class="sd">    - ensures that multiple iterations do not result in multiple queries</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="n">cursor</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_result_cache</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_populated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">meta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_meta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_meta</span> <span class="o">=</span> <span class="n">meta</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_meta</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_populated</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_result_cache</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ResultIterator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_cache</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ct</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span>

    <span class="k">def</span> <span class="nf">process_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">row</span>

    <span class="k">def</span> <span class="nf">iterate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_populated</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_row</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterate</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ct</span><span class="p">:</span>
            <span class="n">inst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_cache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_idx</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">inst</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_populated</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result_cache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ct</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">obj</span>
    <span class="fm">__next__</span> <span class="o">=</span> <span class="nb">next</span>

    <span class="k">def</span> <span class="nf">fill_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="ow">or</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;Inf&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Negative values are not supported.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ct</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_populated</span> <span class="ow">and</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ct</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">break</span>

<span class="k">class</span> <span class="nc">ExtQueryResultWrapper</span><span class="p">(</span><span class="n">QueryResultWrapper</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">conv</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_meta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_meta</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_meta</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_meta</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_by_name</span><span class="p">(</span><span class="n">description</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n_cols</span> <span class="o">==</span> <span class="n">n_meta</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_by_name</span><span class="p">(</span><span class="n">description</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_initialize_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="n">model_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">model_cols</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">model_cols</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">python_value</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_initialize_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Field</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">_alias</span> <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">python_value</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Func</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">arguments</span><span class="p">):</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Field</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">_alias</span> <span class="ow">or</span> <span class="n">arg</span><span class="o">.</span><span class="n">_alias</span> <span class="ow">or</span> <span class="n">arg</span><span class="o">.</span><span class="n">name</span>
                <span class="n">func</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">_coerce</span> <span class="ow">and</span> <span class="n">arg</span><span class="o">.</span><span class="n">python_value</span> <span class="ow">or</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="k">class</span> <span class="nc">TuplesQueryResultWrapper</span><span class="p">(</span><span class="n">ExtQueryResultWrapper</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">process_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">col</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">](</span><span class="n">col</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">)])</span>

<span class="k">if</span> <span class="n">_TuplesQueryResultWrapper</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">_TuplesQueryResultWrapper</span> <span class="o">=</span> <span class="n">TuplesQueryResultWrapper</span>

<span class="k">class</span> <span class="nc">NaiveQueryResultWrapper</span><span class="p">(</span><span class="n">ExtQueryResultWrapper</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">process_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">_prepare_instance</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">instance</span>

<span class="k">if</span> <span class="n">_ModelQueryResultWrapper</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">_ModelQueryResultWrapper</span> <span class="o">=</span> <span class="n">NaiveQueryResultWrapper</span>

<span class="k">class</span> <span class="nc">DictQueryResultWrapper</span><span class="p">(</span><span class="n">ExtQueryResultWrapper</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">process_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">res</span>

<span class="k">if</span> <span class="n">_DictQueryResultWrapper</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">_DictQueryResultWrapper</span> <span class="o">=</span> <span class="n">DictQueryResultWrapper</span>

<span class="k">class</span> <span class="nc">NamedTupleQueryResultWrapper</span><span class="p">(</span><span class="n">ExtQueryResultWrapper</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NamedTupleQueryResultWrapper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constructor</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Row&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">process_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">constructor</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">f</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                                  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">ModelQueryResultWrapper</span><span class="p">(</span><span class="n">QueryResultWrapper</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_map</span><span class="p">,</span> <span class="n">model_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_column_map</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_col_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_meta</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">Field</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">join_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_join_list</span><span class="p">(</span><span class="n">model_set</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">generate_column_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">column_map</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">models</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_meta</span><span class="p">):</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">conv</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Field</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">FieldProxy</span><span class="p">):</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">_model_alias</span>
                    <span class="n">constructor</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">model</span>
                    <span class="n">conv</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">field_instance</span><span class="o">.</span><span class="n">python_value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">constructor</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">model_class</span>
                    <span class="n">conv</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">python_value</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">_alias</span> <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">_bind_to</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">constructor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">constructor</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">_bind_to</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Node</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">_alias</span><span class="p">:</span>
                    <span class="n">attr</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">_alias</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Entity</span><span class="p">):</span>
                    <span class="n">attr</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">column_map</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">constructor</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">conv</span><span class="p">))</span>
            <span class="n">models</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">column_map</span><span class="p">,</span> <span class="n">models</span>

    <span class="k">def</span> <span class="nf">generate_join_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">):</span>
        <span class="n">join_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">joins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_meta</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">current</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">joins</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">join</span> <span class="ow">in</span> <span class="n">joins</span><span class="p">[</span><span class="n">current</span><span class="p">]:</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">join</span><span class="o">.</span><span class="n">metadata</span>
                <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">dest</span> <span class="ow">in</span> <span class="n">models</span> <span class="ow">or</span> <span class="n">metadata</span><span class="o">.</span><span class="n">dest_model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">foreign_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">fk_present</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">foreign_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col_set</span>
                        <span class="n">pk_present</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col_set</span>
                        <span class="n">check</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">foreign_key</span><span class="o">.</span><span class="n">null</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fk_present</span> <span class="ow">or</span>
                                                               <span class="n">pk_present</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">check</span> <span class="o">=</span> <span class="n">fk_present</span> <span class="o">=</span> <span class="n">pk_present</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="n">join_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                        <span class="n">metadata</span><span class="p">,</span>
                        <span class="n">check</span><span class="p">,</span>
                        <span class="n">fk_present</span><span class="p">,</span>
                        <span class="n">pk_present</span><span class="p">))</span>
                    <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">join</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">join_list</span>

    <span class="k">def</span> <span class="nf">process_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">collected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_instances</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">follow_joins</span><span class="p">(</span><span class="n">collected</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
            <span class="n">i</span><span class="o">.</span><span class="n">_prepare_instance</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">instances</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">construct_instances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">collected_models</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">constructor</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">conv</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_map</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">collected_models</span><span class="p">:</span>
                <span class="n">collected_models</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">constructor</span><span class="p">()</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="n">collected_models</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">description</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="k">if</span> <span class="n">conv</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">conv</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">collected_models</span>

    <span class="k">def</span> <span class="nf">follow_joins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collected</span><span class="p">):</span>
        <span class="n">prepared</span> <span class="o">=</span> <span class="p">[</span><span class="n">collected</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">]]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">check_null</span><span class="p">,</span> <span class="n">fk_present</span><span class="p">,</span> <span class="n">pk_present</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_list</span><span class="p">:</span>
            <span class="n">inst</span> <span class="o">=</span> <span class="n">collected</span><span class="p">[</span><span class="n">metadata</span><span class="o">.</span><span class="n">src</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">joined_inst</span> <span class="o">=</span> <span class="n">collected</span><span class="p">[</span><span class="n">metadata</span><span class="o">.</span><span class="n">dest</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">joined_inst</span> <span class="o">=</span> <span class="n">collected</span><span class="p">[</span><span class="n">metadata</span><span class="o">.</span><span class="n">dest_model</span><span class="p">]</span>

            <span class="n">has_fk</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">check_null</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fk_present</span><span class="p">:</span>
                    <span class="n">has_fk</span> <span class="o">=</span> <span class="n">inst</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">foreign_key</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">pk_present</span><span class="p">:</span>
                    <span class="n">has_fk</span> <span class="o">=</span> <span class="n">joined_inst</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_fk</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Can we populate a value on the joined instance using the current?</span>
            <span class="n">mpk</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">can_populate_joined_pk</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">mpk</span> <span class="ow">and</span>
                <span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">attr</span> <span class="ow">in</span> <span class="n">inst</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span> <span class="ow">and</span>
                <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">joined_inst</span><span class="p">,</span> <span class="n">metadata</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">can_populate_joined_pk</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span>
                    <span class="n">joined_inst</span><span class="p">,</span>
                    <span class="n">metadata</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">inst</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">metadata</span><span class="o">.</span><span class="n">attr</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">is_backref</span><span class="p">:</span>
                <span class="n">can_populate_joined_fk</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">mpk</span> <span class="ow">and</span>
                    <span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">foreign_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">metadata</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="p">(</span><span class="n">joined_inst</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">foreign_key</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">can_populate_joined_fk</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span>
                        <span class="n">joined_inst</span><span class="p">,</span>
                        <span class="n">metadata</span><span class="o">.</span><span class="n">foreign_key</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">inst</span><span class="p">)</span>

            <span class="nb">setattr</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">metadata</span><span class="o">.</span><span class="n">attr</span><span class="p">,</span> <span class="n">joined_inst</span><span class="p">)</span>
            <span class="n">prepared</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">joined_inst</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">prepared</span>


<span class="n">JoinCache</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;JoinCache&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="s1">&#39;attr&#39;</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">AggregateQueryResultWrapper</span><span class="p">(</span><span class="n">ModelQueryResultWrapper</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_row</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AggregateQueryResultWrapper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AggregateQueryResultWrapper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>

        <span class="c1"># Collect the set of all models (and ModelAlias objects) queried.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_models</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_map</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_models</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="c1"># Prepare data structures for analyzing unique rows. Also cache</span>
        <span class="c1"># foreign key and attribute names for joined models.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models_with_aggregate</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">back_references</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_to_dest</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dest_to_source</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">is_backref</span><span class="p">:</span>
                <span class="n">att_name</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">foreign_key</span><span class="o">.</span><span class="n">related_name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">att_name</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">attr</span>

            <span class="n">is_backref</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">is_backref</span> <span class="ow">or</span> <span class="n">metadata</span><span class="o">.</span><span class="n">is_self_join</span>
            <span class="k">if</span> <span class="n">is_backref</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">models_with_aggregate</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">src</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dest_to_source</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">dest</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dest_to_source</span><span class="p">[</span><span class="n">metadata</span><span class="o">.</span><span class="n">dest</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">src</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">source_to_dest</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="p">{})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source_to_dest</span><span class="p">[</span><span class="n">metadata</span><span class="o">.</span><span class="n">src</span><span class="p">][</span><span class="n">metadata</span><span class="o">.</span><span class="n">dest</span><span class="p">]</span> <span class="o">=</span> <span class="n">JoinCache</span><span class="p">(</span>
                <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
                <span class="n">attr</span><span class="o">=</span><span class="n">metadata</span><span class="o">.</span><span class="n">alias</span> <span class="ow">or</span> <span class="n">att_name</span><span class="p">)</span>

        <span class="c1"># Determine which columns could contain &quot;duplicate&quot; data, e.g. if</span>
        <span class="c1"># getting Users and their Tweets, this would be the User columns.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns_to_compare</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">key_to_columns</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_map</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models_with_aggregate</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">columns_to_compare</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">columns_to_compare</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">idx</span><span class="p">,</span> <span class="n">col_name</span><span class="p">))</span>

            <span class="n">key_to_columns</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">key_to_columns</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">idx</span><span class="p">,</span> <span class="n">col_name</span><span class="p">))</span>

        <span class="c1"># Also compare columns for joins -&gt; many-related model.</span>
        <span class="k">for</span> <span class="n">model_or_alias</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models_with_aggregate</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model_or_alias</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns_to_compare</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest_to_source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model_or_alias</span><span class="p">,</span> <span class="p">())</span>
            <span class="k">for</span> <span class="n">joined_model</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">columns_to_compare</span><span class="p">[</span><span class="n">model_or_alias</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="n">key_to_columns</span><span class="p">[</span><span class="n">joined_model</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">read_model_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">column_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns_to_compare</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">models</span><span class="p">[</span><span class="n">model_class</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">column_data</span><span class="p">:</span>
                <span class="n">models</span><span class="p">[</span><span class="n">model_class</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">models</span>

    <span class="k">def</span> <span class="nf">iterate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_populated</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">def</span> <span class="nf">_get_pk</span><span class="p">(</span><span class="n">instance</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">composite_key</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">tuple</span><span class="p">([</span>
                    <span class="n">instance</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">instance</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">field_names</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">instance</span><span class="o">.</span><span class="n">_get_pk_value</span><span class="p">()</span>

        <span class="n">identity_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">_constructed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_instances</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">primary_instance</span> <span class="o">=</span> <span class="n">_constructed</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">model_or_alias</span><span class="p">,</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">_constructed</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">identity_map</span><span class="p">[</span><span class="n">model_or_alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="n">identity_map</span><span class="p">[</span><span class="n">model_or_alias</span><span class="p">][</span><span class="n">_get_pk</span><span class="p">(</span><span class="n">instance</span><span class="p">)]</span> <span class="o">=</span> <span class="n">instance</span>

        <span class="n">model_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_model_data</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">cur_row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cur_row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">duplicate_models</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">cur_row_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_model_data</span><span class="p">(</span><span class="n">cur_row</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">cur_row_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">model_data</span><span class="p">[</span><span class="n">model_class</span><span class="p">]</span> <span class="o">==</span> <span class="n">data</span><span class="p">:</span>
                    <span class="n">duplicate_models</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model_class</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">duplicate_models</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur_row</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="n">different_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_models</span> <span class="o">-</span> <span class="n">duplicate_models</span>

            <span class="n">new_instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_instances</span><span class="p">(</span><span class="n">cur_row</span><span class="p">,</span> <span class="n">different_models</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">model_or_alias</span><span class="p">,</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">new_instances</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Do not include any instances which are comprised solely of</span>
                <span class="c1"># NULL values.</span>
                <span class="n">all_none</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">instance</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">all_none</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">all_none</span><span class="p">:</span>
                    <span class="n">identity_map</span><span class="p">[</span><span class="n">model_or_alias</span><span class="p">][</span><span class="n">_get_pk</span><span class="p">(</span><span class="n">instance</span><span class="p">)]</span> <span class="o">=</span> <span class="n">instance</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">]</span>
        <span class="n">instances</span> <span class="o">=</span> <span class="p">[</span><span class="n">primary_instance</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">current</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_meta</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">join</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_meta</span><span class="p">[</span><span class="n">current</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metadata</span><span class="p">,</span> <span class="n">attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_to_dest</span><span class="p">[</span><span class="n">current</span><span class="p">][</span><span class="n">join</span><span class="o">.</span><span class="n">dest</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">is_backref</span> <span class="ow">or</span> <span class="n">metadata</span><span class="o">.</span><span class="n">is_self_join</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">identity_map</span><span class="p">[</span><span class="n">current</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="p">[])</span>

                    <span class="k">if</span> <span class="n">join</span><span class="o">.</span><span class="n">dest</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">identity_map</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="k">for</span> <span class="n">pk</span><span class="p">,</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">identity_map</span><span class="p">[</span><span class="n">join</span><span class="o">.</span><span class="n">dest</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">pk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># XXX: if no FK exists, unable to join.</span>
                            <span class="n">joined_inst</span> <span class="o">=</span> <span class="n">identity_map</span><span class="p">[</span><span class="n">current</span><span class="p">][</span>
                                <span class="n">inst</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">metadata</span><span class="o">.</span><span class="n">foreign_key</span><span class="o">.</span><span class="n">name</span><span class="p">]]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="nb">getattr</span><span class="p">(</span><span class="n">joined_inst</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>
                        <span class="n">instances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">attr</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">join</span><span class="o">.</span><span class="n">dest</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">identity_map</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="k">for</span> <span class="n">pk</span><span class="p">,</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">identity_map</span><span class="p">[</span><span class="n">current</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="c1"># XXX: if no FK exists, unable to join.</span>
                        <span class="n">joined_inst</span> <span class="o">=</span> <span class="n">identity_map</span><span class="p">[</span><span class="n">join</span><span class="o">.</span><span class="n">dest</span><span class="p">][</span>
                            <span class="n">instance</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">metadata</span><span class="o">.</span><span class="n">foreign_key</span><span class="o">.</span><span class="n">name</span><span class="p">]]</span>
                        <span class="nb">setattr</span><span class="p">(</span>
                            <span class="n">instance</span><span class="p">,</span>
                            <span class="n">metadata</span><span class="o">.</span><span class="n">foreign_key</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">joined_inst</span><span class="p">)</span>
                        <span class="n">instances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">joined_inst</span><span class="p">)</span>

                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">join</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">_prepare_instance</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">primary_instance</span>


<span class="k">class</span> <span class="nc">Query</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class representing a database query on one or more tables.&quot;&quot;&quot;</span>
    <span class="n">require_commit</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Query</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span> <span class="o">=</span> <span class="n">model_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_query_ctx</span> <span class="o">=</span> <span class="n">model_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_joins</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="p">:</span> <span class="p">[]}</span>  <span class="c1"># Join graph as adjacency list.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_where</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql</span><span class="p">()</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone_attributes</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clone_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span><span class="o">.</span><span class="n">_where</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_where</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_joins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone_joins</span><span class="p">()</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_query_ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_ctx</span>
        <span class="k">return</span> <span class="n">query</span>

    <span class="k">def</span> <span class="nf">_clone_joins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="p">(</span><span class="n">mc</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">j</span><span class="p">))</span> <span class="k">for</span> <span class="n">mc</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_joins</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_add_query_clauses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial</span><span class="p">,</span> <span class="n">expressions</span><span class="p">,</span> <span class="n">conjunction</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">reduced</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">and_</span><span class="p">,</span> <span class="n">expressions</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">initial</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">reduced</span>
        <span class="n">conjunction</span> <span class="o">=</span> <span class="n">conjunction</span> <span class="ow">or</span> <span class="n">operator</span><span class="o">.</span><span class="n">and_</span>
        <span class="k">return</span> <span class="n">conjunction</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="n">reduced</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_model_shorthand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">accum</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
                <span class="n">accum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Query</span><span class="p">):</span>
                <span class="n">accum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">ModelAlias</span><span class="p">):</span>
                <span class="n">accum</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">get_proxy_fields</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">isclass</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
                <span class="n">accum</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">declared_fields</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">accum</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">where</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">expressions</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_where</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_query_clauses</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_where</span><span class="p">,</span> <span class="n">expressions</span><span class="p">)</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">orwhere</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">expressions</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_where</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_query_clauses</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_where</span><span class="p">,</span> <span class="n">expressions</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="n">or_</span><span class="p">)</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">join_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_ctx</span>
        <span class="k">if</span> <span class="n">on</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">require_join_condition</span> <span class="o">=</span> <span class="n">join_type</span> <span class="o">!=</span> <span class="n">JOIN</span><span class="o">.</span><span class="n">CROSS</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">SelectQuery</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">isclass</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">src</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">rel_exists</span><span class="p">(</span><span class="n">dest</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">require_join_condition</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;A join condition must be specified.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">join_type</span> <span class="o">==</span> <span class="n">JOIN</span><span class="o">.</span><span class="n">CROSS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;A CROSS join cannot have a constraint.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">on</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="n">on</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">on</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_joins</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_joins</span><span class="p">[</span><span class="n">src</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">join_type</span><span class="p">,</span> <span class="n">on</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">SelectQuery</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_query_ctx</span> <span class="o">=</span> <span class="n">dest</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">switch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change or reset the query context.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_query_ctx</span> <span class="o">=</span> <span class="n">model_class</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span>

    <span class="k">def</span> <span class="nf">ensure_join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">rm</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">join_kwargs</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_ctx</span>
        <span class="k">for</span> <span class="n">join</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_joins</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lm</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="n">join</span><span class="o">.</span><span class="n">dest</span> <span class="o">==</span> <span class="n">rm</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">lm</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rm</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">on</span><span class="p">,</span> <span class="o">**</span><span class="n">join_kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">convert_dict_to_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qdict</span><span class="p">):</span>
        <span class="n">accum</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">joins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">relationship</span> <span class="o">=</span> <span class="p">(</span><span class="n">ForeignKeyField</span><span class="p">,</span> <span class="n">ReverseRelationDescriptor</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">qdict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span>
            <span class="k">if</span> <span class="s1">&#39;__&#39;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">key</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">DJANGO_MAP</span><span class="p">:</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">op</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">op</span> <span class="o">=</span> <span class="n">DJANGO_MAP</span><span class="p">[</span><span class="n">op</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">op</span> <span class="o">=</span> <span class="n">OP</span><span class="o">.</span><span class="n">IS</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">op</span> <span class="o">=</span> <span class="n">OP</span><span class="o">.</span><span class="n">EQ</span>
            <span class="k">for</span> <span class="n">piece</span> <span class="ow">in</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">):</span>
                <span class="n">model_attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="n">piece</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_attr</span><span class="p">,</span> <span class="n">relationship</span><span class="p">):</span>
                    <span class="n">curr</span> <span class="o">=</span> <span class="n">model_attr</span><span class="o">.</span><span class="n">rel_model</span>
                    <span class="n">joins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_attr</span><span class="p">)</span>
            <span class="n">accum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Expression</span><span class="p">(</span><span class="n">model_attr</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">accum</span><span class="p">,</span> <span class="n">joins</span>

    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># normalize args and kwargs into a new expression</span>
        <span class="n">dq_node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">dq_node</span> <span class="o">&amp;=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">and_</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">dq_node</span> <span class="o">&amp;=</span> <span class="n">DQ</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># dq_node should now be an Expression, lhs = Node(), rhs = ...</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">deque</span><span class="p">([</span><span class="n">dq_node</span><span class="p">])</span>
        <span class="n">dq_joins</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">q</span><span class="p">:</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="n">Expression</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">side</span><span class="p">,</span> <span class="n">piece</span> <span class="ow">in</span> <span class="p">((</span><span class="s1">&#39;lhs&#39;</span><span class="p">,</span> <span class="n">curr</span><span class="o">.</span><span class="n">lhs</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;rhs&#39;</span><span class="p">,</span> <span class="n">curr</span><span class="o">.</span><span class="n">rhs</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">piece</span><span class="p">,</span> <span class="n">DQ</span><span class="p">):</span>
                    <span class="n">query</span><span class="p">,</span> <span class="n">joins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_dict_to_node</span><span class="p">(</span><span class="n">piece</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
                    <span class="n">dq_joins</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">joins</span><span class="p">)</span>
                    <span class="n">expression</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">and_</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
                    <span class="c1"># Apply values from the DQ object.</span>
                    <span class="n">expression</span><span class="o">.</span><span class="n">_negated</span> <span class="o">=</span> <span class="n">piece</span><span class="o">.</span><span class="n">_negated</span>
                    <span class="n">expression</span><span class="o">.</span><span class="n">_alias</span> <span class="o">=</span> <span class="n">piece</span><span class="o">.</span><span class="n">_alias</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">piece</span><span class="p">)</span>

        <span class="n">dq_node</span> <span class="o">=</span> <span class="n">dq_node</span><span class="o">.</span><span class="n">rhs</span>

        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">dq_joins</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">ForeignKeyField</span><span class="p">):</span>
                <span class="n">lm</span><span class="p">,</span> <span class="n">rm</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">model_class</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">rel_model</span>
                <span class="n">field_obj</span> <span class="o">=</span> <span class="n">field</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">ReverseRelationDescriptor</span><span class="p">):</span>
                <span class="n">lm</span><span class="p">,</span> <span class="n">rm</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">rel_model</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">rel_model</span>
                <span class="n">field_obj</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">field</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">ensure_join</span><span class="p">(</span><span class="n">lm</span><span class="p">,</span> <span class="n">rm</span><span class="p">,</span> <span class="n">field_obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dq_node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compiler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">compiler</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">sql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_commit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">scalar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">as_tuple</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">convert</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">convert</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuples</span><span class="p">()</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">()</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">row</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">as_tuple</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">row</span>

<span class="k">class</span> <span class="nc">RawQuery</span><span class="p">(</span><span class="n">Query</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute a SQL query, returning a standard iterable interface that returns</span>
<span class="sd">    model instances.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sql</span> <span class="o">=</span> <span class="n">query</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_qr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tuples</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dicts</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RawQuery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">RawQuery</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_tuples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tuples</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_dicts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dicts</span>
        <span class="k">return</span> <span class="n">query</span>

    <span class="n">join</span> <span class="o">=</span> <span class="n">not_allowed</span><span class="p">(</span><span class="s1">&#39;joining&#39;</span><span class="p">)</span>
    <span class="n">where</span> <span class="o">=</span> <span class="n">not_allowed</span><span class="p">(</span><span class="s1">&#39;where&#39;</span><span class="p">)</span>
    <span class="n">switch</span> <span class="o">=</span> <span class="n">not_allowed</span><span class="p">(</span><span class="s1">&#39;switch&#39;</span><span class="p">)</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">tuples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tuples</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tuples</span> <span class="o">=</span> <span class="n">tuples</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">dicts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dicts</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dicts</span> <span class="o">=</span> <span class="n">dicts</span>

    <span class="k">def</span> <span class="nf">sql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tuples</span><span class="p">:</span>
                <span class="n">QRW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_result_wrapper</span><span class="p">(</span><span class="n">RESULTS_TUPLES</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dicts</span><span class="p">:</span>
                <span class="n">QRW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_result_wrapper</span><span class="p">(</span><span class="n">RESULTS_DICTS</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">QRW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_result_wrapper</span><span class="p">(</span><span class="n">RESULTS_NAIVE</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_qr</span> <span class="o">=</span> <span class="n">QRW</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">(),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qr</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">allow_extend</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">new_val</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">extend</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;extend&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;&quot;extend&quot; is the only valid keyword argument.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">extend</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">((</span><span class="n">orig</span> <span class="ow">or</span> <span class="p">[])</span> <span class="o">+</span> <span class="n">new_val</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">new_val</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">new_val</span>

<span class="k">class</span> <span class="nc">SelectQuery</span><span class="p">(</span><span class="n">Query</span><span class="p">):</span>
    <span class="n">_node_type</span> <span class="o">=</span> <span class="s1">&#39;select_query&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="o">*</span><span class="n">selection</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SelectQuery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_class</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_commit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">commit_select</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__select</span><span class="p">(</span><span class="o">*</span><span class="n">selection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_from</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group_by</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_having</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_order_by</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_windows</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_distinct</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_for_update</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_naive</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tuples</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dicts</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_namedtuples</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_rows</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_qr</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_clone_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">SelectQuery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_clone_attributes</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_explicit_selection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_explicit_selection</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_select</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_select</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span><span class="o">.</span><span class="n">_from</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
                    <span class="n">query</span><span class="o">.</span><span class="n">_from</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">query</span><span class="o">.</span><span class="n">_from</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span><span class="o">.</span><span class="n">_group_by</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_by</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_having</span><span class="p">:</span>
            <span class="n">query</span><span class="o">.</span><span class="n">_having</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_having</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span><span class="o">.</span><span class="n">_order_by</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_order_by</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_windows</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span><span class="o">.</span><span class="n">_windows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_windows</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_distinct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distinct</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_for_update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_for_update</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_naive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_naive</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_tuples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tuples</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_dicts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dicts</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_namedtuples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_namedtuples</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_aggregate_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_rows</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span>
        <span class="k">return</span> <span class="n">query</span>

    <span class="k">def</span> <span class="nf">compound_op</span><span class="p">(</span><span class="n">operator</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
            <span class="n">supported_ops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">compound_operations</span>
            <span class="k">if</span> <span class="n">operator</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">supported_ops</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Your database does not support </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">operator</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">CompoundSelect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inner</span>
    <span class="n">_compound_op_static</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">compound_op</span><span class="p">)</span>
    <span class="fm">__or__</span> <span class="o">=</span> <span class="n">compound_op</span><span class="p">(</span><span class="s1">&#39;UNION&#39;</span><span class="p">)</span>
    <span class="fm">__and__</span> <span class="o">=</span> <span class="n">compound_op</span><span class="p">(</span><span class="s1">&#39;INTERSECT&#39;</span><span class="p">)</span>
    <span class="fm">__sub__</span> <span class="o">=</span> <span class="n">compound_op</span><span class="p">(</span><span class="s1">&#39;EXCEPT&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__xor__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="c1"># Symmetric difference, should just be (self | rhs) - (self &amp; rhs)...</span>
        <span class="n">wrapped_rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">from_</span><span class="p">(</span>
            <span class="n">EnclosedClause</span><span class="p">((</span><span class="bp">self</span> <span class="o">&amp;</span> <span class="n">rhs</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span> <span class="o">|</span> <span class="n">rhs</span><span class="p">)</span> <span class="o">-</span> <span class="n">wrapped_rhs</span>

    <span class="k">def</span> <span class="nf">union_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SelectQuery</span><span class="o">.</span><span class="n">_compound_op_static</span><span class="p">(</span><span class="s1">&#39;UNION ALL&#39;</span><span class="p">)(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">selection</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_explicit_selection</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">declared_fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_select</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_shorthand</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
    <span class="n">select</span> <span class="o">=</span> <span class="n">returns_clone</span><span class="p">(</span><span class="n">__select</span><span class="p">)</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">from_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_from</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">group_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_shorthand</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">having</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">expressions</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_having</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_query_clauses</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_having</span><span class="p">,</span> <span class="n">expressions</span><span class="p">)</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">order_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_order_by</span> <span class="o">=</span> <span class="n">allow_extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_order_by</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">window</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">windows</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_windows</span> <span class="o">=</span> <span class="n">allow_extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_windows</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">windows</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lim</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="n">lim</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">off</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="n">off</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">paginate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">paginate_by</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="n">paginate_by</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="n">page</span> <span class="o">*</span> <span class="n">paginate_by</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">distinct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_distinct</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_distinct</span> <span class="o">=</span> <span class="n">is_distinct</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">for_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">for_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nowait</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_for_update</span> <span class="o">=</span> <span class="s1">&#39;FOR UPDATE NOWAIT&#39;</span> <span class="k">if</span> <span class="n">for_update</span> <span class="ow">and</span> <span class="n">nowait</span> <span class="k">else</span> \
                <span class="s1">&#39;FOR UPDATE&#39;</span> <span class="k">if</span> <span class="n">for_update</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">with_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lock_type</span><span class="o">=</span><span class="s1">&#39;UPDATE&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_for_update</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;FOR </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">lock_type</span><span class="p">)</span> <span class="k">if</span> <span class="n">lock_type</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">naive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">naive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_naive</span> <span class="o">=</span> <span class="n">naive</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">tuples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tuples</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tuples</span> <span class="o">=</span> <span class="n">tuples</span>
        <span class="k">if</span> <span class="n">tuples</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dicts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_namedtuples</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">dicts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dicts</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dicts</span> <span class="o">=</span> <span class="n">dicts</span>
        <span class="k">if</span> <span class="n">dicts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tuples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_namedtuples</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">namedtuples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">namedtuples</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_namedtuples</span> <span class="o">=</span> <span class="n">namedtuples</span>
        <span class="k">if</span> <span class="n">namedtuples</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dicts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tuples</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">aggregate_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregate_rows</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_rows</span> <span class="o">=</span> <span class="n">aggregate_rows</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span> <span class="o">=</span> <span class="n">alias</span>

    <span class="k">def</span> <span class="nf">annotate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel_model</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">annotation</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">Count</span><span class="p">(</span><span class="n">rel_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_ctx</span> <span class="o">==</span> <span class="n">rel_model</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">ensure_join</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">_query_ctx</span><span class="p">,</span> <span class="n">rel_model</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span><span class="o">.</span><span class="n">_group_by</span><span class="p">:</span>
            <span class="n">query</span><span class="o">.</span><span class="n">_group_by</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">_select</span><span class="p">]</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_select</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">_select</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">annotation</span><span class="p">,)</span>
        <span class="k">return</span> <span class="n">query</span>

    <span class="k">def</span> <span class="nf">_aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">aggregation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">aggregation</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">Count</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">))</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span><span class="p">()</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_select</span> <span class="o">=</span> <span class="p">[</span><span class="n">aggregation</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">query</span>

    <span class="k">def</span> <span class="nf">aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">convert</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate</span><span class="p">(</span><span class="n">aggregation</span><span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="n">convert</span><span class="o">=</span><span class="n">convert</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clear_limit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distinct</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_by</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrapped_count</span><span class="p">(</span><span class="n">clear_limit</span><span class="o">=</span><span class="n">clear_limit</span><span class="p">)</span>

        <span class="c1"># defaults to a count() of the primary key</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">convert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">wrapped_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clear_limit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">clone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">clear_limit</span><span class="p">:</span>
            <span class="n">clone</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="n">clone</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">clone</span><span class="o">.</span><span class="n">sql</span><span class="p">()</span>
        <span class="n">wrapped</span> <span class="o">=</span> <span class="s1">&#39;SELECT COUNT(1) FROM (</span><span class="si">%s</span><span class="s1">) AS wrapped_select&#39;</span> <span class="o">%</span> <span class="n">sql</span>
        <span class="n">rq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">wrapped</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rq</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">clone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">clone</span><span class="o">.</span><span class="n">_select</span> <span class="o">=</span> <span class="p">[</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)]</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">clone</span><span class="o">.</span><span class="n">scalar</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">clone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">clone</span><span class="o">.</span><span class="n">execute</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">(</span>
                <span class="s1">&#39;Instance matching query does not exist:</span><span class="se">\n</span><span class="s1">SQL: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">PARAMS: </span><span class="si">%s</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">peek</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="n">res</span><span class="o">.</span><span class="n">fill_cache</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">models</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">_result_cache</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">models</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">models</span>

    <span class="k">def</span> <span class="nf">first</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span> <span class="o">!=</span> <span class="n">n</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="n">n</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">peek</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">sql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="p">()</span><span class="o">.</span><span class="n">generate_select</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">verify_naive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">model_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Field</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">model_class</span> <span class="o">!=</span> <span class="n">model_class</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Node</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">_bind_to</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">_bind_to</span> <span class="o">!=</span> <span class="n">model_class</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">get_query_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_select</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_joins</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_result_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tuples</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_result_wrapper</span><span class="p">(</span><span class="n">RESULTS_TUPLES</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dicts</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_result_wrapper</span><span class="p">(</span><span class="n">RESULTS_DICTS</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_namedtuples</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_result_wrapper</span><span class="p">(</span><span class="n">RESULTS_NAMEDTUPLES</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_naive</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_joins</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_naive</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_result_wrapper</span><span class="p">(</span><span class="n">RESULTS_NAIVE</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_rows</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_result_wrapper</span><span class="p">(</span><span class="n">RESULTS_AGGREGATE_MODELS</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_result_wrapper</span><span class="p">(</span><span class="n">RESULTS_MODELS</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span>
            <span class="n">query_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_query_meta</span><span class="p">()</span>
            <span class="n">ResultWrapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_result_wrapper</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_qr</span> <span class="o">=</span> <span class="n">ResultWrapper</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">(),</span> <span class="n">query_meta</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qr</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span><span class="o">.</span><span class="n">iterator</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">stop</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">res</span><span class="o">.</span><span class="n">fill_cache</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">_result_cache</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">NoopSelectQuery</span><span class="p">(</span><span class="n">SelectQuery</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">sql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_noop_sql</span><span class="p">(),</span> <span class="p">())</span>

    <span class="k">def</span> <span class="nf">get_query_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_result_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_result_wrapper</span><span class="p">(</span><span class="n">RESULTS_TUPLES</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">CompoundSelect</span><span class="p">(</span><span class="n">SelectQuery</span><span class="p">):</span>
    <span class="n">_node_type</span> <span class="o">=</span> <span class="s1">&#39;compound_select_query&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">lhs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rhs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span> <span class="o">=</span> <span class="n">lhs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operator</span> <span class="o">=</span> <span class="n">operator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span> <span class="o">=</span> <span class="n">rhs</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CompoundSelect</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">def</span> <span class="nf">_clone_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CompoundSelect</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_clone_attributes</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span>
        <span class="n">query</span><span class="o">.</span><span class="n">operator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span>
        <span class="n">query</span><span class="o">.</span><span class="n">rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span>
        <span class="k">return</span> <span class="n">query</span>

    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clear_limit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrapped_count</span><span class="p">(</span><span class="n">clear_limit</span><span class="o">=</span><span class="n">clear_limit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_query_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">get_query_meta</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">verify_naive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">verify_naive</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="o">.</span><span class="n">verify_naive</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_result_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tuples</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_result_wrapper</span><span class="p">(</span><span class="n">RESULTS_TUPLES</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dicts</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_result_wrapper</span><span class="p">(</span><span class="n">RESULTS_DICTS</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_namedtuples</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_result_wrapper</span><span class="p">(</span><span class="n">RESULTS_NAMEDTUPLES</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_rows</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_result_wrapper</span><span class="p">(</span><span class="n">RESULTS_AGGREGATE_MODELS</span><span class="p">)</span>

        <span class="n">has_joins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">_joins</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="o">.</span><span class="n">_joins</span>
        <span class="n">is_naive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">_naive</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="o">.</span><span class="n">_naive</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_naive</span>
        <span class="k">if</span> <span class="n">is_naive</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">has_joins</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_naive</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_result_wrapper</span><span class="p">(</span><span class="n">RESULTS_NAIVE</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_result_wrapper</span><span class="p">(</span><span class="n">RESULTS_MODELS</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">_WriteQuery</span><span class="p">(</span><span class="n">Query</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_returning</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tuples</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dicts</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_namedtuples</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_qr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_WriteQuery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_class</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clone_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">_WriteQuery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_clone_attributes</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_returning</span><span class="p">:</span>
            <span class="n">query</span><span class="o">.</span><span class="n">_returning</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_returning</span><span class="p">)</span>
            <span class="n">query</span><span class="o">.</span><span class="n">_tuples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tuples</span>
            <span class="n">query</span><span class="o">.</span><span class="n">_dicts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dicts</span>
            <span class="n">query</span><span class="o">.</span><span class="n">_namedtuples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_namedtuples</span>
        <span class="k">return</span> <span class="n">query</span>

    <span class="k">def</span> <span class="nf">requires_returning</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="o">.</span><span class="n">returning_clause</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;RETURNING is not supported by your &#39;</span>
                                 <span class="s1">&#39;database: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inner</span>

    <span class="nd">@requires_returning</span>
    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">returning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">selection</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">selection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_returning</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">selection</span><span class="p">:</span>
                <span class="n">selection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">declared_fields</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_returning</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_shorthand</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>

    <span class="nd">@requires_returning</span>
    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">tuples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tuples</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tuples</span> <span class="o">=</span> <span class="n">tuples</span>
        <span class="k">if</span> <span class="n">tuples</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dicts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_namedtuples</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@requires_returning</span>
    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">dicts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dicts</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dicts</span> <span class="o">=</span> <span class="n">dicts</span>
        <span class="k">if</span> <span class="n">dicts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tuples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_namedtuples</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@requires_returning</span>
    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">namedtuples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">namedtuples</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_namedtuples</span> <span class="o">=</span> <span class="n">namedtuples</span>
        <span class="k">if</span> <span class="n">namedtuples</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dicts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tuples</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">get_result_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_returning</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tuples</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_result_wrapper</span><span class="p">(</span><span class="n">RESULTS_TUPLES</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dicts</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_result_wrapper</span><span class="p">(</span><span class="n">RESULTS_DICTS</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_namedtuples</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_result_wrapper</span><span class="p">(</span><span class="n">RESULTS_NAMEDTUPLES</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_result_wrapper</span><span class="p">(</span><span class="n">RESULTS_NAIVE</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_with_result_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ResultWrapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_result_wrapper</span><span class="p">()</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_returning</span><span class="p">,</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="p">:</span> <span class="p">[]})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_qr</span> <span class="o">=</span> <span class="n">ResultWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">(),</span> <span class="n">meta</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qr</span>


<span class="k">class</span> <span class="nc">UpdateQuery</span><span class="p">(</span><span class="n">_WriteQuery</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span> <span class="o">=</span> <span class="n">update</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_on_conflict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">UpdateQuery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_class</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clone_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">UpdateQuery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_clone_attributes</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_update</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_on_conflict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_conflict</span>
        <span class="k">return</span> <span class="n">query</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">on_conflict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_on_conflict</span> <span class="o">=</span> <span class="n">action</span>

    <span class="n">join</span> <span class="o">=</span> <span class="n">not_allowed</span><span class="p">(</span><span class="s1">&#39;joining&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">sql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="p">()</span><span class="o">.</span><span class="n">generate_update</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_returning</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_with_result_wrapper</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">rows_affected</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">returning_clause</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;UPDATE queries cannot be iterated over unless &#39;</span>
                             <span class="s1">&#39;they specify a RETURNING clause, which is not &#39;</span>
                             <span class="s1">&#39;supported by your database.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span><span class="o">.</span><span class="n">iterator</span><span class="p">())</span>

<span class="k">class</span> <span class="nc">InsertQuery</span><span class="p">(</span><span class="n">_WriteQuery</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">field_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validate_fields</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">InsertQuery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_class</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_upsert</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_multi_row_insert</span> <span class="o">=</span> <span class="n">rows</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">query</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_return_id_list</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">rows</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rows</span> <span class="o">=</span> <span class="n">rows</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">field_dict</span> <span class="ow">or</span> <span class="p">{}]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span> <span class="o">=</span> <span class="n">fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_query</span> <span class="o">=</span> <span class="n">query</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_fields</span> <span class="o">=</span> <span class="n">validate_fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_on_conflict</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_iter_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">model_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_fields</span><span class="p">:</span>
            <span class="n">valid_fields</span> <span class="o">=</span> <span class="n">model_meta</span><span class="o">.</span><span class="n">valid_fields</span>
            <span class="k">def</span> <span class="nf">validate_field</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_fields</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot; is not a recognized field.&#39;</span> <span class="o">%</span> <span class="n">field</span><span class="p">)</span>

        <span class="n">defaults</span> <span class="o">=</span> <span class="n">model_meta</span><span class="o">.</span><span class="n">_default_dict</span>
        <span class="n">callables</span> <span class="o">=</span> <span class="n">model_meta</span><span class="o">.</span><span class="n">_default_callables</span>

        <span class="k">for</span> <span class="n">row_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rows</span><span class="p">:</span>
            <span class="n">field_row</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">row_dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_fields</span><span class="p">:</span>
                    <span class="n">validate_field</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">model_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                    <span class="n">field</span> <span class="o">=</span> <span class="n">model_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">field</span> <span class="o">=</span> <span class="n">key</span>
                <span class="n">field_row</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">row_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">callables</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">callables</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                        <span class="n">field_row</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">callables</span><span class="p">[</span><span class="n">field</span><span class="p">]()</span>
            <span class="k">yield</span> <span class="n">field_row</span>

    <span class="k">def</span> <span class="nf">_clone_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">InsertQuery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_clone_attributes</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rows</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_upsert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upsert</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_is_multi_row_insert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_multi_row_insert</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_return_id_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_id_list</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_validate_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_fields</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_on_conflict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_conflict</span>
        <span class="k">return</span> <span class="n">query</span>

    <span class="n">join</span> <span class="o">=</span> <span class="n">not_allowed</span><span class="p">(</span><span class="s1">&#39;joining&#39;</span><span class="p">)</span>
    <span class="n">where</span> <span class="o">=</span> <span class="n">not_allowed</span><span class="p">(</span><span class="s1">&#39;where clause&#39;</span><span class="p">)</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">upsert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">upsert</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_upsert</span> <span class="o">=</span> <span class="n">upsert</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">on_conflict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_on_conflict</span> <span class="o">=</span> <span class="n">action</span>

    <span class="nd">@returns_clone</span>
    <span class="k">def</span> <span class="nf">return_id_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_id_list</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_return_id_list</span> <span class="o">=</span> <span class="n">return_id_list</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_insert_returning</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">insert_returning</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_multi_row_insert</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_id_list</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">sql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="p">()</span><span class="o">.</span><span class="n">generate_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_insert_with_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">id_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">last_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">return_id_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_id_list</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rows</span><span class="p">:</span>
            <span class="n">last_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">InsertQuery</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
                       <span class="o">.</span><span class="n">upsert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_upsert</span><span class="p">)</span>
                       <span class="o">.</span><span class="n">execute</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">return_id_list</span><span class="p">:</span>
                <span class="n">id_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_id_list</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">id_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">last_id</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">insert_with_loop</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_multi_row_insert</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_query</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_returning</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span>
            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">insert_many</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">insert_with_loop</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insert_with_loop</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_returning</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_with_result_wrapper</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_multi_row_insert</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">insert_returning</span><span class="p">:</span>
                    <span class="n">pk_row</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                    <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span>
                    <span class="n">clean_data</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">field</span><span class="o">.</span><span class="n">python_value</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">column</span>
                        <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">get_primary_key_fields</span><span class="p">(),</span> <span class="n">pk_row</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">composite_key</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">clean_data</span>
                    <span class="k">return</span> <span class="n">clean_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">last_insert_id</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_id_list</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

<span class="k">class</span> <span class="nc">DeleteQuery</span><span class="p">(</span><span class="n">_WriteQuery</span><span class="p">):</span>
    <span class="n">join</span> <span class="o">=</span> <span class="n">not_allowed</span><span class="p">(</span><span class="s1">&#39;joining&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">sql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="p">()</span><span class="o">.</span><span class="n">generate_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_returning</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_with_result_wrapper</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">rows_affected</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">())</span>


<span class="n">IndexMetadata</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s1">&#39;IndexMetadata&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;sql&#39;</span><span class="p">,</span> <span class="s1">&#39;columns&#39;</span><span class="p">,</span> <span class="s1">&#39;unique&#39;</span><span class="p">,</span> <span class="s1">&#39;table&#39;</span><span class="p">))</span>
<span class="n">ColumnMetadata</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s1">&#39;ColumnMetadata&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;data_type&#39;</span><span class="p">,</span> <span class="s1">&#39;null&#39;</span><span class="p">,</span> <span class="s1">&#39;primary_key&#39;</span><span class="p">,</span> <span class="s1">&#39;table&#39;</span><span class="p">))</span>
<span class="n">ForeignKeyMetadata</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s1">&#39;ForeignKeyMetadata&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;column&#39;</span><span class="p">,</span> <span class="s1">&#39;dest_table&#39;</span><span class="p">,</span> <span class="s1">&#39;dest_column&#39;</span><span class="p">,</span> <span class="s1">&#39;table&#39;</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">PeeweeException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">ImproperlyConfigured</span><span class="p">(</span><span class="n">PeeweeException</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">DatabaseError</span><span class="p">(</span><span class="n">PeeweeException</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">DataError</span><span class="p">(</span><span class="n">DatabaseError</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">IntegrityError</span><span class="p">(</span><span class="n">DatabaseError</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">InterfaceError</span><span class="p">(</span><span class="n">PeeweeException</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">InternalError</span><span class="p">(</span><span class="n">DatabaseError</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">NotSupportedError</span><span class="p">(</span><span class="n">DatabaseError</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">OperationalError</span><span class="p">(</span><span class="n">DatabaseError</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">ProgrammingError</span><span class="p">(</span><span class="n">DatabaseError</span><span class="p">):</span> <span class="k">pass</span>


<span class="k">class</span> <span class="nc">ExceptionWrapper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;exceptions&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exceptions</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exceptions</span> <span class="o">=</span> <span class="n">exceptions</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">exc_type</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exceptions</span><span class="p">:</span>
            <span class="n">new_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exceptions</span><span class="p">[</span><span class="n">exc_type</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">PY26</span><span class="p">:</span>
                <span class="n">exc_args</span> <span class="o">=</span> <span class="n">exc_value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">exc_args</span> <span class="o">=</span> <span class="n">exc_value</span><span class="o">.</span><span class="n">args</span>
            <span class="n">reraise</span><span class="p">(</span><span class="n">new_type</span><span class="p">,</span> <span class="n">new_type</span><span class="p">(</span><span class="o">*</span><span class="n">exc_args</span><span class="p">),</span> <span class="n">traceback</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">_BaseConnectionLocal</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_BaseConnectionLocal</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autocommit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context_stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transactions</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">class</span> <span class="nc">_ConnectionLocal</span><span class="p">(</span><span class="n">_BaseConnectionLocal</span><span class="p">,</span> <span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Database</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">commit_select</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">compiler_class</span> <span class="o">=</span> <span class="n">QueryCompiler</span>
    <span class="n">compound_operations</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;UNION&#39;</span><span class="p">,</span> <span class="s1">&#39;INTERSECT&#39;</span><span class="p">,</span> <span class="s1">&#39;EXCEPT&#39;</span><span class="p">,</span> <span class="s1">&#39;UNION ALL&#39;</span><span class="p">]</span>
    <span class="n">compound_select_parentheses</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">distinct_on</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">drop_cascade</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">field_overrides</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">foreign_keys</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">for_update</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">for_update_nowait</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">insert_many</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">insert_returning</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">interpolation</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span>
    <span class="n">limit_max</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">op_overrides</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">quote_char</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span>
    <span class="n">reserved_tables</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">returning_clause</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">savepoints</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">sequences</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">subquery_delete_same_table</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">upsert_sql</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">window_functions</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">exceptions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;ConstraintError&#39;</span><span class="p">:</span> <span class="n">IntegrityError</span><span class="p">,</span>
        <span class="s1">&#39;DatabaseError&#39;</span><span class="p">:</span> <span class="n">DatabaseError</span><span class="p">,</span>
        <span class="s1">&#39;DataError&#39;</span><span class="p">:</span> <span class="n">DataError</span><span class="p">,</span>
        <span class="s1">&#39;IntegrityError&#39;</span><span class="p">:</span> <span class="n">IntegrityError</span><span class="p">,</span>
        <span class="s1">&#39;InterfaceError&#39;</span><span class="p">:</span> <span class="n">InterfaceError</span><span class="p">,</span>
        <span class="s1">&#39;InternalError&#39;</span><span class="p">:</span> <span class="n">InternalError</span><span class="p">,</span>
        <span class="s1">&#39;NotSupportedError&#39;</span><span class="p">:</span> <span class="n">NotSupportedError</span><span class="p">,</span>
        <span class="s1">&#39;OperationalError&#39;</span><span class="p">:</span> <span class="n">OperationalError</span><span class="p">,</span>
        <span class="s1">&#39;ProgrammingError&#39;</span><span class="p">:</span> <span class="n">ProgrammingError</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">threadlocals</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autocommit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ops</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">autorollback</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_speedups</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">connect_kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">threadlocals</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_local</span> <span class="o">=</span> <span class="n">_ConnectionLocal</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_local</span> <span class="o">=</span> <span class="n">_BaseConnectionLocal</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="o">**</span><span class="n">connect_kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_conn_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autocommit</span> <span class="o">=</span> <span class="n">autocommit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autorollback</span> <span class="o">=</span> <span class="n">autorollback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_speedups</span> <span class="o">=</span> <span class="n">use_speedups</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">field_overrides</span> <span class="o">=</span> <span class="n">merge_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_overrides</span><span class="p">,</span> <span class="n">fields</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">op_overrides</span> <span class="o">=</span> <span class="n">merge_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">op_overrides</span><span class="p">,</span> <span class="n">ops</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exception_wrapper</span> <span class="o">=</span> <span class="n">ExceptionWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exceptions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="o">**</span><span class="n">connect_kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deferred</span> <span class="o">=</span> <span class="n">database</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">connect_kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deferred</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">OperationalError</span><span class="p">(</span><span class="s1">&#39;Database has not been initialized&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">OperationalError</span><span class="p">(</span><span class="s1">&#39;Connection already open&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_connection</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">exception_wrapper</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initialize_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">initialize_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deferred</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Error, database not properly initialized &#39;</span>
                                <span class="s1">&#39;before closing connection&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">exception_wrapper</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">get_conn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">context_stack</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">context_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">connection</span>
            <span class="k">if</span> <span class="n">conn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">conn</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">conn</span>

    <span class="k">def</span> <span class="nf">_create_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">exception_wrapper</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">connect_kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_closed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">closed</span>

    <span class="k">def</span> <span class="nf">get_cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_conn</span><span class="p">()</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">register_fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">field_overrides</span> <span class="o">=</span> <span class="n">merge_dict</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">field_overrides</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">register_ops</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ops</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">op_overrides</span> <span class="o">=</span> <span class="n">merge_dict</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">op_overrides</span><span class="p">,</span> <span class="n">ops</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_result_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrapper_type</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">wrapper_type</span> <span class="o">==</span> <span class="n">RESULTS_NAIVE</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">_ModelQueryResultWrapper</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_speedups</span>
                    <span class="k">else</span> <span class="n">NaiveQueryResultWrapper</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">wrapper_type</span> <span class="o">==</span> <span class="n">RESULTS_MODELS</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ModelQueryResultWrapper</span>
        <span class="k">elif</span> <span class="n">wrapper_type</span> <span class="o">==</span> <span class="n">RESULTS_TUPLES</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">_TuplesQueryResultWrapper</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_speedups</span>
                    <span class="k">else</span> <span class="n">TuplesQueryResultWrapper</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">wrapper_type</span> <span class="o">==</span> <span class="n">RESULTS_DICTS</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">_DictQueryResultWrapper</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_speedups</span>
                    <span class="k">else</span> <span class="n">DictQueryResultWrapper</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">wrapper_type</span> <span class="o">==</span> <span class="n">RESULTS_NAMEDTUPLES</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">NamedTupleQueryResultWrapper</span>
        <span class="k">elif</span> <span class="n">wrapper_type</span> <span class="o">==</span> <span class="n">RESULTS_AGGREGATE_MODELS</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AggregateQueryResultWrapper</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">_ModelQueryResultWrapper</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_speedups</span>
                    <span class="k">else</span> <span class="n">NaiveQueryResultWrapper</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">last_insert_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">auto_increment</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cursor</span><span class="o">.</span><span class="n">lastrowid</span>

    <span class="k">def</span> <span class="nf">rows_affected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span>

    <span class="k">def</span> <span class="nf">compiler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler_class</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quote_char</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_overrides</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">op_overrides</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clause</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="p">()</span><span class="o">.</span><span class="n">parse_node</span><span class="p">(</span><span class="n">clause</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">execute_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">require_commit</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">((</span><span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">exception_wrapper</span><span class="p">:</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cursor</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="ow">or</span> <span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autorollback</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_autocommit</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">require_commit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_autocommit</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">cursor</span>

    <span class="k">def</span> <span class="nf">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">exception_wrapper</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_conn</span><span class="p">()</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">exception_wrapper</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_conn</span><span class="p">()</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_autocommit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">autocommit</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">autocommit</span> <span class="o">=</span> <span class="n">autocommit</span>

    <span class="k">def</span> <span class="nf">get_autocommit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">autocommit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_autocommit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">autocommit</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">autocommit</span>

    <span class="k">def</span> <span class="nf">push_execution_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">context_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pop_execution_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">context_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">execution_context_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">context_stack</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execution_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_transaction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transaction_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ExecutionContext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_transaction</span><span class="p">,</span> <span class="n">transaction_type</span><span class="p">)</span>

    <span class="fm">__call__</span> <span class="o">=</span> <span class="n">execution_context</span>

    <span class="k">def</span> <span class="nf">push_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">transactions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pop_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">transactions</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">transaction_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">transactions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction_type</span><span class="p">)</span>
    <span class="n">commit_on_success</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">savepoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">savepoints</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">return</span> <span class="n">savepoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">atomic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_atomic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">get_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">get_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">get_primary_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">get_foreign_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">sequence_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seq</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">create_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">qc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="o">*</span><span class="n">qc</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">safe</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">create_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">create_model_tables</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">fail_silently</span><span class="o">=</span><span class="n">safe</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">qc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Fields passed to &quot;create_index&quot; must be a list &#39;</span>
                             <span class="s1">&#39;or tuple: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">fields</span><span class="p">)</span>
        <span class="n">fobjs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">basestring</span><span class="p">)</span> <span class="k">else</span> <span class="n">f</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="o">*</span><span class="n">qc</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">fobjs</span><span class="p">,</span> <span class="n">unique</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">drop_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">qc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Fields passed to &quot;drop_index&quot; must be a list &#39;</span>
                             <span class="s1">&#39;or tuple: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">fields</span><span class="p">)</span>
        <span class="n">fobjs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">basestring</span><span class="p">)</span> <span class="k">else</span> <span class="n">f</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="o">*</span><span class="n">qc</span><span class="o">.</span><span class="n">drop_index</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">fobjs</span><span class="p">,</span> <span class="n">safe</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">create_foreign_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">constraint</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">qc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="o">*</span><span class="n">qc</span><span class="o">.</span><span class="n">create_foreign_key</span><span class="p">(</span>
            <span class="n">model_class</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">constraint</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">create_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seq</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="p">:</span>
            <span class="n">qc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="o">*</span><span class="n">qc</span><span class="o">.</span><span class="n">create_sequence</span><span class="p">(</span><span class="n">seq</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">drop_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">fail_silently</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">qc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cascade</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_cascade</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Database does not support DROP TABLE..CASCADE.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="o">*</span><span class="n">qc</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span>
            <span class="n">model_class</span><span class="p">,</span> <span class="n">fail_silently</span><span class="p">,</span> <span class="n">cascade</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">drop_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">drop_model_tables</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">fail_silently</span><span class="o">=</span><span class="n">safe</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="n">cascade</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">truncate_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">restart_identity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">cascade</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">qc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="o">*</span><span class="n">qc</span><span class="o">.</span><span class="n">truncate_table</span><span class="p">(</span>
            <span class="n">model_class</span><span class="p">,</span> <span class="n">restart_identity</span><span class="p">,</span> <span class="n">cascade</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">truncate_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">restart_identity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">sort_models_topologically</span><span class="p">(</span><span class="n">models</span><span class="p">)):</span>
            <span class="n">model</span><span class="o">.</span><span class="n">truncate_table</span><span class="p">(</span><span class="n">restart_identity</span><span class="p">,</span> <span class="n">cascade</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">drop_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seq</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="p">:</span>
            <span class="n">qc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="o">*</span><span class="n">qc</span><span class="o">.</span><span class="n">drop_sequence</span><span class="p">(</span><span class="n">seq</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">extract_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_part</span><span class="p">,</span> <span class="n">date_field</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fn</span><span class="o">.</span><span class="n">EXTRACT</span><span class="p">(</span><span class="n">Clause</span><span class="p">(</span><span class="n">date_part</span><span class="p">,</span> <span class="n">R</span><span class="p">(</span><span class="s1">&#39;FROM&#39;</span><span class="p">),</span> <span class="n">date_field</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">truncate_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_part</span><span class="p">,</span> <span class="n">date_field</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fn</span><span class="o">.</span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="n">date_part</span><span class="p">,</span> <span class="n">date_field</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">default_insert_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;DEFAULT VALUES&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_noop_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;SELECT 0 WHERE 0&#39;</span>

    <span class="k">def</span> <span class="nf">get_binary_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">binary_construct</span>

<span class="k">def</span> <span class="nf">__pragma__</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pragma</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pragma</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">property</span><span class="p">(</span><span class="fm">__get__</span><span class="p">,</span> <span class="fm">__set__</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SqliteDatabase</span><span class="p">(</span><span class="n">Database</span><span class="p">):</span>
    <span class="n">compiler_class</span> <span class="o">=</span> <span class="n">SqliteQueryCompiler</span>
    <span class="n">field_overrides</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;bool&#39;</span><span class="p">:</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span>
        <span class="s1">&#39;smallint&#39;</span><span class="p">:</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span>
        <span class="s1">&#39;uuid&#39;</span><span class="p">:</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">foreign_keys</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">insert_many</span> <span class="o">=</span> <span class="n">sqlite3</span> <span class="ow">and</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">sqlite_version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">limit_max</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">op_overrides</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">OP</span><span class="o">.</span><span class="n">LIKE</span><span class="p">:</span> <span class="s1">&#39;GLOB&#39;</span><span class="p">,</span>
        <span class="n">OP</span><span class="o">.</span><span class="n">ILIKE</span><span class="p">:</span> <span class="s1">&#39;LIKE&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">upsert_sql</span> <span class="o">=</span> <span class="s1">&#39;INSERT OR REPLACE INTO&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">pragmas</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pragmas</span> <span class="o">=</span> <span class="n">pragmas</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">journal_mode</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;journal_mode&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># Backwards-compat.</span>
        <span class="k">if</span> <span class="n">journal_mode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pragmas</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;journal_mode&#39;</span><span class="p">,</span> <span class="n">journal_mode</span><span class="p">))</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">SqliteDatabase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sqlite3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s1">&#39;pysqlite or sqlite3 must be installed.&#39;</span><span class="p">)</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">isolation_level</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_conn_hooks</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">conn</span>

    <span class="k">def</span> <span class="nf">_add_conn_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_pragmas</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">create_function</span><span class="p">(</span><span class="s1">&#39;date_part&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">_sqlite_date_part</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">create_function</span><span class="p">(</span><span class="s1">&#39;date_trunc&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">_sqlite_date_trunc</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">create_function</span><span class="p">(</span><span class="s1">&#39;regexp&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">_sqlite_regexp</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_pragmas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pragmas</span><span class="p">:</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">pragma</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pragmas</span><span class="p">:</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;PRAGMA </span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pragma</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">pragma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">SENTINEL</span><span class="p">):</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;PRAGMA </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">SENTINEL</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s1">&#39; = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

    <span class="n">cache_size</span> <span class="o">=</span> <span class="n">__pragma__</span><span class="p">(</span><span class="s1">&#39;cache_size&#39;</span><span class="p">)</span>
    <span class="n">foreign_keys</span> <span class="o">=</span> <span class="n">__pragma__</span><span class="p">(</span><span class="s1">&#39;foreign_keys&#39;</span><span class="p">)</span>
    <span class="n">journal_mode</span> <span class="o">=</span> <span class="n">__pragma__</span><span class="p">(</span><span class="s1">&#39;journal_mode&#39;</span><span class="p">)</span>
    <span class="n">journal_size_limit</span> <span class="o">=</span> <span class="n">__pragma__</span><span class="p">(</span><span class="s1">&#39;journal_size_limit&#39;</span><span class="p">)</span>
    <span class="n">mmap_size</span> <span class="o">=</span> <span class="n">__pragma__</span><span class="p">(</span><span class="s1">&#39;mmap_size&#39;</span><span class="p">)</span>
    <span class="n">page_size</span> <span class="o">=</span> <span class="n">__pragma__</span><span class="p">(</span><span class="s1">&#39;page_size&#39;</span><span class="p">)</span>
    <span class="n">read_uncommitted</span> <span class="o">=</span> <span class="n">__pragma__</span><span class="p">(</span><span class="s1">&#39;read_uncommitted&#39;</span><span class="p">)</span>
    <span class="n">synchronous</span> <span class="o">=</span> <span class="n">__pragma__</span><span class="p">(</span><span class="s1">&#39;synchronous&#39;</span><span class="p">)</span>
    <span class="n">wal_autocheckpoint</span> <span class="o">=</span> <span class="n">__pragma__</span><span class="p">(</span><span class="s1">&#39;wal_autocheckpoint&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lock_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">statement</span> <span class="o">=</span> <span class="s1">&#39;BEGIN </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">lock_type</span> <span class="k">if</span> <span class="n">lock_type</span> <span class="k">else</span> <span class="s1">&#39;BEGIN&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="n">require_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">transaction_sqlite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_foreign_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">constraint</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">OperationalError</span><span class="p">(</span><span class="s1">&#39;SQLite does not support ALTER TABLE &#39;</span>
                               <span class="s1">&#39;statements to add constraints.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="s1">&#39;SELECT name FROM sqlite_master WHERE &#39;</span>
                                  <span class="s1">&#39;type = ? ORDER BY name;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">,))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">get_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;SELECT name, sql FROM sqlite_master &#39;</span>
                 <span class="s1">&#39;WHERE tbl_name = ? AND type = ? ORDER BY name&#39;</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">))</span>
        <span class="n">index_to_sql</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>

        <span class="c1"># Determine which indexes have a unique constraint.</span>
        <span class="n">unique_indexes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="s1">&#39;PRAGMA index_list(&quot;</span><span class="si">%s</span><span class="s1">&quot;)&#39;</span> <span class="o">%</span> <span class="n">table</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">is_unique</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">is_unique</span><span class="p">:</span>
                <span class="n">unique_indexes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Retrieve the indexed columns.</span>
        <span class="n">index_columns</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">index_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">index_to_sql</span><span class="p">):</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="s1">&#39;PRAGMA index_info(&quot;</span><span class="si">%s</span><span class="s1">&quot;)&#39;</span> <span class="o">%</span> <span class="n">index_name</span><span class="p">)</span>
            <span class="n">index_columns</span><span class="p">[</span><span class="n">index_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="n">IndexMetadata</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">index_to_sql</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
                <span class="n">index_columns</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
                <span class="n">name</span> <span class="ow">in</span> <span class="n">unique_indexes</span><span class="p">,</span>
                <span class="n">table</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">index_to_sql</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">get_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="s1">&#39;PRAGMA table_info(&quot;</span><span class="si">%s</span><span class="s1">&quot;)&#39;</span> <span class="o">%</span> <span class="n">table</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">ColumnMetadata</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="ow">not</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nb">bool</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span> <span class="n">table</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">get_primary_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="s1">&#39;PRAGMA table_info(&quot;</span><span class="si">%s</span><span class="s1">&quot;)&#39;</span> <span class="o">%</span> <span class="n">table</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">get_foreign_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="s1">&#39;PRAGMA foreign_key_list(&quot;</span><span class="si">%s</span><span class="s1">&quot;)&#39;</span> <span class="o">%</span> <span class="n">table</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">ForeignKeyMetadata</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">table</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">savepoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">savepoint_sqlite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">extract_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_part</span><span class="p">,</span> <span class="n">date_field</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fn</span><span class="o">.</span><span class="n">date_part</span><span class="p">(</span><span class="n">date_part</span><span class="p">,</span> <span class="n">date_field</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">truncate_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_part</span><span class="p">,</span> <span class="n">date_field</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fn</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">SQLITE_DATE_TRUNC_MAPPING</span><span class="p">[</span><span class="n">date_part</span><span class="p">],</span> <span class="n">date_field</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_binary_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Binary</span>

<span class="k">class</span> <span class="nc">PostgresqlDatabase</span><span class="p">(</span><span class="n">Database</span><span class="p">):</span>
    <span class="n">commit_select</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">compound_select_parentheses</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">distinct_on</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">drop_cascade</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">field_overrides</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;blob&#39;</span><span class="p">:</span> <span class="s1">&#39;BYTEA&#39;</span><span class="p">,</span>
        <span class="s1">&#39;bool&#39;</span><span class="p">:</span> <span class="s1">&#39;BOOLEAN&#39;</span><span class="p">,</span>
        <span class="s1">&#39;datetime&#39;</span><span class="p">:</span> <span class="s1">&#39;TIMESTAMP&#39;</span><span class="p">,</span>
        <span class="s1">&#39;decimal&#39;</span><span class="p">:</span> <span class="s1">&#39;NUMERIC&#39;</span><span class="p">,</span>
        <span class="s1">&#39;double&#39;</span><span class="p">:</span> <span class="s1">&#39;DOUBLE PRECISION&#39;</span><span class="p">,</span>
        <span class="s1">&#39;primary_key&#39;</span><span class="p">:</span> <span class="s1">&#39;SERIAL&#39;</span><span class="p">,</span>
        <span class="s1">&#39;uuid&#39;</span><span class="p">:</span> <span class="s1">&#39;UUID&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">for_update</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">for_update_nowait</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">insert_returning</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">interpolation</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span>
    <span class="n">op_overrides</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">OP</span><span class="o">.</span><span class="n">REGEXP</span><span class="p">:</span> <span class="s1">&#39;~&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">reserved_tables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span>
    <span class="n">returning_clause</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">sequences</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">window_functions</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">register_unicode</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">psycopg2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s1">&#39;psycopg2 must be installed.&#39;</span><span class="p">)</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">database</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register_unicode</span><span class="p">:</span>
            <span class="n">pg_extensions</span><span class="o">.</span><span class="n">register_type</span><span class="p">(</span><span class="n">pg_extensions</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
            <span class="n">pg_extensions</span><span class="o">.</span><span class="n">register_type</span><span class="p">(</span><span class="n">pg_extensions</span><span class="o">.</span><span class="n">UNICODEARRAY</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">encoding</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">set_client_encoding</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">conn</span>

    <span class="k">def</span> <span class="nf">_get_pk_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span>
        <span class="k">if</span> <span class="n">meta</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">meta</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">sequence</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">meta</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">sequence</span>
        <span class="k">elif</span> <span class="n">meta</span><span class="o">.</span><span class="n">auto_increment</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_seq&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">db_table</span><span class="p">,</span> <span class="n">meta</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">db_column</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">last_insert_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pk_sequence</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sequence</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">meta</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span>
        <span class="k">if</span> <span class="n">meta</span><span class="o">.</span><span class="n">schema</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">meta</span><span class="o">.</span><span class="n">schema</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT CURRVAL(&#39;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">sequence</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_autocommit</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">get_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="s1">&#39;public&#39;</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;SELECT tablename FROM pg_catalog.pg_tables &#39;</span>
                 <span class="s1">&#39;WHERE schemaname = </span><span class="si">%s</span><span class="s1"> ORDER BY tablename&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">schema</span><span class="p">,))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">get_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="s1">&#39;public&#39;</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT</span>
<span class="s2">                i.relname, idxs.indexdef, idx.indisunique,</span>
<span class="s2">                array_to_string(array_agg(cols.attname), &#39;,&#39;)</span>
<span class="s2">            FROM pg_catalog.pg_class AS t</span>
<span class="s2">            INNER JOIN pg_catalog.pg_index AS idx ON t.oid = idx.indrelid</span>
<span class="s2">            INNER JOIN pg_catalog.pg_class AS i ON idx.indexrelid = i.oid</span>
<span class="s2">            INNER JOIN pg_catalog.pg_indexes AS idxs ON</span>
<span class="s2">                (idxs.tablename = t.relname AND idxs.indexname = i.relname)</span>
<span class="s2">            LEFT OUTER JOIN pg_catalog.pg_attribute AS cols ON</span>
<span class="s2">                (cols.attrelid = t.oid AND cols.attnum = ANY(idx.indkey))</span>
<span class="s2">            WHERE t.relname = </span><span class="si">%s</span><span class="s2"> AND t.relkind = </span><span class="si">%s</span><span class="s2"> AND idxs.schemaname = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">            GROUP BY i.relname, idxs.indexdef, idx.indisunique</span>
<span class="s2">            ORDER BY idx.indisunique DESC, i.relname;&quot;&quot;&quot;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">schema</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">IndexMetadata</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">),</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">table</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">get_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="s1">&#39;public&#39;</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT column_name, is_nullable, data_type</span>
<span class="s2">            FROM information_schema.columns</span>
<span class="s2">            WHERE table_name = </span><span class="si">%s</span><span class="s2"> AND table_schema = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">            ORDER BY ordinal_position&quot;&quot;&quot;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="p">))</span>
        <span class="n">pks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_primary_keys</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">ColumnMetadata</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">null</span> <span class="o">==</span> <span class="s1">&#39;YES&#39;</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">pks</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">null</span><span class="p">,</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">get_primary_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="s1">&#39;public&#39;</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT kc.column_name</span>
<span class="s2">            FROM information_schema.table_constraints AS tc</span>
<span class="s2">            INNER JOIN information_schema.key_column_usage AS kc ON (</span>
<span class="s2">                tc.table_name = kc.table_name AND</span>
<span class="s2">                tc.table_schema = kc.table_schema AND</span>
<span class="s2">                tc.constraint_name = kc.constraint_name)</span>
<span class="s2">            WHERE</span>
<span class="s2">                tc.constraint_type = </span><span class="si">%s</span><span class="s2"> AND</span>
<span class="s2">                tc.table_name = </span><span class="si">%s</span><span class="s2"> AND</span>
<span class="s2">                tc.table_schema = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;PRIMARY KEY&#39;</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">row</span> <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">get_foreign_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="s1">&#39;public&#39;</span><span class="p">):</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT</span>
<span class="s2">                kcu.column_name, ccu.table_name, ccu.column_name</span>
<span class="s2">            FROM information_schema.table_constraints AS tc</span>
<span class="s2">            JOIN information_schema.key_column_usage AS kcu</span>
<span class="s2">                ON (tc.constraint_name = kcu.constraint_name AND</span>
<span class="s2">                    tc.constraint_schema = kcu.constraint_schema)</span>
<span class="s2">            JOIN information_schema.constraint_column_usage AS ccu</span>
<span class="s2">                ON (ccu.constraint_name = tc.constraint_name AND</span>
<span class="s2">                    ccu.constraint_schema = tc.constraint_schema)</span>
<span class="s2">            WHERE</span>
<span class="s2">                tc.constraint_type = &#39;FOREIGN KEY&#39; AND</span>
<span class="s2">                tc.table_name = </span><span class="si">%s</span><span class="s2"> AND</span>
<span class="s2">                tc.table_schema = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">ForeignKeyMetadata</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">table</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">sequence_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT COUNT(*) FROM pg_class, pg_namespace</span>
<span class="s2">            WHERE relkind=&#39;S&#39;</span>
<span class="s2">                AND pg_class.relnamespace = pg_namespace.oid</span>
<span class="s2">                AND relname=</span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">sequence</span><span class="p">,))</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">set_search_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">search_path</span><span class="p">):</span>
        <span class="n">path_params</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">search_path</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="s1">&#39;SET search_path TO </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">path_params</span><span class="p">,</span> <span class="n">search_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_noop_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;SELECT 0 WHERE false&#39;</span>

    <span class="k">def</span> <span class="nf">get_binary_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">Binary</span>

<span class="k">class</span> <span class="nc">MySQLDatabase</span><span class="p">(</span><span class="n">Database</span><span class="p">):</span>
    <span class="n">commit_select</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">compound_select_parentheses</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">compound_operations</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;UNION&#39;</span><span class="p">,</span> <span class="s1">&#39;UNION ALL&#39;</span><span class="p">]</span>
    <span class="n">field_overrides</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;bool&#39;</span><span class="p">:</span> <span class="s1">&#39;BOOL&#39;</span><span class="p">,</span>
        <span class="s1">&#39;decimal&#39;</span><span class="p">:</span> <span class="s1">&#39;NUMERIC&#39;</span><span class="p">,</span>
        <span class="s1">&#39;double&#39;</span><span class="p">:</span> <span class="s1">&#39;DOUBLE PRECISION&#39;</span><span class="p">,</span>
        <span class="s1">&#39;float&#39;</span><span class="p">:</span> <span class="s1">&#39;FLOAT&#39;</span><span class="p">,</span>
        <span class="s1">&#39;primary_key&#39;</span><span class="p">:</span> <span class="s1">&#39;INTEGER AUTO_INCREMENT&#39;</span><span class="p">,</span>
        <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;LONGTEXT&#39;</span><span class="p">,</span>
        <span class="s1">&#39;uuid&#39;</span><span class="p">:</span> <span class="s1">&#39;VARCHAR(40)&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">for_update</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">interpolation</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span>
    <span class="n">limit_max</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">64</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># MySQL quirk</span>
    <span class="n">op_overrides</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">OP</span><span class="o">.</span><span class="n">LIKE</span><span class="p">:</span> <span class="s1">&#39;LIKE BINARY&#39;</span><span class="p">,</span>
        <span class="n">OP</span><span class="o">.</span><span class="n">ILIKE</span><span class="p">:</span> <span class="s1">&#39;LIKE&#39;</span><span class="p">,</span>
        <span class="n">OP</span><span class="o">.</span><span class="n">XOR</span><span class="p">:</span> <span class="s1">&#39;XOR&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">quote_char</span> <span class="o">=</span> <span class="s1">&#39;`&#39;</span>
    <span class="n">subquery_delete_same_table</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">upsert_sql</span> <span class="o">=</span> <span class="s1">&#39;REPLACE INTO&#39;</span>

    <span class="k">def</span> <span class="nf">_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mysql</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s1">&#39;MySQLdb or PyMySQL must be installed.&#39;</span><span class="p">)</span>
        <span class="n">conn_kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;charset&#39;</span><span class="p">:</span> <span class="s1">&#39;utf8&#39;</span><span class="p">,</span>
            <span class="s1">&#39;use_unicode&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">conn_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;password&#39;</span> <span class="ow">in</span> <span class="n">conn_kwargs</span><span class="p">:</span>
            <span class="n">conn_kwargs</span><span class="p">[</span><span class="s1">&#39;passwd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">conn_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="n">database</span><span class="p">,</span> <span class="o">**</span><span class="n">conn_kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">row</span> <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="s1">&#39;SHOW TABLES&#39;</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">get_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="s1">&#39;SHOW INDEX FROM `</span><span class="si">%s</span><span class="s1">`&#39;</span> <span class="o">%</span> <span class="n">table</span><span class="p">)</span>
        <span class="n">unique</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">unique</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">indexes</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">[])</span>
            <span class="n">indexes</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">IndexMetadata</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">indexes</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">unique</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT column_name, is_nullable, data_type</span>
<span class="s2">            FROM information_schema.columns</span>
<span class="s2">            WHERE table_name = </span><span class="si">%s</span><span class="s2"> AND table_schema = DATABASE()&quot;&quot;&quot;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="p">(</span><span class="n">table</span><span class="p">,))</span>
        <span class="n">pks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_primary_keys</span><span class="p">(</span><span class="n">table</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">ColumnMetadata</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">null</span> <span class="o">==</span> <span class="s1">&#39;YES&#39;</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">pks</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">null</span><span class="p">,</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">get_primary_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="s1">&#39;SHOW INDEX FROM `</span><span class="si">%s</span><span class="s1">`&#39;</span> <span class="o">%</span> <span class="n">table</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_foreign_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT column_name, referenced_table_name, referenced_column_name</span>
<span class="s2">            FROM information_schema.key_column_usage</span>
<span class="s2">            WHERE table_name = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                AND table_schema = DATABASE()</span>
<span class="s2">                AND referenced_table_name IS NOT NULL</span>
<span class="s2">                AND referenced_column_name IS NOT NULL&quot;&quot;&quot;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">table</span><span class="p">,))</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">ForeignKeyMetadata</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">dest_table</span><span class="p">,</span> <span class="n">dest_column</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">dest_table</span><span class="p">,</span> <span class="n">dest_column</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">extract_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_part</span><span class="p">,</span> <span class="n">date_field</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fn</span><span class="o">.</span><span class="n">EXTRACT</span><span class="p">(</span><span class="n">Clause</span><span class="p">(</span><span class="n">R</span><span class="p">(</span><span class="n">date_part</span><span class="p">),</span> <span class="n">R</span><span class="p">(</span><span class="s1">&#39;FROM&#39;</span><span class="p">),</span> <span class="n">date_field</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">truncate_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_part</span><span class="p">,</span> <span class="n">date_field</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fn</span><span class="o">.</span><span class="n">DATE_FORMAT</span><span class="p">(</span><span class="n">date_field</span><span class="p">,</span> <span class="n">MYSQL_DATE_TRUNC_MAPPING</span><span class="p">[</span><span class="n">date_part</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">default_insert_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Clause</span><span class="p">(</span>
            <span class="n">EnclosedClause</span><span class="p">(</span><span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span><span class="p">),</span>
            <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;VALUES (DEFAULT)&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_noop_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;DO 0&#39;</span>

    <span class="k">def</span> <span class="nf">get_binary_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">mysql</span><span class="o">.</span><span class="n">Binary</span>


<span class="k">class</span> <span class="nc">_callable_context_manager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inner</span>

<span class="k">class</span> <span class="nc">ExecutionContext</span><span class="p">(</span><span class="n">_callable_context_manager</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">with_transaction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transaction_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">with_transaction</span> <span class="o">=</span> <span class="n">with_transaction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transaction_type</span> <span class="o">=</span> <span class="n">transaction_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">_conn_lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">push_execution_context</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">_connect</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">connect_kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_transaction</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">txn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">txn</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">_conn_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">pop_execution_context</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_transaction</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">exc_type</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">txn</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">txn</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">pop_execution_context</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">_close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Using</span><span class="p">(</span><span class="n">ExecutionContext</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">with_transaction</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Using</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">with_transaction</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">models</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_orig</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_orig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Using</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Using</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">):</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">_atomic</span><span class="p">(</span><span class="n">_callable_context_manager</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="s1">&#39;transaction_type&#39;</span><span class="p">,</span> <span class="s1">&#39;context_manager&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">transaction_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transaction_type</span> <span class="o">=</span> <span class="n">transaction_type</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">transaction_depth</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context_manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">transaction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction_type</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context_manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">savepoint</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_manager</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_manager</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">transaction</span><span class="p">(</span><span class="n">_callable_context_manager</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="s1">&#39;autocommit&#39;</span><span class="p">,</span> <span class="s1">&#39;transaction_type&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">transaction_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transaction_type</span> <span class="o">=</span> <span class="n">transaction_type</span>

    <span class="k">def</span> <span class="nf">_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction_type</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction_type</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">begin</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">begin</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_begin</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">begin</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">begin</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_begin</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autocommit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_autocommit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">set_autocommit</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">transaction_depth</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_begin</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">push_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exc_type</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">transaction_depth</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">set_autocommit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">autocommit</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">pop_transaction</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">savepoint</span><span class="p">(</span><span class="n">_callable_context_manager</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="s1">&#39;sid&#39;</span><span class="p">,</span> <span class="s1">&#39;quoted_sid&#39;</span><span class="p">,</span> <span class="s1">&#39;autocommit&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">sid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="n">_compiler</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">compiler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid</span> <span class="o">=</span> <span class="n">sid</span> <span class="ow">or</span> <span class="s1">&#39;s&#39;</span> <span class="o">+</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quoted_sid</span> <span class="o">=</span> <span class="n">_compiler</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">require_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">(</span><span class="s1">&#39;SAVEPOINT </span><span class="si">%s</span><span class="s1">;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">quoted_sid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">begin</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">(</span><span class="s1">&#39;RELEASE SAVEPOINT </span><span class="si">%s</span><span class="s1">;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">quoted_sid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">begin</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_begin</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">(</span><span class="s1">&#39;ROLLBACK TO SAVEPOINT </span><span class="si">%s</span><span class="s1">;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">quoted_sid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autocommit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_autocommit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">set_autocommit</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_begin</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exc_type</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">begin</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                    <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">set_autocommit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">autocommit</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">transaction_sqlite</span><span class="p">(</span><span class="n">transaction</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="k">def</span> <span class="nf">_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="n">lock_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction_type</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">savepoint_sqlite</span><span class="p">(</span><span class="n">savepoint</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;isolation_level&#39;</span><span class="p">,)</span>
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_conn</span><span class="p">()</span>
        <span class="c1"># For sqlite, the connection&#39;s isolation_level *must* be set to None.</span>
        <span class="c1"># The act of setting it, though, will break any existing savepoints,</span>
        <span class="c1"># so only write to it if necessary.</span>
        <span class="k">if</span> <span class="n">conn</span><span class="o">.</span><span class="n">isolation_level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isolation_level</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">isolation_level</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">isolation_level</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isolation_level</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">savepoint_sqlite</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">savepoint_sqlite</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span>
                <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isolation_level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_conn</span><span class="p">()</span><span class="o">.</span><span class="n">isolation_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isolation_level</span>

<span class="k">class</span> <span class="nc">FieldProxy</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">field_instance</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_alias</span> <span class="o">=</span> <span class="n">alias</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_alias</span><span class="o">.</span><span class="n">model_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_instance</span> <span class="o">=</span> <span class="n">field_instance</span>

    <span class="k">def</span> <span class="nf">clone_base</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">FieldProxy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_alias</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_instance</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">coerce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_instance</span><span class="o">.</span><span class="n">coerce</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">python_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_instance</span><span class="o">.</span><span class="n">python_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">db_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_instance</span><span class="o">.</span><span class="n">db_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;model_class&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_alias</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_instance</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ModelAlias</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;model_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_class</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="n">model_attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_attr</span><span class="p">,</span> <span class="n">Field</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">FieldProxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_attr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model_attr</span>

    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Cannot set attributes on ModelAlias instances&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_proxy_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">declared_fields</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">mm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">declared_fields</span> <span class="k">if</span> <span class="n">declared_fields</span> <span class="k">else</span> <span class="n">mm</span><span class="o">.</span><span class="n">sorted_fields</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">FieldProxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">selection</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">selection</span><span class="p">:</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_proxy_fields</span><span class="p">()</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">SelectQuery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">selection</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">order_by</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">order_by</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">query</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="k">if</span> <span class="n">_SortedFieldList</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">_SortedFieldList</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;_keys&#39;</span><span class="p">,</span> <span class="s1">&#39;_items&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_items</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">_sort_key</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">bisect_left</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">bisect_right</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">_sort_key</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">_sort_key</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">bisect_left</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">DoesNotExist</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span>

<span class="k">if</span> <span class="n">sqlite3</span><span class="p">:</span>
    <span class="n">default_database</span> <span class="o">=</span> <span class="n">SqliteDatabase</span><span class="p">(</span><span class="s1">&#39;peewee.db&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">default_database</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">class</span> <span class="nc">ModelOptions</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">db_table</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">db_table_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">indexes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">table_alias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">validate_backrefs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">only_save_dirty</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">depends_on</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span> <span class="o">=</span> <span class="bp">cls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_by_name</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_callables</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_callable_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sorted_field_list</span> <span class="o">=</span> <span class="n">_SortedFieldList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sorted_fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sorted_field_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declared_fields</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span> <span class="k">if</span> <span class="n">database</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">default_database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_table</span> <span class="o">=</span> <span class="n">db_table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_table_func</span> <span class="o">=</span> <span class="n">db_table_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">indexes</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span> <span class="o">=</span> <span class="n">order_by</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="o">=</span> <span class="n">primary_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_alias</span> <span class="o">=</span> <span class="n">table_alias</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="n">constraints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_backrefs</span> <span class="o">=</span> <span class="n">validate_backrefs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">only_save_dirty</span> <span class="o">=</span> <span class="n">only_save_dirty</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depends_on</span> <span class="o">=</span> <span class="n">depends_on</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">auto_increment</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composite_key</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rel</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reverse_rel</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_additional_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_table_func</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_table</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_table_func</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">prepared</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span><span class="p">:</span>
            <span class="n">norm_order_by</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Field</span><span class="p">):</span>
                    <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">_ordering</span> <span class="o">==</span> <span class="s1">&#39;DESC&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span>
                <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">):</span>
                    <span class="n">norm_order_by</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">norm_order_by</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">asc</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span> <span class="o">=</span> <span class="n">norm_order_by</span>

    <span class="k">def</span> <span class="nf">_update_field_lists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sorted_fields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sorted_field_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sorted_field_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sorted_fields</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_fields</span> <span class="o">=</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">|</span>
                             <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">|</span>
                             <span class="nb">set</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">,)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declared_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sorted_fields</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">undeclared</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">add_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_field</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">db_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sorted_field_list</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_field_lists</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">default</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">default</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_default_callables</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">default</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_default_callable_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">default</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_default_dict</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">default</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_default_by_name</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">default</span>

    <span class="k">def</span> <span class="nf">remove_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">original</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">original</span><span class="o">.</span><span class="n">db_column</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sorted_field_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_field_lists</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">original</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="n">original</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_callables</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_default_callable_list</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">field_name</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_default_callable_list</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_default_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_default_by_name</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">original</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_default_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_by_name</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">default</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_callable_list</span><span class="p">:</span>
            <span class="n">dd</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">default</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">dd</span>

    <span class="k">def</span> <span class="nf">get_field_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sorted_field_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">def</span> <span class="nf">get_primary_key_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_key</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">field_names</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">rel_for_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">field_obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">multi</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">is_field</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_obj</span><span class="p">,</span> <span class="n">Field</span><span class="p">)</span>
        <span class="n">is_node</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">is_field</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_obj</span><span class="p">,</span> <span class="n">Node</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">multi</span><span class="p">:</span>
            <span class="n">accum</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sorted_fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">ForeignKeyField</span><span class="p">)</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">rel_model</span> <span class="o">==</span> <span class="n">model</span><span class="p">:</span>
                <span class="n">is_match</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">field_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="n">is_field</span> <span class="ow">and</span> <span class="n">field_obj</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="n">is_node</span> <span class="ow">and</span> <span class="n">field_obj</span><span class="o">.</span><span class="n">_alias</span> <span class="o">==</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">is_match</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">multi</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">field</span>
                    <span class="n">accum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">multi</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">accum</span>

    <span class="k">def</span> <span class="nf">reverse_rel_for_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">field_obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">multi</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">rel_for_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="p">,</span> <span class="n">field_obj</span><span class="p">,</span> <span class="n">multi</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rel_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_for_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse_rel_for_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">related_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backrefs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fk</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fk</span><span class="o">.</span><span class="n">rel_model</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">backrefs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">fk</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">reverse_rel</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fk</span><span class="o">.</span><span class="n">model_class</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">models</span>


<span class="k">class</span> <span class="nc">BaseModel</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="n">inheritable</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span>
        <span class="s1">&#39;constraints&#39;</span><span class="p">,</span> <span class="s1">&#39;database&#39;</span><span class="p">,</span> <span class="s1">&#39;db_table_func&#39;</span><span class="p">,</span> <span class="s1">&#39;indexes&#39;</span><span class="p">,</span> <span class="s1">&#39;order_by&#39;</span><span class="p">,</span>
        <span class="s1">&#39;primary_key&#39;</span><span class="p">,</span> <span class="s1">&#39;schema&#39;</span><span class="p">,</span> <span class="s1">&#39;validate_backrefs&#39;</span><span class="p">,</span> <span class="s1">&#39;only_save_dirty&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">_METACLASS_</span> <span class="ow">or</span> <span class="n">bases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="n">_METACLASS_</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

        <span class="n">meta_options</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;Meta&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">meta</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span>
                    <span class="n">meta_options</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="n">model_pk</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="s1">&#39;primary_key&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">parent_pk</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># inherit any field descriptors by deep copying the underlying field</span>
        <span class="c1"># into the attrs of the new model, additionally see if the bases define</span>
        <span class="c1"># inheritable model options and swipe them</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;_meta&#39;</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">base_meta</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;_meta&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parent_pk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">parent_pk</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">base_meta</span><span class="o">.</span><span class="n">primary_key</span><span class="p">)</span>
            <span class="n">all_inheritable</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">inheritable</span> <span class="o">|</span> <span class="n">base_meta</span><span class="o">.</span><span class="n">_additional_keys</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">base_meta</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">all_inheritable</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">meta_options</span><span class="p">:</span>
                    <span class="n">meta_options</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">FieldDescriptor</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">primary_key</span><span class="p">:</span>
                        <span class="n">attrs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">field</span><span class="p">)</span>

        <span class="c1"># initialize the new class and set the magic attributes</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
        <span class="n">ModelOptionsBase</span> <span class="o">=</span> <span class="n">meta_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_options_base&#39;</span><span class="p">,</span> <span class="n">ModelOptions</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span> <span class="o">=</span> <span class="n">ModelOptionsBase</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">meta_options</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">indexes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">indexes</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[^\w]+&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

        <span class="c1"># replace fields with field descriptors, calling the add_to_class hook</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">Field</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">and</span> <span class="n">model_pk</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;primary key is overdetermined.&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">attr</span><span class="o">.</span><span class="n">primary_key</span><span class="p">:</span>
                    <span class="n">model_pk</span><span class="p">,</span> <span class="n">pk_name</span> <span class="o">=</span> <span class="n">attr</span><span class="p">,</span> <span class="n">name</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">attr</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

        <span class="n">composite_key</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">model_pk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parent_pk</span><span class="p">:</span>
                <span class="n">model_pk</span><span class="p">,</span> <span class="n">pk_name</span> <span class="o">=</span> <span class="n">parent_pk</span><span class="p">,</span> <span class="n">parent_pk</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">model_pk</span><span class="p">,</span> <span class="n">pk_name</span> <span class="o">=</span> <span class="n">PrimaryKeyField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="s1">&#39;id&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_pk</span><span class="p">,</span> <span class="n">CompositeKey</span><span class="p">):</span>
            <span class="n">pk_name</span> <span class="o">=</span> <span class="s1">&#39;_composite_key&#39;</span>
            <span class="n">composite_key</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">model_pk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">model_pk</span><span class="o">.</span><span class="n">add_to_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pk_name</span><span class="p">)</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span> <span class="o">=</span> <span class="n">model_pk</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">auto_increment</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_pk</span><span class="p">,</span> <span class="n">PrimaryKeyField</span><span class="p">)</span> <span class="ow">or</span>
                <span class="nb">bool</span><span class="p">(</span><span class="n">model_pk</span><span class="o">.</span><span class="n">sequence</span><span class="p">))</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">composite_key</span> <span class="o">=</span> <span class="n">composite_key</span>

        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">field</span><span class="o">.</span><span class="n">add_to_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="c1"># create a repr and error class before finalizing</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;__unicode__&#39;</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;__repr__&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%r</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__unicode__</span><span class="p">()))</span>

        <span class="n">exc_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">DoesNotExist&#39;</span> <span class="o">%</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">exc_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;__module__&#39;</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span><span class="p">}</span>
        <span class="n">exception_class</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">exc_name</span><span class="p">,</span> <span class="p">(</span><span class="n">DoesNotExist</span><span class="p">,),</span> <span class="n">exc_attrs</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">DoesNotExist</span> <span class="o">=</span> <span class="n">exception_class</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">prepared</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;validate_model&#39;</span><span class="p">):</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">validate_model</span><span class="p">()</span>

        <span class="n">DeferredRelation</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">())</span>

<span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">with_metaclass</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">)):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_default_dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_obj_cache</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">alias</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ModelAlias</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">selection</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">SelectQuery</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">selection</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">order_by</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="o">*</span><span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">order_by</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">query</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">__data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">update</span><span class="p">):</span>
        <span class="n">fdict</span> <span class="o">=</span> <span class="n">__data</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">fdict</span><span class="o">.</span><span class="n">update</span><span class="p">([(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">f</span><span class="p">],</span> <span class="n">update</span><span class="p">[</span><span class="n">f</span><span class="p">])</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">update</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">UpdateQuery</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fdict</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">__data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">insert</span><span class="p">):</span>
        <span class="n">fdict</span> <span class="o">=</span> <span class="n">__data</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">fdict</span><span class="o">.</span><span class="n">update</span><span class="p">([(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">f</span><span class="p">],</span> <span class="n">insert</span><span class="p">[</span><span class="n">f</span><span class="p">])</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">insert</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">InsertQuery</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fdict</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">insert_many</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">validate_fields</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">InsertQuery</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="n">rows</span><span class="p">,</span> <span class="n">validate_fields</span><span class="o">=</span><span class="n">validate_fields</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">insert_from</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">InsertQuery</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DeleteQuery</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">raw</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">RawQuery</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">query</span><span class="p">):</span>
        <span class="n">inst</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">query</span><span class="p">)</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">force_insert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">_prepare_instance</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">inst</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">sq</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">naive</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
            <span class="n">sq</span> <span class="o">=</span> <span class="n">sq</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">*</span><span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">sq</span> <span class="o">=</span> <span class="n">sq</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sq</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_or_create</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;defaults&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;__&#39;</span> <span class="ow">in</span> <span class="n">field</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">field</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="bp">cls</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                              <span class="k">if</span> <span class="s1">&#39;__&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">k</span><span class="p">)</span>
                <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">defaults</span><span class="p">)</span>
                <span class="k">with</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                    <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">),</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="n">IntegrityError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="kc">False</span>
                <span class="k">except</span> <span class="bp">cls</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exc</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">dq</span><span class="p">,</span> <span class="o">**</span><span class="n">query</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">*</span><span class="n">dq</span><span class="p">,</span> <span class="o">**</span><span class="n">query</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">table_exists</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">schema</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;schema&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">schema</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_tables</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_table</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fail_silently</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fail_silently</span> <span class="ow">and</span> <span class="bp">cls</span><span class="o">.</span><span class="n">table_exists</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="n">db</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span>
        <span class="n">pk</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span>
        <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">sequences</span> <span class="ow">and</span> <span class="n">pk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">pk</span><span class="o">.</span><span class="n">sequence</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="o">.</span><span class="n">sequence_exists</span><span class="p">(</span><span class="n">pk</span><span class="o">.</span><span class="n">sequence</span><span class="p">):</span>
                <span class="n">db</span><span class="o">.</span><span class="n">create_sequence</span><span class="p">(</span><span class="n">pk</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_create_indexes</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_fields_to_index</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">sorted_fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">primary_key</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">requires_index</span> <span class="o">=</span> <span class="nb">any</span><span class="p">((</span>
                <span class="n">field</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">field</span><span class="o">.</span><span class="n">unique</span><span class="p">,</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">ForeignKeyField</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">requires_index</span><span class="p">:</span>
                <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fields</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_index_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span>
            <span class="p">[((</span><span class="n">field</span><span class="p">,),</span> <span class="n">field</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_fields_to_index</span><span class="p">()],</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">indexes</span> <span class="ow">or</span> <span class="p">())</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_create_indexes</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">field_list</span><span class="p">,</span> <span class="n">is_unique</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_index_data</span><span class="p">():</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">field_list</span><span class="p">,</span> <span class="n">is_unique</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_drop_indexes</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">field_list</span><span class="p">,</span> <span class="n">is_unique</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_index_data</span><span class="p">():</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">drop_index</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">field_list</span><span class="p">,</span> <span class="n">safe</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">sqlall</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">queries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">compiler</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">compiler</span><span class="p">()</span>
        <span class="n">pk</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">sequences</span> <span class="ow">and</span> <span class="n">pk</span><span class="o">.</span><span class="n">sequence</span><span class="p">:</span>
            <span class="n">queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compiler</span><span class="o">.</span><span class="n">create_sequence</span><span class="p">(</span><span class="n">pk</span><span class="o">.</span><span class="n">sequence</span><span class="p">))</span>
        <span class="n">queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compiler</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="bp">cls</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_fields_to_index</span><span class="p">():</span>
            <span class="n">queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compiler</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="n">field</span><span class="o">.</span><span class="n">unique</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">indexes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field_names</span><span class="p">,</span> <span class="n">unique</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">indexes</span><span class="p">:</span>
                <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">]</span>
                <span class="n">queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compiler</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">unique</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">sql</span> <span class="k">for</span> <span class="n">sql</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">drop_table</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fail_silently</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fail_silently</span><span class="p">,</span> <span class="n">cascade</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">truncate_table</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">restart_identity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">truncate_table</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">restart_identity</span><span class="p">,</span> <span class="n">cascade</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">as_entity</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">schema</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Entity</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Entity</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">noop</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">NoopSelectQuery</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_pk_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">get_id</span> <span class="o">=</span> <span class="n">_get_pk_value</span>  <span class="c1"># Backwards-compatibility.</span>

    <span class="k">def</span> <span class="nf">_set_pk_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">composite_key</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">set_id</span> <span class="o">=</span> <span class="n">_set_pk_value</span>  <span class="c1"># Backwards-compatibility.</span>

    <span class="k">def</span> <span class="nf">_pk_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pk_value</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_prepare_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepared</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">prepared</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_prune_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_dict</span><span class="p">,</span> <span class="n">only</span><span class="p">):</span>
        <span class="n">new_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">only</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">field_dict</span><span class="p">:</span>
                <span class="n">new_data</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_dict</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">new_data</span>

    <span class="k">def</span> <span class="nf">_populate_unsaved_relations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">rel</span><span class="p">:</span>
            <span class="n">conditions</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="ow">and</span>
                <span class="n">key</span> <span class="ow">in</span> <span class="n">field_dict</span> <span class="ow">and</span>
                <span class="n">field_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_obj_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">conditions</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
                <span class="n">field_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_insert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">only</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">field_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">pk_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span>
            <span class="n">pk_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pk_value</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pk_field</span> <span class="o">=</span> <span class="n">pk_value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">only</span><span class="p">:</span>
            <span class="n">field_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prune_fields</span><span class="p">(</span><span class="n">field_dict</span><span class="p">,</span> <span class="n">only</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">only_save_dirty</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_insert</span><span class="p">:</span>
            <span class="n">field_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prune_fields</span><span class="p">(</span>
                <span class="n">field_dict</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dirty_fields</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">field_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_populate_unsaved_relations</span><span class="p">(</span><span class="n">field_dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pk_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_insert</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">composite_key</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pk_part_name</span> <span class="ow">in</span> <span class="n">pk_field</span><span class="o">.</span><span class="n">field_names</span><span class="p">:</span>
                    <span class="n">field_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">pk_part_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">field_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">pk_field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">field_dict</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pk_expr</span><span class="p">())</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">pk_field</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">**</span><span class="n">field_dict</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pk_from_cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">**</span><span class="n">field_dict</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">pk_from_cursor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pk_value</span> <span class="o">=</span> <span class="n">pk_from_cursor</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_pk_value</span><span class="p">(</span><span class="n">pk_value</span><span class="p">)</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">rows</span>

    <span class="k">def</span> <span class="nf">is_dirty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dirty_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">sorted_fields</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">search_nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">model_class</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pk_expr</span><span class="p">())</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">query</span><span class="p">)]</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
            <span class="n">klass</span><span class="p">,</span> <span class="n">query</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">klass</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">rel_name</span><span class="p">,</span> <span class="n">fk</span> <span class="ow">in</span> <span class="n">klass</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">reverse_rel</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">rel_model</span> <span class="o">=</span> <span class="n">fk</span><span class="o">.</span><span class="n">model_class</span>
                <span class="k">if</span> <span class="n">fk</span><span class="o">.</span><span class="n">rel_model</span> <span class="ow">is</span> <span class="n">model_class</span><span class="p">:</span>
                    <span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="n">fk</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">fk</span><span class="o">.</span><span class="n">to_field</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
                    <span class="n">subquery</span> <span class="o">=</span> <span class="n">rel_model</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">node</span> <span class="o">=</span> <span class="n">fk</span> <span class="o">&lt;&lt;</span> <span class="n">query</span>
                    <span class="n">subquery</span> <span class="o">=</span> <span class="n">rel_model</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fk</span><span class="o">.</span><span class="n">null</span> <span class="ow">or</span> <span class="n">search_nullable</span><span class="p">:</span>
                    <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">rel_model</span><span class="p">,</span> <span class="n">subquery</span><span class="p">))</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">fk</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">delete_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">delete_nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
            <span class="n">dependencies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">(</span><span class="n">delete_nullable</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">query</span><span class="p">,</span> <span class="n">fk</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dependencies</span><span class="p">)):</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">fk</span><span class="o">.</span><span class="n">model_class</span>
                <span class="k">if</span> <span class="n">fk</span><span class="o">.</span><span class="n">null</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">delete_nullable</span><span class="p">:</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">fk</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pk_expr</span><span class="p">())</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pk_value</span><span class="p">()))</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">other</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_pk_value</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
            <span class="n">other</span><span class="o">.</span><span class="n">_get_pk_value</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pk_value</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span> <span class="o">==</span> <span class="n">other</span>

<span class="k">def</span> <span class="nf">prefetch_add_subquery</span><span class="p">(</span><span class="n">sq</span><span class="p">,</span> <span class="n">subqueries</span><span class="p">):</span>
    <span class="n">fixed_queries</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrefetchResult</span><span class="p">(</span><span class="n">sq</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">subquery</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subqueries</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subquery</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">subquery</span><span class="p">,</span> <span class="n">target_model</span> <span class="o">=</span> <span class="n">subquery</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subquery</span><span class="p">,</span> <span class="n">Query</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">subquery</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
            <span class="n">subquery</span> <span class="o">=</span> <span class="n">subquery</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
        <span class="n">subquery_model</span> <span class="o">=</span> <span class="n">subquery</span><span class="o">.</span><span class="n">model_class</span>
        <span class="n">fks</span> <span class="o">=</span> <span class="n">backrefs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="n">prefetch_result</span> <span class="o">=</span> <span class="n">fixed_queries</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">last_query</span> <span class="o">=</span> <span class="n">prefetch_result</span><span class="o">.</span><span class="n">query</span>
            <span class="n">last_model</span> <span class="o">=</span> <span class="n">prefetch_result</span><span class="o">.</span><span class="n">model</span>
            <span class="n">rels</span> <span class="o">=</span> <span class="n">subquery_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">rel_for_model</span><span class="p">(</span><span class="n">last_model</span><span class="p">,</span> <span class="n">multi</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rels</span><span class="p">:</span>
                <span class="n">fks</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">subquery_model</span><span class="p">,</span> <span class="n">fk</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">fk</span> <span class="ow">in</span> <span class="n">rels</span><span class="p">]</span>
                <span class="n">pks</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">last_model</span><span class="p">,</span> <span class="n">fk</span><span class="o">.</span><span class="n">to_field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">fk</span> <span class="ow">in</span> <span class="n">rels</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">backrefs</span> <span class="o">=</span> <span class="n">last_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">rel_for_model</span><span class="p">(</span>
                    <span class="n">subquery_model</span><span class="p">,</span>
                    <span class="n">multi</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">fks</span> <span class="ow">or</span> <span class="n">backrefs</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">target_model</span> <span class="ow">is</span> <span class="n">last_model</span><span class="p">)</span> <span class="ow">or</span>
                                      <span class="p">(</span><span class="n">target_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)):</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">fks</span> <span class="ow">or</span> <span class="n">backrefs</span><span class="p">):</span>
            <span class="n">tgt_err</span> <span class="o">=</span> <span class="s1">&#39; using </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">target_model</span> <span class="k">if</span> <span class="n">target_model</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Error: unable to find foreign key for &#39;</span>
                                 <span class="s1">&#39;query: </span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">subquery</span><span class="p">,</span> <span class="n">tgt_err</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">fks</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">or_</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">fk</span> <span class="o">&lt;&lt;</span> <span class="n">last_query</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pk</span><span class="p">))</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">fk</span><span class="p">,</span> <span class="n">pk</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fks</span><span class="p">,</span> <span class="n">pks</span><span class="p">)])</span>
            <span class="n">subquery</span> <span class="o">=</span> <span class="n">subquery</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
            <span class="n">fixed_queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PrefetchResult</span><span class="p">(</span><span class="n">subquery</span><span class="p">,</span> <span class="n">fks</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">backrefs</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">or_</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">backref</span><span class="o">.</span><span class="n">to_field</span> <span class="o">&lt;&lt;</span> <span class="n">last_query</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">backref</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">backref</span> <span class="ow">in</span> <span class="n">backrefs</span><span class="p">])</span>
            <span class="n">subquery</span> <span class="o">=</span> <span class="n">subquery</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
            <span class="n">fixed_queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PrefetchResult</span><span class="p">(</span><span class="n">subquery</span><span class="p">,</span> <span class="n">backrefs</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">fixed_queries</span>

<span class="n">__prefetched</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;__prefetched&#39;</span><span class="p">,</span> <span class="p">(</span>
    <span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="s1">&#39;fields&#39;</span><span class="p">,</span> <span class="s1">&#39;backref&#39;</span><span class="p">,</span> <span class="s1">&#39;rel_models&#39;</span><span class="p">,</span> <span class="s1">&#39;field_to_name&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">PrefetchResult</span><span class="p">(</span><span class="n">__prefetched</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rel_models</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">field_to_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">backref</span><span class="p">:</span>
                <span class="n">rel_models</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">model_class</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">]</span>
                <span class="n">foreign_key_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">to_field</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rel_models</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">rel_model</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">]</span>
                <span class="n">foreign_key_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">]</span>
            <span class="n">field_to_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">foreign_key_attrs</span><span class="p">))</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">model_class</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">PrefetchResult</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">backref</span><span class="p">,</span> <span class="n">rel_models</span><span class="p">,</span> <span class="n">field_to_name</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">populate_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">id_map</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backref</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                <span class="n">identifier</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">id_map</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">id_map</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">attname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_to_name</span><span class="p">:</span>
                <span class="n">identifier</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">to_field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
                <span class="n">rel_instances</span> <span class="o">=</span> <span class="n">id_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">dest</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_prefetch&#39;</span> <span class="o">%</span> <span class="n">field</span><span class="o">.</span><span class="n">related_name</span>
                <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">rel_instances</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">attname</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">rel_instances</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">store_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">id_map</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">attname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_to_name</span><span class="p">:</span>
            <span class="n">identity</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">to_field</span><span class="o">.</span><span class="n">python_value</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">attname</span><span class="p">])</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">identity</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backref</span><span class="p">:</span>
                <span class="n">id_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">id_map</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">id_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">prefetch</span><span class="p">(</span><span class="n">sq</span><span class="p">,</span> <span class="o">*</span><span class="n">subqueries</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">subqueries</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sq</span>
    <span class="n">fixed_queries</span> <span class="o">=</span> <span class="n">prefetch_add_subquery</span><span class="p">(</span><span class="n">sq</span><span class="p">,</span> <span class="n">subqueries</span><span class="p">)</span>

    <span class="n">deps</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">rel_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">prefetch_result</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">fixed_queries</span><span class="p">):</span>
        <span class="n">query_model</span> <span class="o">=</span> <span class="n">prefetch_result</span><span class="o">.</span><span class="n">model</span>
        <span class="k">if</span> <span class="n">prefetch_result</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rel_model</span> <span class="ow">in</span> <span class="n">prefetch_result</span><span class="o">.</span><span class="n">rel_models</span><span class="p">:</span>
                <span class="n">rel_map</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">rel_model</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">rel_map</span><span class="p">[</span><span class="n">rel_model</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prefetch_result</span><span class="p">)</span>

        <span class="n">deps</span><span class="p">[</span><span class="n">query_model</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">id_map</span> <span class="o">=</span> <span class="n">deps</span><span class="p">[</span><span class="n">query_model</span><span class="p">]</span>
        <span class="n">has_relations</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">rel_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">query_model</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">prefetch_result</span><span class="o">.</span><span class="n">query</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">prefetch_result</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                <span class="n">prefetch_result</span><span class="o">.</span><span class="n">store_instance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">id_map</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">has_relations</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">rel</span> <span class="ow">in</span> <span class="n">rel_map</span><span class="p">[</span><span class="n">query_model</span><span class="p">]:</span>
                    <span class="n">rel</span><span class="o">.</span><span class="n">populate_instance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">deps</span><span class="p">[</span><span class="n">rel</span><span class="o">.</span><span class="n">model</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">prefetch_result</span><span class="o">.</span><span class="n">query</span>

<span class="k">def</span> <span class="nf">create_model_tables</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="o">**</span><span class="n">create_table_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create tables for all given models (in the right order).&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">sort_models_topologically</span><span class="p">(</span><span class="n">models</span><span class="p">):</span>
        <span class="n">m</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="o">**</span><span class="n">create_table_kwargs</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">drop_model_tables</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="o">**</span><span class="n">drop_table_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Drop tables for all given models (in the right order).&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">sort_models_topologically</span><span class="p">(</span><span class="n">models</span><span class="p">)):</span>
        <span class="n">m</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="o">**</span><span class="n">drop_table_kwargs</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Floral Cabanettes.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>